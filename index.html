<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta property="og:title" content="九巴轉乘車費計算機 KMB BBI Calculator" />
    <meta property="og:description" content="Web app to calculate bus interchange routes and fares on Hong Kong Kowloon Motor Bus routes."/>
    <meta property="og:image" content="https://play-lh.googleusercontent.com/M8q3UWGb7LhaCViShhXX9BZus7BSdVMEJfNFDdnpwWL7a4XCYPp7V_we4eXg9Yb5do0=w240-h480-rw" />
    <meta property="og:image:alt" content="KMB App 1933 Icon" />
    <link rel="icon" type="image/x-icon" href="./icon.png">

    <link rel="apple-touch-icon" sizes="57x57" href="./apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="./apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="./apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="./apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="./apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="./android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="./favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
    <link rel="manifest" href="./manifest.json">
    <meta name="msapplication-TileColor" content="#E41F31">
    <meta name="msapplication-TileImage" content="./ms-icon-144x144.png">
    <meta name="theme-color" content="#E41F31">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="#E41F31">
    <meta name="apple-mobile-web-app-title" content="九巴轉乘車費計算機 KMB BBI Calculator">

    <title id="title">九巴轉乘車費計算機 HK KMB BBI Calculator</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK:wght@300;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./Control.FullScreen.css" />
    <script src="./Control.FullScreen.js"></script>
    <script src="./L.TileLayer.NoGap.js"></script>
    <link rel="stylesheet" href="./bus_route_keyboard.css" />
    <script src="./bus_route_keyboard.js"></script>
    <script src="./bouncemarker.js"></script>
</head>

<body>
    <style>
        * {
            font-family: 'Noto Sans HK', sans-serif;
        }

        @font-face {
            font-family: 'Material Symbols Outlined';
            font-style: normal;
            font-weight: 400;
            font-display: block;
            src: url(https://fonts.gstatic.com/s/materialsymbolsoutlined/v132/kJEhBvYX7BgnkSrUwT8OhrdQw4oELdPIeeII9v6oFsI.woff2) format('woff2');
        }
        .material-icons {
            font-family: 'Material Symbols Outlined';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
        body:has(.requires-no-scroll) {
            position: fixed;
        }
        .loading {
            z-index: 999999;
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgba(0,0,0,.5);
        }
        .loading-wheel {
            width: 20px;
            height: 20px;
            margin-top: -40px;
            margin-left: -40px;
            
            position: absolute;
            top: 50%;
            left: 50%;
            
            border-width: 30px;
            border-radius: 50%;
            -webkit-animation: spin 1s linear infinite;
        }
        .style-2 .loading-wheel {
            border-style: double;
            border-color: #ccc transparent;
        }
        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0);
            }
            100% {
                -webkit-transform: rotate(-360deg);
            }
        }
        .unselectable {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .table {
            margin-left: auto;
            margin-right: auto;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 240px;
            background-color: #555;
            color: #fff;
            text-align: center;
            padding: 5px 0;
            border-radius: 6px;

            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -120px;

            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .tab-disabled {
            pointer-events: none;
            cursor: default;
            color: #C1C1C1;
        }
        .desk {
        }
        .div-only-mobile {
        }
        .div-mobile-max-width {
        }
        .map {
            height: 75vh;
        }
        @media screen and (max-width : 1920px) {
            .div-only-mobile {
                display: none;
            }
            .leaflet-popup-content p {
                font-size: 17px;
            }
            .bottom-mobile-div {
                width: initial;
            }
        }
        @media screen and (max-width : 906px) {
            .desk {
                display: none;
            }
            .div-only-mobile {
                display: inline-block;
            }
            .div-mobile-max-width {
                width: 100%;
            }
            .map {
                height: 80vh;
            }
            .leaflet-popup-content {
                overflow: hidden;
            }
            .leaflet-popup-content p {
                margin: 0 0;
            }
            .leaflet-popup-content a.leaflet-popup-close-button {
                display: none;
            }
            .mobile-map-action-disable {
                max-height: 25vh !important;
            }
            .leaflet-popup-content p {
                font-size: 15px;
            }
            .bottom-mobile-div {
                width: 100%;
            }
        }
        .leaflet-control-layers {
            text-align: left;
        }
        .mobile-navbar {
            background-color: #333;
            overflow: hidden;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 9999;
            display: flex;
            justify-content: center;
        }
        .mobile-navbar a {
            display: block;
            color: #f2f2f2;
            text-align: center;
            padding: 14px 5px;
            text-decoration: none;
            font-size: 11px;
            flex-grow: 1;
        }
        .mobile-navbar a.active {
            background-color: #E41F31;
            color: white;
        }
        a.anchor {
            display: block;
            position: relative;
            top: -30px;
            visibility: hidden;
        }
        tr.nearby-stop:hover th {
            color: #777;
        }
        .disable-scrollbars::-webkit-scrollbar {
            background: transparent;
            width: 0px;
        }
        .disable-scrollbars {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .special-annoucement-href:hover {
            color: #FF7575 !important;
        }
        .bbi-map-href {
            color: #C11E2F !important;
        }
        .bbi-map-href:hover {
            color: #FF001D !important;
        }
        .data-source {
            color: #111770 !important;
        }
        .data-source a:hover {
            color: #222ED8 !important;
        }
        .map-mobile-popup p {
            margin-bottom: 10px;
            font-size: 17px;
        }
        .remove-button-style {
            background-color: #FAC7C3 !important;
        }
        .remove-button-style:hover:not([disabled]) {
            background-color: #F9BAB6 !important;
        }
        .clear-button-style {
            background-color: #AD0E0E !important;
        }
        .clear-button-style:hover:not([disabled]) {
            background-color: #C41111 !important;
        }
        @keyframes route-input-animation-up {
            0% {
                transform: translateY(0%);
            }
            50% {
                transform: translateY(calc(-100% - 24px));
            }
            100% {
                transform: translateY(calc(-100% - 24px));
            }
        }
        .route-input-animation-up {
            animation: route-input-animation-up 0.6s ease-in-out;
        }
        @keyframes route-input-animation-down {
            0% {
                transform: translateY(0%);
            }
            50% {
                transform: translateY(calc(100% + 24px));
            }
            100% {
                transform: translateY(calc(100% + 24px));
            }
        }
        .route-input-animation-down {
            animation: route-input-animation-down 0.6s ease-in-out;
        }
        @keyframes route-input-animation-add {
            0% {
                transform: translateY(calc(-100% - 24px));
            }
            50% {
                transform: translateY(0%);
            }
            100% {
                transform: translateY(0%);
            }
        }
        .route-input-animation-add {
            animation: route-input-animation-add 0.6s ease-in-out;
        }
    </style>

    <section id="main-section" class="hero is-danger is-fullheight">
        <nav class="navbar">
            <div class="container">
                <div class="navbar-brand">
                    <a class="navbar-item" href="https://loohpjames.com">
                        <img src="https://loohpjames.com/assets/images/profile_rounded.png" width="28" height="28" alt="LoohpJames">
                    </a>
                    <a class="navbar-item" href=".">
                        <img src="./icon.png" width="28" height="28" alt="KMB">
                    </a>
                    <a class="navbar-item" href="https://www.kmb.hk/">
                        <img src="https://www.kmb.hk/images/inc/kmb_r.png" width="28" height="28" alt="KMB">
                    </a>
                    <a class="navbar-item" href="https://www.citybus.com.hk/home/">
                        <img src="https://play-lh.googleusercontent.com/u3hHcPNSafdfkHXAVwA4lbfUKocFWRRc4efDVvppp0jfVYkBC6Mx7KpcdLsyQCQCuwE=w240-h480-rw" width="28" height="28" alt="KMB">
                    </a>
                    <a class="navbar-item" href="https://www.nlb.com.hk/">
                        <img src="https://play-lh.googleusercontent.com/FLaOFmHJyxqgSee4oRHbD3np6gJ-3qo2DUqMX-6sotexOvPYEGxuqzSqreE82dpr-tSi=w240-h480-rw" width="28" height="28" alt="KMB">
                    </a>
                    <a id="burger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" onclick="toggleBurger()">
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                    </a>
                </div>
                <div id="navbarMenuHeroA" class="navbar-menu">
                    <div class="navbar-end">
                        <a href="./?language=en" class="navbar-item" id="language">English</a>
                        <a href="https://github.com/LOOHP/HK-KMB-Calculator" target="_blank" class="navbar-item">GitHub</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="hero-body" style="padding: 0px;">
            <div class="container has-text-centered" style="width: 100%;">
               <div class="column is-12" style="padding: min(12px, 1%);">
                    <h3 class="title" id="title-label">九巴轉乘車費計算機</h3>
                    <h3 class="title" style="font-size: 15px;" id="subtitle-label">包含城巴/新大嶼山巴士/港鐵巴士/專線小巴路線部分轉乘數據</h3>
                    <div class="box has-background-white-ter" style="width: 100%; padding: min(20px, 2%);">
                        <a class="anchor" id="anchor-route-input"></a>
                        <div id="route-input"></div><br>
                        <div class="box">
                            <button class="button is-success" id="route-add" title="新增路線" disabled><i class="material-icons" style="color: darkgreen;">add</i></button>
                            <button class="button clear-button-style" id="route-clear" title="清除所有路線"><i class="material-icons" style="color: pink;">delete</i></button>
                            <br><br>
                            <button class="button is-info" id="toggle-eta" title="顯示/隱藏預計到達時間"><i class="material-icons">departure_board</i></button>
                            <button class="button is-info" id="toggle-timetable" title="顯示/隱藏時間表"><i class="material-icons">date_range</i></button>
                            <button class="button is-info" id="toggle-map" title="顯示/隱藏地圖"><i class="material-icons">map</i></button>
                            <button class="button is-link" id="share-link" title="獲取分享鏈結"><i class="material-icons">link</i></button>
                        </div>
                        <a class="anchor" id="anchor-fare-table-mobile"></a>
                        <div style="overflow: auto; width: 100%;" class="desk">
                            <table class="table" id="fare-table" style="word-break: keep-all; display: none;">
                                <tbody>
                                    <tr>
                                        <th id="route-label">路線</th>
                                        <th style="text-align: left;" id="board-label">建議上車巴士站</th>
                                        <th style="text-align: left;" id="alight-label">建議落車巴士站</th>
                                        <th style="text-align: left;" id="discount-label">優惠</th>
                                        <th style="text-align: left;" id="interchange-label">最高連續轉乘</th>
                                        <th style="text-align: left;" id="timelimit-label">時限</th>
                                        <th style="text-align: left;" id="note-label">備註</th>
                                        <th style="text-align: right;" id="fare-label">車費</th>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div style="overflow: auto; width: 100%; display: none;" class="div-only-mobile" id="fare-table-mobile"></div>
                        <br>
                        <table class="table" id="fare-final-table">
                            <tbody>
                                <tr>
                                    <th id="total-fare-label" style="font-size: 20px;">合計車費</th>
                                    <th style="text-align: right; font-size: 20px;" id="total-fare">$0.0 (半價 $0.0)</th>
                                </tr>
                            </tbody>
                        </table>
                        <a class="anchor" id="anchor-eta-table"></a>
                        <div class="box" id="eta-table" style="display: none;"></div>
                        <a class="anchor" id="anchor-time-table"></a>
                        <div class="box" id="time-table" style="display: none;"></div>
                        <a class="anchor" id="anchor-special-announcements"></a>
                        <div class="box has-background-grey-lighter" id="special-announcements" style="display: none; color: red; font-weight: bold;"></div>
                        <a class="anchor" id="anchor-map"></a>
                        <div class="map" id="map" style="color: black; position: relative; border-radius: 10px;">
                            <div id="map-clock-container" class="leaflet-top leaflet-left" style="z-index: 799; left: 42px; display: none;">
                                <div class="leaflet-control-layers leaflet-control">
                                    <p style="color: black; padding: 1px 3px 1px 3px; text-align: left; vertical-align: middle;" id="map-clock"></p>
                                </div>
                            </div>
                            <div id="map-mobile-popup-container" style="display: none; max-height: 35%;">
                                <div id="map-mobile-popup-leaflet-div" class="div-only-mobile" style="width: 100%; position: absolute; bottom: 0; left: 0; padding: 15px; z-index: 1100;">
                                    <div class="leaflet-control-layers leaflet-control" style="width: 100%; text-align: center;">
                                        <div class="box map-mobile-popup" id="map-mobile-popup"></div>
                                    </div>
                                    <a id="map-mobile-popup-close" class="leaflet-popup-close-button" role="button" aria-label="Close popup" href="#close" style="z-index: 901; top: 17px; right: 17px; pointer-events: auto;">
                                        <span aria-hidden="true">×</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <br>
                        <a class="anchor" id="anchor-nearby-routes"></a>
                        <div class="box has-background-grey-lighter" id="nearby-routes" style="font-weight: bold; position: relative;">
                            <h5 class="title is-5" style="color: black;" id="nearby-routes-label">鄰近路線</h5>
                            <p id="nearby-routes-prompt">點擊地圖以放置位置圖釘或打開定位位置</p>
                            <div id="nearby-routes-content" style="display: none; max-height: min(600px, 80vh); overflow: auto;"></div>
                            <button class="button is-dark" id="toggle-gps" title="打開/關閉定位位置" style="position: absolute; top: 10px; right: 63px;" disabled><i class="material-icons">gps_fixed</i></button>
                            <button class="button is-danger remove-button-style" id="pin-remove" title="清除位置圖釘" onClick="pinRemove();" style="position: absolute; top: 10px; right: 10px;" disabled><i class="material-icons" style="color: red;">wrong_location</i></button>
                        </div>
                        <h5 class="title is-5 data-source" style="font-size: 15px;"><span id="data-label">數據來源</span>: <a href="https://data.gov.hk" target="_blank">data.gov.hk</a>, <a href="https://kmb.hk" target="_blank">kmb.hk</a>, <a href="https://www.citybus.com.hk/" target="_blank">citybus.com.hk</a>, <a href="https://www.nlb.com.hk/" target="_blank">nlb.com.hk</a>, <a href="https://www.mtr.com.hk/" target="_blank">mtr.com.hk</a>, <a href="https://github.com/hkbus/hk-bus-crawling" target="_blank">HK Bus Crawling@2021</a></h5>
                    </div>
                </div>
            </div>
        </div>
        <div class="bottom-mobile-div" id="bottom-mobile-div" style="position: fixed; bottom: 0px; z-index: 2000;">
            <div class="div-only-mobile" style="vertical-align: top;">
                <div class="mobile-navbar unselectable " id="mobile-bottom">
                    <a id="nav-anchor-route-input" onclick="jumpToAnchor('#anchor-route-input');" class="mobile-dav-item active" disabled>路線輸入</a>
                    <a id="nav-anchor-fare-table-mobile" onclick="jumpToAnchor('#anchor-fare-table-mobile');" class="mobile-dav-item">轉乘數據</a>
                    <a id="nav-anchor-eta-table" onclick="jumpToAnchor('#anchor-eta-table');" class="mobile-dav-item">預計到達</a>
                    <a id="nav-anchor-time-table" onclick="jumpToAnchor('#anchor-time-table');" class="mobile-dav-item">時間表</a>
                    <a id="nav-anchor-special-announcements" onclick="jumpToAnchor('#anchor-special-announcements');" class="mobile-dav-item">特別公告</a>
                    <a id="nav-anchor-map" onclick="jumpToAnchor('#anchor-map');" class="mobile-dav-item">地圖</a>
                    <a id="nav-anchor-nearby-routes" onclick="jumpToAnchor('#anchor-nearby-routes');" class="mobile-dav-item">鄰近路線</a>
                </div>
                <div id="mobile-bottom-padding"></div>
            </div>
        </div>
    </section>
    <div class="loading style-2" id="loading-overlay"><div class="loading-wheel"></div></div>
</body>

<script>
    const printConnectionError = (str) => console.log(str);

    const jumpToAnchor = (selectedAnchor, behavior = 'smooth') => {
        document.querySelector(selectedAnchor).scrollIntoView({behavior: behavior});
    };

    const getPercentageInView = (element) => {
        let bounding = element.getBoundingClientRect();
        let viewportHeight = window.innerHeight || document.documentElement.clientHeight;
        let viewportWidth = window.innerWidth || document.documentElement.clientWidth;

        let heightInView = Math.min(bounding.bottom, viewportHeight) - Math.max(bounding.top, 0);
        let percentageHeightInView = (heightInView / bounding.height) * 100;

        let widthInView = Math.min(bounding.right, viewportWidth) - Math.max(bounding.left, 0);
        let percentageWidthInView = (widthInView / bounding.width) * 100;

        return Math.min(percentageHeightInView, percentageWidthInView);
    };

    const weekdayNames = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

    const getUrlParameter = (sParam) => {
        let sPageURL = window.location.search.substring(1);
        let sURLVariables = sPageURL.split('&');
        let sParameterName;
        for (let i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
            }
        }
        return null;
    };

    let language = getUrlParameter("language");
    if (language == null) {
        language = "zh"
    }

    setInterval(() => {
        if (getComputedStyle(document.getElementById("eta-table")).display != "none") {
            document.querySelectorAll('.eta-table-stop-title').forEach(element => {
                let targetWidth = element.parentElement.parentElement.parentElement.parentElement.parentElement.offsetWidth - 76.52;
                element.style.fontSize = "26px";
                let fontSize = 26;
                let counter = 0;
                while (targetWidth < element.offsetWidth && counter++ < 1000) {
                    let newFontSize = fontSize - 1;
                    element.style.fontSize = newFontSize + "px";
                    fontSize = newFontSize;
                }
            });
        }

        let collection = document.getElementsByClassName("mobile-dav-item");
        let flag = false;
        let mainElement = null;
        let largestPercentage = -1;
        for (let i = 0; i < collection.length; i++) {
            let element = collection[i];
            let anchor = document.getElementById(element.id.substring(element.id.lastIndexOf("nav-anchor-") + "nav-anchor-".length));
            if (getComputedStyle(anchor).display == "none") {
                element.style.display = "none";
            } else {
                element.style.display = "";
            }
            let percentage = getPercentageInView(anchor);
            if (percentage > largestPercentage) {
                mainElement = element;
                largestPercentage = percentage;
            }
        }
        for (let i = 0; i < collection.length; i++) {
            let element = collection[i];
            if (mainElement == element) {
                element.classList.add("active");
            } else {
                element.classList.remove("active");
            }
        }
        document.getElementById("mobile-bottom-padding").style.paddingBottom = document.getElementById("mobile-bottom").offsetHeight + "px";
    }, 100);
    document.querySelectorAll(".mobile-dav-item").forEach(element => {
        element.addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault();
        });
    });

    const getJSON = (url, callback, retry = true) => {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.responseType = 'json';
        xhr.overrideMimeType("application/json");
        xhr.onload = () => {
            let status = xhr.status;
            if (status === 200) {
                callback(null, xhr.response);
            } else {
                if (retry) {
                    setTimeout(() => getJSON(url, callback, false), 1000);
                } else {
                    callback(status, xhr.response);
                }
            }
        };
        xhr.send();
    };

    const postJSON = (url, body, callback, retry = true) => {
        let xhr = new XMLHttpRequest();
        xhr.open('POST', url, true);
        xhr.responseType = 'json';
        xhr.overrideMimeType("application/json");
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = () => {
            let status = xhr.status;
            if (status === 200) {
                callback(null, xhr.response);
            } else {
                if (retry) {
                    setTimeout(() => postJSON(url, body, callback, false), 1000);
                } else {
                    callback(status, xhr.response);
                }
            }
        };
        xhr.send(JSON.stringify(body));
    };

    if (language == "en") {
        document.getElementById('language').href = "./?language=zh";

        document.getElementById('language').innerHTML = "中文";
        document.getElementById('title-label').innerHTML = "HK KMB Bus Interchange (BBI) Fare Calculator";
        document.getElementById('subtitle-label').innerHTML = "Contains CityBus / New Lantao Bus / MTR Bus / GMB routes partial interchange data";

        document.getElementById('route-add').title = "Add New Route";
        document.getElementById('route-clear').title = "Clear All Routes";
        document.getElementById('toggle-eta').title = "Show/Hide ETA";
        document.getElementById('toggle-timetable').title = "Show/Hide Timetable";
        document.getElementById('toggle-map').title = "Show/Hide Interactive Map";
        document.getElementById('share-link').title = "Get Share Link";

        document.getElementById('route-label').innerHTML = "Route";
        document.getElementById('board-label').innerHTML = "Suggested Boarding Stop";
        document.getElementById('alight-label').innerHTML = "Suggested Alighting Stop";
        document.getElementById('discount-label').innerHTML = "Discount";
        document.getElementById('interchange-label').innerHTML = "Max. Successive Discount";
        document.getElementById('timelimit-label').innerHTML = "Time Limit";
        document.getElementById('note-label').innerHTML = "Remarks";
        document.getElementById('fare-label').innerHTML = "Fare";

        document.getElementById('total-fare-label').innerHTML = "Total Fare";
        document.getElementById('total-fare').innerHTML = "$0.0 (Half Fare $0.0)";
        document.getElementById('data-label').innerHTML = "Data Sources";

        document.getElementById('nearby-routes-label').innerHTML = "Nearby Routes";
        document.getElementById('nearby-routes-prompt').innerHTML = "Click on map to drop location pin or turn on GPS";

        document.getElementById('nav-anchor-route-input').innerHTML = "Route Input";
        document.getElementById('nav-anchor-fare-table-mobile').innerHTML = "Route Info";
        document.getElementById('nav-anchor-eta-table').innerHTML = "ETA";
        document.getElementById('nav-anchor-time-table').innerHTML = "Time-tables";
        document.getElementById('nav-anchor-special-announcements').innerHTML = "Special Ann.";
        document.getElementById('nav-anchor-map').innerHTML = "Route Map";
        document.getElementById('nav-anchor-nearby-routes').innerHTML = "Nearby Routes";

        document.getElementById('toggle-gps').title = "Enable/Disable GPS";
        document.getElementById('pin-remove').title = "Clear Dropped Pin";
    }

    let lines = new L.FeatureGroup();
    let markers = new L.FeatureGroup();
    let gps = new L.FeatureGroup();
    let pin = new L.FeatureGroup();
    let nearbyLines = new L.FeatureGroup();
    let nearbyStopsMarker = new L.FeatureGroup();

    let activeRouteMarker = new L.FeatureGroup();

    let googleAttribution = '<a href="https://www.google.com/intl/en_uk/help/terms_maps/">Map data &copy;' + new Date().getUTCFullYear() + ' Google</a>';

    let googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
        maxZoom: 22,
        subdomains:['mt0','mt1','mt2','mt3'],
        attribution: googleAttribution
    });

    let googleStreetsTraffic = L.tileLayer('http://{s}.google.com/vt/lyrs=m@221097413,traffic&x={x}&y={y}&z={z}',{
        maxZoom: 22,
        subdomains:['mt0','mt1','mt2','mt3'],
        attribution: googleAttribution
    });

    let googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
        maxZoom: 22,
        subdomains:['mt0','mt1','mt2','mt3'],
        attribution: googleAttribution
    });

    let googleHybridTraffic = L.tileLayer('http://{s}.google.com/vt/lyrs=s@221097413,traffic,h&x={x}&y={y}&z={z}',{
        maxZoom: 22,
        subdomains:['mt0','mt1','mt2','mt3'],
        attribution: googleAttribution
    });

    let googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
        maxZoom: 22,
        subdomains:['mt0','mt1','mt2','mt3'],
        attribution: googleAttribution
    });

    let googleTerrain = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
        maxZoom: 22,
        subdomains:['mt0','mt1','mt2','mt3'],
        attribution: googleAttribution
    });

    let openStreet = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    let map = L.map('map', {
        layers: [googleStreets, lines, markers, nearbyStopsMarker],
        fullscreenControl: true,
        fullscreenControlOptions: {
            position: 'topleft'
        },
        zoomSnap: 0.1,
    }).setView([22.3622764, 114.1508789], 11);

    let layerControl = L.control.layers({}, {}).addTo(map);

    map.addLayer(gps);
    map.addLayer(pin);

    let googleStreetsName = language == "en" ? "Streets" : "街道";
    let googleStreetsTrafficName = language == "en" ? "Streets (Traffic)" : "街道(路況)";
    let openStreetName = language == "en" ? "Streets (OpenStreetMap)" : "街道(OpenStreetMap)";
    let googleHybridName = language == "en" ? "Satellite Streets" : "衛星(街道)";
    let googleHybridTrafficName = language == "en" ? "Satellite Traffic" : "衛星(路況)";
    let googleSatName = language == "en" ? "Satellite" : "衛星";
    let googleTerrainName = language == "en" ? "Terrain Streets" : "地形(街道)";

    layerControl.addBaseLayer(googleStreets, googleStreetsName);
    layerControl.addBaseLayer(openStreet, openStreetName);
    layerControl.addBaseLayer(googleStreetsTraffic, googleStreetsTrafficName);
    layerControl.addBaseLayer(googleHybrid, googleHybridName);
    layerControl.addBaseLayer(googleHybridTraffic, googleHybridTrafficName);
    layerControl.addBaseLayer(googleSat, googleSatName);
    layerControl.addBaseLayer(googleTerrain, googleTerrainName);

    let linesName = language == "en" ? "Routes" : "路線";
    let markersName = language == "en" ? "Bus Stops" : "巴士站";
    let nearbyLinesName = language == "en" ? "Nearby Routes (KMB)" : "鄰近路線(九巴)";
    let nearbyStopsMarkerName = language == "en" ? "Nearby Bus Stops" : "鄰近巴士站";

    layerControl.addOverlay(lines, linesName);
    layerControl.addOverlay(markers, markersName);
    layerControl.addOverlay(nearbyLines, nearbyLinesName);
    layerControl.addOverlay(nearbyStopsMarker, nearbyStopsMarkerName);

    let gpsIcon = new L.Icon({
        iconUrl: './icons/icon_gps.png',
        shadowUrl: '',
        iconSize: [27, 27],
        iconAnchor: [7.6, 28.6],
        popupAnchor: [5, -25],
        shadowSize: [1, 1]
    });

    let redIcon = new L.Icon({
        iconUrl: './icons/bus_stop_red.png',
        shadowUrl: './icons/bus_stop_shadow.png',
        iconSize: [23, 44],
        iconAnchor: [11.5, 43],
        popupAnchor: [0, -41],
        shadowSize: [41, 41]
    });
    let greyIcon = new L.Icon({
        iconUrl: './icons/bus_stop_grey.png',
        shadowUrl: './icons/bus_stop_shadow.png',
        iconSize: [15.3, 29.3],
        iconAnchor: [7.6, 28.6],
        popupAnchor: [0, -27.3],
        shadowSize: [27.3, 27.3]
    });
    let goldIcon = new L.Icon({
        iconUrl: './icons/bus_stop_gold.png',
        shadowUrl: './icons/bus_stop_shadow.png',
        iconSize: [15.3, 29.3],
        iconAnchor: [7.6, 28.6],
        popupAnchor: [0, -27.3],
        shadowSize: [27.3, 27.3]
    });
    let orangeIcon = new L.Icon({
        iconUrl: './icons/bus_stop_orange.png',
        shadowUrl: './icons/bus_stop_shadow.png',
        iconSize: [15.3, 29.3],
        iconAnchor: [7.6, 28.6],
        popupAnchor: [0, -27.3],
        shadowSize: [27.3, 27.3]
    });
    let blackIcon = new L.Icon({
        iconUrl: './icons/bus_stop_black.png',
        shadowUrl: './icons/bus_stop_shadow.png',
        iconSize: [15.3, 29.3],
        iconAnchor: [7.6, 28.6],
        popupAnchor: [0, -27.3],
        shadowSize: [27.3, 27.3]
    });

    let currentStopMarkersByStopId = new Map();
    let currentStopMarkersByPin = new Map();

    const isPopupMobile = () => {
        return getComputedStyle(document.getElementById('map-mobile-popup-leaflet-div')).display != "none";
    };

    const clickMarker = (marker) => {
        marker.fireEvent('click', {
            latlng: marker.getLatLng(),
            layerPoint: map.latLngToLayerPoint(marker.getLatLng()),
            containerPoint: map.latLngToContainerPoint(marker.getLatLng())
        });
    }

    let style = document.createElement("style");
    document.head.appendChild(style);
    let stylesheet = style.sheet;

    let isClicked = false;
    let openPopups = [];
    map.on('popupopen', (evt) => {
        let popup = evt.popup;
        openPopups.push(popup);
        document.getElementById("map-mobile-popup-container").style.display = "";
        let html = popup.getContent();
        let leftHtml = "";
        let rightHtml = "";
        let stopIdData = currentStopMarkersByPin.get(popup._source);
        if (stopIdData) {
            let showRoute = stopIdData.size > 1;
            for (let routeNumber of stopIdData.keys()) {
                let routeDisplay = showRoute ? ("<span style=\"font-size: 15px;\">" + routeNumber + "</span>") : "";
                let routeStopIdData = stopIdData.get(routeNumber);
                if (routeStopIdData.hasOwnProperty("previous")) {
                    leftHtml += "<button class=\"button\" style=\"justify-content: left;\" onClick=\"clickMarker(currentStopMarkersByStopId.get('" + routeStopIdData['previous'] + "'));\"><i class=\"material-icons\" style=\"font-size: 25px; vertical-align: -12%;\">keyboard_arrow_left</i>" + routeDisplay + "</button>";
                }
                if (routeStopIdData.hasOwnProperty("previous_alt")) {
                    leftHtml += "<button class=\"button\" style=\"justify-content: left; color: #adadad;\" onClick=\"clickMarker(currentStopMarkersByStopId.get('" + routeStopIdData['previous_alt'] + "'));\"><i class=\"material-icons\" style=\"font-size: 25px; vertical-align: -12%;\">keyboard_arrow_left</i>" + routeDisplay + "</button>";
                }
                if (routeStopIdData.hasOwnProperty("previous_end")) {
                    leftHtml += "<button class=\"button\" style=\"justify-content: left; color: red;\" onClick=\"clickMarker(currentStopMarkersByStopId.get('" + routeStopIdData['previous_end'] + "'));\"><i class=\"material-icons\" style=\"font-size: 25px; vertical-align: -12%;\">first_page</i>" + routeDisplay + "</button>";
                }
                if (routeStopIdData.hasOwnProperty("next")) {
                    rightHtml += "<button class=\"button\" style=\"justify-content: right;\" onClick=\"clickMarker(currentStopMarkersByStopId.get('" + routeStopIdData['next'] + "'));\">" + routeDisplay + "<i class=\"material-icons\" style=\"font-size: 25px; vertical-align: -12%;\">keyboard_arrow_right</i></button>";
                }
                if (routeStopIdData.hasOwnProperty("next_alt")) {
                    rightHtml += "<button class=\"button\" style=\"justify-content: right; color: #adadad;\" onClick=\"clickMarker(currentStopMarkersByStopId.get('" + routeStopIdData['next_alt'] + "'));\">" + routeDisplay + "<i class=\"material-icons\" style=\"font-size: 25px; vertical-align: -12%;\">keyboard_arrow_right</i></button>";
                }
                if (routeStopIdData.hasOwnProperty("next_end")) {
                    rightHtml += "<button class=\"button\" style=\"justify-content: right; color: red;\" onClick=\"clickMarker(currentStopMarkersByStopId.get('" + routeStopIdData['next_end'] + "'));\">" + routeDisplay + "<i class=\"material-icons\" style=\"font-size: 25px; vertical-align: -12%;\">last_page</i></button>";
                }
            }
        }
        if (leftHtml != "") {
            html += "<div style=\"position: absolute; bottom: 10px; left: 10px; display: flex; flex-direction: column; row-gap: 7px;\">" + leftHtml + "</div>";
        }
        if (rightHtml != "") {
            html += "<div style=\"position: absolute; bottom: 10px; right: 10px; display: flex; flex-direction: column; row-gap: 7px;\">" + rightHtml + "</div>";
        }
        document.getElementById("map-mobile-popup").innerHTML = html;
        if (isPopupMobile()) {
            const f = () => {
                let height = document.querySelector('.leaflet-popup-content').querySelector('p').offsetHeight - 1;
                if (stylesheet.cssRules.length > 0) {
                    stylesheet.deleteRule(0);
                }
                stylesheet.insertRule("@media screen and (max-width : 906px) {.leaflet-popup-content {height: " + height + "px;}}", 0);
            };
            f();
            setTimeout(f, 500);
        }
    });
    map.on('popupclose', (evt) => {
        isClicked = false;
        document.getElementById("map-mobile-popup-container").style.display = "none";
        map.dragging.enable();
        map.doubleClickZoom.enable();
        let popup = evt.popup;
        setTimeout(() => {
            let index = openPopups.indexOf(popup);
            if (index !== -1) {
                openPopups.splice(index, 1);
            }
        }, 600);
    });
    map.on('click', (evt) => {
        isClicked = false;
    });

    document.getElementById("map-mobile-popup-leaflet-div").addEventListener('touchstart', e => {
        map.dragging.disable();
        map.doubleClickZoom.disable();
    });
    document.getElementById("map-mobile-popup-leaflet-div").addEventListener('touchend', e => {
        map.dragging.enable();
        map.doubleClickZoom.enable();
    });
    document.getElementById("map-mobile-popup-leaflet-div").addEventListener('click', e => {
        e.stopPropagation();
    });
    document.getElementById("map-mobile-popup-close").addEventListener('click', e => {
        map.closePopup();
    });
    window.addEventListener('resize', e => {
        map.closePopup();
    }, true);

    document.querySelectorAll(".mobile-dav-item").forEach(element => {
        element.addEventListener('click', e => {
            e.stopPropagation();
        });
    });

    let gpsMarker = null;
    let gpsWatchID = null;
    const getLocation = () => {
        if (navigator.geolocation) {
            gpsWatchID = navigator.geolocation.watchPosition(updatePosition);
        }
    };
    const updatePosition = (position) => {
        if (gpsMarker == null) {
            document.getElementById("pin-remove").disabled = true;

            gpsMarker = L.marker([position.coords.latitude, position.coords.longitude], {icon: gpsIcon}).addTo(gps).bindPopup(language == "en" ? "<p style=\"font-weight: bold;\">Your Location</p>" : "<p style=\"font-weight: bold;\">你的位置</p>").on("mouseover", e => {if (!isPopupMobile() && !isClicked) {e.target.openPopup()};}).on("mouseout", e => {if (!isClicked) {e.target.closePopup()};}).on("click", e => {isClicked = true; e.target.openPopup();});
            droppedPin = null;
            pin.clearLayers();
            map.flyTo(new L.LatLng(position.coords.latitude, position.coords.longitude), Math.max(17, map.getZoom()), {"duration": 1});
            updateNearestRoutes(position.coords.latitude, position.coords.longitude);

            let shareLink = getShareLink();
            window.history.replaceState(null, null, shareLink);
            document.getElementById('language').href = getShareLink(true);
        }
        gpsMarker.setLatLng(L.latLng(position.coords.latitude, position.coords.longitude));
    };
    setInterval(() => {
        if (gpsMarker != null) {
            let position = gpsMarker.getLatLng();
            updateNearestRoutes(position.lat, position.lng);
        }
    }, 15000);

    const capitalize = (str, lower = true) => {
        return (lower ? str.toLowerCase() : str).replace(/(?:^|\s|["'([{])+\S/g, match => match.toUpperCase());
    };
    const toChineseNumber = (n, isQuantity) => {
        const digits = ['零', '一', '二', '三', '四', '五', '六', '七', '八', '九'];
        const positions = ['', '十', '百', '千', '萬', '十萬', '百萬', '千萬', '億', '十億', '百億', '千億'];
        const charArray = String(n).split('');
        let result = '';
        let prevIsZero = false;
        for (let i = 0; i < charArray.length; i++) {
            const ch = charArray[i];
            if (ch !== '0' && !prevIsZero) {
                result += digits[parseInt(ch)] + positions[charArray.length - i - 1];
            } else if (ch === '0') {
                prevIsZero = true;
            } else if (ch !== '0' && prevIsZero) {
                result += '零' + digits[parseInt(ch)] + positions[charArray.length - i - 1];
            }
        }
        if (n < 100) {
            result = result.replace('一十', '十');
        }
        if (isQuantity && result === '二') {
            result = '兩';
        }
        return result;
    };
    const toggleBurger = () => {
        let burgerIcon = document.getElementById('burger');
        let dropMenu = document.getElementById('navbarMenuHeroA');
        burgerIcon.classList.toggle('is-active');
        dropMenu.classList.toggle('is-active');
    };
    const rangeCheck = (a, min, max) => {
        return a >= min && a <= max;
    };
    const roundTo2Decimal = (a) => {
        return Math.round((a + Number.EPSILON) * 100) / 100;
    };
    const roundTo1Decimal = (a) => {
        return Math.round((a + Number.EPSILON) * 10) / 10;
    };
    const toPrecision = (number, precision, direction) => {
        precision -= Math.floor(number).toString().length;
        let order = Math.pow(10, precision);
        number *= order;
        let option = (direction === 'down' ? 'floor' : 'ceil');
        return Math[option].call(null, number) / order;
    };
    const removeOptions = (selectElement) => {
        let i, L = selectElement.options.length - 1;
        for (i = L; i >= 1; i--) {
            selectElement.remove(i);
        }
    };
    const addOptions = (selectElement, text, id, value) => {
        let option = document.createElement("option");
        option.text = text;
        option.id = id;
        option.value = value;
        selectElement.add(option);
        sortOptions(selectElement);
    };
    const sortOptions = (selectElement) => {
        let options = selectElement.options;
        let optionsArray = [];
        for (let i = 0; i < options.length; i++) {
            optionsArray.push(options[i]);
        }
        optionsArray = optionsArray.sort((a, b) => {           
            return a.value - b.value;    
        });
        for (let i = 0; i <= options.length; i++) {            
            options[i] = optionsArray[i];
        }
        options[0].selected = true;
    };
    const deleteRows = (table, from) => {
        while (table.rows.length > from) {
            table.deleteRow(from);
        }
    };
    function addRows(table, ...text) {
        let row = table.insertRow(table.rows.length);

        for (let i = 0; i < text.length; i++) {
            let cell = row.insertCell(i);
            cell.innerHTML = text[i];
        }
    }
    const stopNamesIndexOf = (toMatch, stopNames) => {
        for (let i = 0; i < stopNames.length; i++) {
            let stopName = stopNames[i];
            if (toMatch.trim() == stopName.trim()) {
                return i;
            } else if (toMatch.replaceAll(/\(.*\)/ig, "").trim() == stopName.replaceAll(/\(.*\)/ig, "").trim()) {
                return i;
            }
        }
        return -1;
    };

    let busRouteList = [];
    let busRouteListOptions = "";
    let kmbRouteList = null;
    const kmbRouteListUrl = "https://data.etabus.gov.hk/v1/transport/kmb/route/";
    getJSON(kmbRouteListUrl, (err, data) => {
        if (err == null) {
            kmbRouteList = data["data"];
            for (let i = 0; i < kmbRouteList.length; i++) {
                let route = kmbRouteList[i]["route"];
                if (busRouteList.indexOf(route) < 0) {
                    busRouteList.push(route);
                }
            }
            let options = "";
            for (let i = 0; i < busRouteList.length; i++) {
                let route = busRouteList[i];
                options += "<option value=" + route + ">" + route + "</option>";
            }
            busRouteListOptions += options;
        } else {
            printConnectionError("Unable to get response from " + kmbRouteListUrl + ". (Is it down?)");
        }
    });

    let ctbRouteList = null;
    const ctbRouteListUrl = "https://rt.data.gov.hk/v2/transport/citybus/route/ctb";
    getJSON(ctbRouteListUrl, (err, data) => {
        if (err == null) {
            ctbRouteList = data["data"];
            for (let i = 0; i < ctbRouteList.length; i++) {
                let route = ctbRouteList[i]["route"];
                if (busRouteList.indexOf(route) < 0) {
                    busRouteList.push(route);
                }
            }
            let options = "";
            for (let i = 0; i < busRouteList.length; i++) {
                let route = busRouteList[i];
                options += "<option value=" + route + ">" + route + "</option>";
            }
            busRouteListOptions = options;
        } else {
            printConnectionError("Unable to get response from " + ctbRouteListUrl + ". (Is it down?)");
        }
    });

    let nlbRouteList = null;
    const nlbRouteListUrl = "https://rt.data.gov.hk/v2/transport/nlb/route.php?action=list";
    getJSON(nlbRouteListUrl, (err, data) => {
        if (err == null) {
            nlbRouteList = data["routes"];
            for (let i = 0; i < nlbRouteList.length; i++) {
                let route = nlbRouteList[i]["routeNo"];
                if (busRouteList.indexOf(route) < 0) {
                    busRouteList.push(route);
                }
            }
            let options = "";
            for (let i = 0; i < busRouteList.length; i++) {
                let route = busRouteList[i];
                options += "<option value=" + route + ">" + route + "</option>";
            }
            busRouteListOptions = options;
        } else {
            printConnectionError("Unable to get response from " + nlbRouteListUrl + ". (Is it down?)");
        }
    });

    let mtrBusRouteList = null;
    const mtrBusRouteListUrl = "https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/mtr_bus_routes.json";

    let mtrBusStopAliasList = null;
    const mtrBusStopAliasListUrl = "https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/mtr_bus_stop_alias.json";
    getJSON(mtrBusStopAliasListUrl, (err, data) => {
        if (err == null) {
            mtrBusStopAliasList = data;
        } else {
            printConnectionError("Unable to get response from " + mtrBusStopAliasListUrl + ". (Is it down?)");
        }
    });

    let gmbRouteList = null;
    const gmbRouteListUrl = "https://data.etagmb.gov.hk/route";
    getJSON(gmbRouteListUrl, (err, data) => {
        if (err == null) {
            gmbRouteList = data["data"]["routes"];
            for (let region in gmbRouteList) {
                let list = gmbRouteList[region];
                for (let i = 0; i < list.length; i++) {
                    let route = list[i];
                    if (busRouteList.indexOf(route) < 0) {
                        busRouteList.push(route);
                    }
                }
            }
            let options = "";
            for (let i = 0; i < busRouteList.length; i++) {
                let route = busRouteList[i];
                options += "<option value=" + route + ">" + route + "</option>";
            }
            busRouteListOptions = options;
        } else {
            printConnectionError("Unable to get response from " + gmbRouteListUrl + ". (Is it down?)");
        }
    });

    const testOrderedSubset = (b, a, bIndex) => {
        if (!a.length) {
            return true;
        }
        bIndex ??= b.findIndex(el => el === a[0]);
        return a[0] !== b[bIndex] ? false : testOrderedSubset(b.slice(bIndex + 1), a.slice(1), 0);
    }

    let dataSheet = null;
    const dataSheetUrl = "https://raw.githubusercontent.com/LOOHP/hk-bus-crawling/gh-pages/routeFareList.json";
    getJSON(dataSheetUrl, (err, data) => {
        if (err == null) {
            dataSheet = data;

            dataSheet["stopList"]["AC1FD9BDD09D1DD6"]["name"]["zh"] += " (沙頭角邊境禁區 - 需持邊境禁區許可證)";
            dataSheet["stopList"]["AC1FD9BDD09D1DD6"]["name"]["en"] += " (Sha Tau Kok Frontier Closed Area - Closed Area Permit Required)";
            dataSheet["stopList"]["20001477"]["name"]["zh"] += " (沙頭角邊境禁區 - 需持邊境禁區許可證)";
            dataSheet["stopList"]["20001477"]["name"]["en"] += " (Sha Tau Kok Frontier Closed Area - Closed Area Permit Required)";

            dataSheet["stopList"]["152"]["name"]["zh"] += " (深圳灣管制站 - 僅限過境旅客)";
            dataSheet["stopList"]["152"]["name"]["en"] += " (Shenzhen Bay Control Point - Border Crossing Passengers Only)";
            dataSheet["stopList"]["20015453"]["name"]["zh"] += " (深圳灣管制站 - 僅限過境旅客)";
            dataSheet["stopList"]["20015453"]["name"]["en"] += " (Shenzhen Bay Control Point - Border Crossing Passengers Only)";
            dataSheet["stopList"]["003208"]["name"]["zh"] += " (深圳灣管制站 - 僅限過境旅客)";
            dataSheet["stopList"]["003208"]["name"]["en"] += " (Shenzhen Bay Control Point - Border Crossing Passengers Only)";

            dataSheet["stopList"]["81567ACCCF40DD4B"]["name"]["zh"] += " (落馬洲支線出入境管制站 - 僅限過境旅客)";
            dataSheet["stopList"]["81567ACCCF40DD4B"]["name"]["en"] += " (Lok Ma Chau Spur Line Immigration Control Point - Border Crossing Passengers Only)";
            dataSheet["stopList"]["20015420"]["name"]["zh"] += " (落馬洲支線出入境管制站 - 僅限過境旅客)";
            dataSheet["stopList"]["20015420"]["name"]["en"] += " (Lok Ma Chau Spur Line Immigration Control Point - Border Crossing Passengers Only)";

            dataSheet["stopList"]["20011698"]["name"]["zh"] += " (落馬洲管制站 - 僅限過境旅客)";
            dataSheet["stopList"]["20011698"]["name"]["en"] += " (Lok Ma Chau Control Point - Border Crossing Passengers Only)";
            dataSheet["stopList"]["20015598"]["name"]["zh"] += " (落馬洲管制站 - 僅限過境旅客)";
            dataSheet["stopList"]["20015598"]["name"]["en"] += " (Lok Ma Chau Control Point - Border Crossing Passengers Only)";

            let kmbOps = new Set();
            outer: for (let key in dataSheet["routeList"]) {
                let data = dataSheet["routeList"][key];

                let co = data["bound"].hasOwnProperty("kmb") ? "kmb" : (data["bound"].hasOwnProperty("ctb") ? "ctb" : (data["bound"].hasOwnProperty("nlb") ? "nlb" : (data["bound"].hasOwnProperty("mtr-bus") ? "mtr-bus" : "gmb")));
                if (co != "ctb") {
                    let stops = data["stops"][co];
                    for (let key0 in dataSheet["routeList"]) {
                        let data0 = dataSheet["routeList"][key0];
                        let co0 = data0["bound"].hasOwnProperty("kmb") ? "kmb" : (data0["bound"].hasOwnProperty("ctb") ? "ctb" : (data0["bound"].hasOwnProperty("nlb") ? "nlb" : (data0["bound"].hasOwnProperty("mtr-bus") ? "mtr-bus" : "gmb")));
                        if (data != data0 && co == co0 && data["route"] == data0["route"]) {
                            let stops0 = data0["stops"][co0];
                            if (stops != undefined && stops0 != undefined && testOrderedSubset(stops0, stops)) {
                                delete dataSheet["routeList"][key];
                                continue outer;
                            }
                        }
                    }
                }

                if (data["bound"].hasOwnProperty("kmb")) {
                    if (data["co"].indexOf("ctb") >= 0) {
                        kmbOps.add(data["route"]);
                    }
                    if (data["fares"] == null) {
                        for (let key0 in dataSheet["routeList"]) {
                            let data0 = dataSheet["routeList"][key0];
                            if (data0 != data && data0["fares"] != null && data0["route"] == data["route"] && data0["seq"] == data["seq"]) {
                                data["fares"] = data0["fares"].slice(0, data["stops"]["kmb"].length);
                            }
                        }
                    }
                }
            }
            let ctbOps = new Set();
            let ctbStopCircularSets = {};
            let ctbStopSets = {};
            for (let key in dataSheet["routeList"]) {
                let data = dataSheet["routeList"][key];
                if (data["bound"].hasOwnProperty("ctb")) {
                    if (kmbOps.has(data["route"]) && !data["bound"].hasOwnProperty("kmb")) {
                        ctbOps.add(data["route"]);
                        delete dataSheet["routeList"][key];
                    } else {
                        if (data["bound"]["ctb"].length > 1 && data["orig"]["zh"] == data["dest"]["zh"]) {
                            let routeKey = data["route"] + "," + data["serviceType"];
                            let stops = data["stops"]["ctb"];
                            if (ctbStopCircularSets.hasOwnProperty(routeKey)) {
                                if (ctbStopCircularSets[routeKey].length < stops.length) {
                                    ctbStopCircularSets[routeKey] = stops;
                                }
                            } else {
                                ctbStopCircularSets[routeKey] = stops;
                            }
                        } else {
                            if (data["bound"]["ctb"].length > 1) {
                                data["bound"]["ctb"] = "I";
                            }
                            let routeKey = data["route"] + "," + data["bound"]["ctb"] + "," + data["serviceType"];
                            let stops = data["stops"]["ctb"];
                            if (ctbStopSets.hasOwnProperty(routeKey)) {
                                if (ctbStopSets[routeKey].length < stops.length) {
                                    ctbStopSets[routeKey] = stops;
                                }
                            } else {
                                ctbStopSets[routeKey] = stops;
                            }
                        }
                    }
                }
            }
            let ctbRouteDests = {};
            for (let key in dataSheet["routeList"]) {
                let data = dataSheet["routeList"][key];
                if (data["bound"].hasOwnProperty("ctb")) {
                    let routeKey = data["route"] + "," + data["serviceType"];
                    if (ctbStopCircularSets.hasOwnProperty(routeKey)) {
                        let stops = data["stops"]["ctb"];
                        let longestStops = ctbStopCircularSets[routeKey];
                        if (stops != longestStops && testOrderedSubset(longestStops, stops)) {
                            if (ctbRouteDests.hasOwnProperty(routeKey)) {
                                ctbRouteDests[routeKey].push(data["dest"]);
                            } else {
                                ctbRouteDests[routeKey] = [data["dest"]];
                            }
                            delete dataSheet["routeList"][key];
                            continue;
                        }
                        if (data["bound"]["ctb"].length > 1) {
                            data["bound"]["ctb"] = "O";
                        }
                        if (stops != longestStops && data["serviceType"] == 1) {
                            data["ctbSpecial"] = "Any";
                        }
                    } else {
                        routeKey = data["route"] + "," + data["bound"]["ctb"] + "," + data["serviceType"];
                        if (ctbStopSets.hasOwnProperty(routeKey)) {
                            let stops = data["stops"]["ctb"];
                            let longestStops = ctbStopSets[routeKey];
                            if (stops != longestStops) {
                                data["ctbSpecial"] = data["bound"]["ctb"];
                            }
                        }
                    }
                }
            }
            let intersection = new Set([...ctbOps].filter(x => kmbOps.has(x)));
            for (let key in dataSheet["routeList"]) {
                let data = dataSheet["routeList"][key];
                if (intersection.has(data["route"])) {
                    dataSheet["routeList"][key]["jointOp"] = true;
                }
                if (data["bound"].hasOwnProperty("ctb")) {
                    let routeKey = data["route"] + "," + data["serviceType"];
                    if (ctbRouteDests.hasOwnProperty(routeKey)) {
                        let destList = ctbRouteDests[routeKey].filter(e => e["zh"] != data["dest"]["zh"] || e["en"] != data["dest"]["en"]);
                        if (destList.length > 0) {
                            data["ctbCircularDests"] = destList;
                        }
                    }
                }
            }

            getJSON(mtrBusRouteListUrl, (err, data) => {
                if (err == null) {
                    mtrBusRouteList = data;
                    for (let key in mtrBusRouteList) {
                        let route = mtrBusRouteList[key]["route"];
                        if (busRouteList.indexOf(route) < 0) {
                            busRouteList.push(route);
                        }
                    }
                    dataSheet["routeList"] = {...dataSheet["routeList"], ...mtrBusRouteList};
                    let options = "";
                    for (let i = 0; i < busRouteList.length; i++) {
                        let route = busRouteList[i];
                        options += "<option value=" + route + ">" + route + "</option>";
                    }
                    busRouteListOptions = options;
                } else {
                    printConnectionError("Unable to get response from " + mtrBusRouteListUrl + ". (Is it down?)");
                }
            });

            getJSON("https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/mtr_bus_stops.json", (err, data) => {
                if (err == null) {
                    dataSheet["stopList"] = {...dataSheet["stopList"], ...data};
                } else {
                    printConnectionError("Unable to get response from https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/mtr_bus_stops.json. (Is it down?)");
                }
            });
        } else {
            printConnectionError("Unable to get response from " + dataSheetUrl + ". (Is it down?)");
        }
    });

    let bbiF1 = null;
    const bbiF1Url = "https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/bbi_f1.json";
    getJSON(bbiF1Url, (err, data) => {
        if (err == null) {
            bbiF1 = data;
        } else {
            printConnectionError("Unable to get response from " + bbiF1Url + ". (Is it down?)");
        }
    });

    let bbiB1 = null;
    const bbiB1Url = "https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/bbi_b1.json";
    getJSON(bbiB1Url, (err, data) => {
        if (err == null) {
            bbiB1 = data;
        } else {
            printConnectionError("Unable to get response from " + bbiB1Url + ". (Is it down?)");
        }
    });

    let bbiStopId = null;
    const bbiStopIdUrl = "https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/kmb_bbi_stop_id.json";
    getJSON(bbiStopIdUrl, (err, data) => {
        if (err == null) {
            bbiStopId = data;
        } else {
            printConnectionError("Unable to get response from " + bbiStopIdUrl + ". (Is it down?)");
        }
    });

    let bbiGmbKmb = null;
    const bbiGmbKmbUrl = "https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/kmb_gmb_interchange.json";
    getJSON(bbiGmbKmbUrl, (err, data) => {
        if (err == null) {
            bbiGmbKmb = data;
        } else {
            printConnectionError("Unable to get response from " + bbiGmbKmbUrl + ". (Is it down?)");
        }
    });

    let regionalTwoWaySectionFare = null;
    const regionalTwoWaySectionFareUrl = "https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/regional_two_way_section_fare.json";
    getJSON(regionalTwoWaySectionFareUrl, (err, data) => {
        if (err == null) {
            regionalTwoWaySectionFare = data;
        } else {
            printConnectionError("Unable to get response from " + regionalTwoWaySectionFareUrl + ". (Is it down?)");
        }
    });

    let bbiCtb = null;
    const bbiCtbUrl = "https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/ctb_bbi_data.json";
    getJSON(bbiCtbUrl, (err, data) => {
        if (err == null) {
            bbiCtb = data;
        } else {
            printConnectionError("Unable to get response from " + bbiCtbUrl + ". (Is it down?)");
        }
    });

    let ctbId = null;
    const ctbIdUrl = "https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/ctb_route_ids.json";
    getJSON(ctbIdUrl, (err, data) => {
        if (err == null) {
            ctbId = data;
        } else {
            printConnectionError("Unable to get response from " + ctbIdUrl + ". (Is it down?)");
        }
    });

    let ready = false;
    const waitLoadParameters = (condition) => {
        if (condition() === false) {
            window.setTimeout(() => waitLoadParameters(condition), 100);
        } else {
            if (!loadUrlParameters()) {
                routeAdd();
            }

            let firstClockRun = true;
            setInterval(() => {
                let now = new Date();
                let monthOption = language == "en" ? "numeric" : "long";
                let date = now.toLocaleString(language == "en" ? "en-UK" : "zh-HK", {
                    timeZone: "Asia/Hong_Kong", 
                    year: 'numeric', 
                    month: monthOption, 
                    day: 'numeric'
                });
                let weekday = now.toLocaleString(language + "-HK", {
                    timeZone: "Asia/Hong_Kong", 
                    weekday: 'long'
                });
                let time = now.toLocaleTimeString("en-UK", {
                    timeZone: "Asia/Hong_Kong",
                    hour: '2-digit', 
                    minute:'2-digit',
                    second: '2-digit'
                });
                let timezone = language == "en" ? "HKT" : "香港時間";

                let holidayFormatted = new Date().toLocaleString("en-ZA", {timeZone: "Asia/Hong_Kong", year: 'numeric', month: 'numeric', day: 'numeric'}).replaceAll("/", "");
                let weekdayFormatted = new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong", weekday: 'long'});
                let isPublicHoliday = weekdayFormatted == "Sunday" || dataSheet["holidays"].indexOf(holidayFormatted) >= 0;
                let publicHoliday = language == "en" ? "(Public Holiday)" : "(公眾假期)"; 

                let complete;
                if (language == "en") {
                    complete = date + " " + weekday + "<br>" + time + " " + timezone;
                } else {
                    complete = timezone + " " + date + "<br>" + weekday + " " + time;
                }
                if (isPublicHoliday) {
                    complete += " " + (language == "en" ? "(Public Holiday)" : "(公眾假期)");
                }

                document.getElementById("map-clock").innerHTML = complete;
                if (firstClockRun) {
                    document.getElementById("map-clock-container").style.display = "";
                    firstClockRun = false;
                }
            }, 500);

            document.getElementById("toggle-gps").disabled = false;
            document.getElementById("route-add").disabled = false;
            document.getElementById("loading-overlay").style.display = "none";
            document.getElementById("loading-overlay").style.display = "none";
            ready = true;
        }
    }
    waitLoadParameters(() => dataSheet != null && kmbRouteList != null && nlbRouteList != null && mtrBusRouteList != null && busRouteListOptions != "" && bbiF1 != null && bbiB1 != null && regionalTwoWaySectionFare != null);

    document.getElementById("map-clock").addEventListener('mouseover', e => {
        map.dragging.disable();
        map.doubleClickZoom.disable();
    });
    document.getElementById("map-clock").addEventListener('touchstart', e => {
        map.dragging.disable();
        map.doubleClickZoom.disable();
    });
    document.getElementById("map-clock").addEventListener('mouseout', e => {
        map.dragging.enable();
        map.doubleClickZoom.enable();
    });
    document.getElementById("map-clock").addEventListener('touchend', e => {
        map.dragging.enable();
        map.doubleClickZoom.enable();
    });
    document.getElementById("map-clock").addEventListener('click', e => {
        e.stopPropagation();
    });

    const kmbBbiMapUrl = "https://app.kmb.hk/app1933/BBI/map/{id}.jpg";
    const applyBbiStopHref = (stopName) => {
        for (let bbiId in bbiStopId) {
            let bbiNameDataList = bbiStopId[bbiId];
            let mainName = bbiNameDataList[0];
            for (let i = 0; i < bbiNameDataList.length; i++) {
                let bbiNameData = bbiNameDataList[i];
                let url = kmbBbiMapUrl.replace("{id}", bbiId);
                let tooltip = language == "en" ? "Open " + mainName["en"] + " BBI location map" : "展示" + mainName["zh"] + "轉車站位置圖";
                let hrefTag = "<a href=\"" + url + "\" target=\"_blank\" title=\"" + tooltip + "\" class=\"bbi-map-href\"><i class=\"material-icons\" style=\"font-size: inherit; vertical-align: -12%;\">sync_alt</i> $1</a>";
                let patternZh = new RegExp("(?<!,)(?:^|[> ;])(" + bbiNameData["zh"] + "(?:轉車站(?: *-? *[^(\\n<]+)?(?: *\\([A-Z0-9]+\\))?)|" + bbiNameData["zh"] + "(?: *\\([A-Z0-9]+\\))?(?=[ \\n<]|$))", 'gi');
                let patternEn = new RegExp("(?<!,)(?:^|[> ;])(" + bbiNameData["en"] + "(?: *BBI)(?: *-? *[^(\\n<]+)?(?: *\\([A-Z0-9]+\\))?|" + bbiNameData["en"] + "(?: *\\([A-Z0-9]+\\))?(?= *[\\n<]|$))", 'gi');
                stopName = stopName.replaceAll(patternZh, hrefTag).replaceAll(patternEn, hrefTag);
            }
        }
        document.querySelectorAll('.bbi-map-href').forEach(element => {
            element.addEventListener('click', bbiStopHandler);
        });
        return stopName;
    };
    const bbiStopHandler = (event) => event.stopPropagation();

    let kmbSpecialAnnouncementsUrl = "https://search.kmb.hk/KMBWebSite/Function/FunctionRequest.ashx?action=getAnnounce&route={route}&bound={bound}";
    let kmbAnnouncementPictureUrl = "https://search.kmb.hk/KMBWebSite/AnnouncementPicture.ashx?url=";
    let kmbTimeTableUrl = "https://search.kmb.hk/KMBWebSite/Function/FunctionRequest.ashx?action=getschedule&route={route}&bound={bound}";
    let kmbRouteDataUrl = "https://search.kmb.hk/KMBWebSite/Function/FunctionRequest.ashx?action=getstops&route={route}&bound={bound}&serviceType={type}";
    let kmbStopEtaUrl = "https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/{stop}";
    let kmbStopRouteEtaUrl = "https://data.etabus.gov.hk/v1/transport/kmb/eta/{stop}/{route}/{type}";

    let ctbSpecialAnnouncementsUrl = "https://mobile.citybus.com.hk/nwp3/specialNote.php?r={route}"
    let ctbTimeTableUrl = "https://mobile.citybus.com.hk/nwp3/gettimetable.php?info={id}&bound={bound}&l={lang}";
    let ctbStopEtaUrl = "https://rt.data.gov.hk/v2/transport/citybus/eta/CTB/{stop}/{route}";
    let ctbStopRouteEtaUrl = "https://rt.data.gov.hk/v2/transport/citybus/route-stop/CTB/{route}/{bound}";

    let nlbInfoUrl = "https://www.nlb.com.hk/route/detail/{id}";
    let nlbStopRouteEtaUrl = "https://rt.data.gov.hk/v2/transport/nlb/stop.php?action=estimatedArrivals&routeId={route}&stopId={stop}&language={lang}";

    let mtrBusInfoUrl = "https://www.mtr.com.hk/{lang}/customer/services/searchBusRouteDetails.php?routeID={route}";
    let mtrBusRouteEtaUrl = "https://rt.data.gov.hk/v1/transport/mtr/bus/getSchedule";

    let gmbInfoUrl = "https://www.16seats.net/{lang}/gmb/g{region}_{route}.html";
    let gmbStopEtaUrl = "https://data.etagmb.gov.hk/eta/stop/{stop}";

    let updatingRouteTasks = [];

    const getRouteNumberDisplay = (co, routeNumber, options = {}) => {
        let emoji = options["emoji"] == true;
        let background = options["background"] == true;
        let inverted = options["inverted"] == true;

        let routeNumberDisplay = routeNumber;
        if (background) {
            let color;
            let backgroundColor;
            if (co == "kmb") {
                color = "black";
                backgroundColor = "white";
                if (routeNumber.startsWith("NA")) {
                    color = "yellow";
                    backgroundColor = "black";
                } else if (routeNumber.startsWith("N")) {
                    color = "white";
                    backgroundColor = "black";
                } else if (/[A-Z]*[1346][0-9]{2}[A-Z]?/g.test(routeNumber)) {
                    color = "white";
                    backgroundColor = "red";
                } else if (routeNumber.startsWith("P")) {
                    color = "white";
                    backgroundColor = "#BC8F8F";
                } else if (routeNumber.startsWith("E")) {
                    color = "white";
                    backgroundColor = "orange";
                } else if (routeNumber.startsWith("S")) {
                    color = "#0000ff";
                    backgroundColor = "orange";
                } else if (/[A-Z]*[9][0-9]{2}[A-Z]?/g.test(routeNumber)) {
                    color = "white";
                    backgroundColor = "green";
                } else if (routeNumber.startsWith("A")) {
                    color = "yellow";
                    backgroundColor = "#000066";
                } else if (routeNumber.startsWith("R")) {
                    color = "white";
                    backgroundColor = "#000066";
                } else if (routeNumber.startsWith("X")) {
                    color = "white";
                    backgroundColor = "orange";
                }
            } else if (co == "ctb") {
                color = "white";
                backgroundColor = "#0066ff";
                if (routeNumber.startsWith("B") || (routeNumber.startsWith("E") && !routeNumber.startsWith("E11"))) {
                    color = "white";
                    backgroundColor = "red";
                } else if (routeNumber.startsWith("A")) {
                    color = "white";
                    backgroundColor = "#800000";
                } else if (routeNumber.startsWith("E11") || routeNumber.startsWith("H")) {
                    color = "white";
                    backgroundColor = "green";
                } else if (routeNumber.startsWith("R")) {
                    color = "#0000ff";
                    backgroundColor = "LightSkyBlue";
                } else if (/[A-Z]*[1346][0-9]{2}[A-Z]?/g.test(routeNumber)) {
                    color = "white";
                    backgroundColor = "red";
                } else if (/[A-Z]*[9][0-9]{2}[A-Z]?/g.test(routeNumber)) {
                    color = "white";
                    backgroundColor = "green";
                } else if (routeNumber.startsWith("N")) {
                    color = "yellow";
                    backgroundColor = "black";
                }
            } else if (co == "nlb") {
                color = "black";
                backgroundColor = "white";
                if (routeNumber.startsWith("A")) {
                    color = "yellow";
                    backgroundColor = "red";
                } else if (routeNumber.startsWith("N")) {
                    color = "yellow";
                    backgroundColor = "black";
                }
            } else if (co == "mtr-bus") {
                color = "#001F50";
                backgroundColor = "white";
            } else if (co == "gmb") {
                color = "#00A067";
                backgroundColor = "white";
            }

            if (inverted) {
                if (backgroundColor == "white") {
                    routeNumberDisplay = "<span style=\"color: " + color + ";\">" + routeNumberDisplay + "</span>";
                } else {
                    routeNumberDisplay = "<span style=\"color: " + backgroundColor + ";\">" + routeNumberDisplay + "</span>";
                }
            } else {
                routeNumberDisplay = "<span style=\"color: " + color + "; background-color: " + backgroundColor + ";\">" + routeNumberDisplay + "</span>";
            }
        } else {
            if (co == "kmb") {
                if (routeNumber == "78A") {
                    if (emoji) {
                        routeNumberDisplay += "👑";
                    }
                } else if (routeNumber.startsWith("P")) {
                    routeNumberDisplay = "<b style=\"color: #996247;\">" + routeNumberDisplay + "</b>";
                    if (emoji) {
                        routeNumberDisplay += "⭐";
                    }
                }
            }
        }
        return routeNumberDisplay;
    };

    const updateNearestRoutes = (lat, lng) => {
        if (calculateTasks.length > 0) {
            checkFlag(() => updatingRouteTasks.length == 0 && ready, updateNearestRoutes);
            return;
        }

        let taskId = makeId(10);
        updatingRouteTasks.push(taskId);

        try {
            let stops = dataSheet["stopList"];
            let nearbyStops = [];
            let gpsLocation = {"lat": lat, "lng": lng};
            for (let stopId in stops) {
                let entry = stops[stopId];
                let distance = findDistance(gpsLocation, entry["location"]);
                if (distance <= 0.3) {
                    if (/^[0-9A-Z]{16}$/.test(stopId)) {
                        nearbyStops.push({"stopId": stopId, "data": entry, "distance": distance, "co": "kmb"});
                    } else if (/^[0-9]{6}$/.test(stopId)) {
                        nearbyStops.push({"stopId": stopId, "data": entry, "distance": distance, "co": "ctb"});
                    } else if (/^[0-9]{1,4}$/.test(stopId)) {
                        nearbyStops.push({"stopId": stopId, "data": entry, "distance": distance, "co": "nlb"});
                    } else if (/^[A-Z]?[0-9]{1,3}[A-Z]?-[A-Z][0-9]{3}$/.test(stopId)) {
                        nearbyStops.push({"stopId": stopId, "data": entry, "distance": distance, "co": "mtr-bus"});
                    } else if (/^[0-9]{8}$/.test(stopId)) {
                        nearbyStops.push({"stopId": stopId, "data": entry, "distance": distance, "co": "gmb"});
                    }
                }
            }
            let nearbyRoutes = {};
            for (let i = 0; i < nearbyStops.length; i++) {
                let nearbyStop = nearbyStops[i];
                for (let key in dataSheet["routeList"]) {
                    let data = dataSheet["routeList"][key];
                    let isKmb = data["bound"].hasOwnProperty("kmb") && data["stops"]["kmb"].indexOf(nearbyStop["stopId"]) >= 0;
                    let isCtb = data["bound"].hasOwnProperty("ctb") && data["stops"]["ctb"].indexOf(nearbyStop["stopId"]) >= 0;
                    let isNlb = data["bound"].hasOwnProperty("nlb") && data["stops"]["nlb"].indexOf(nearbyStop["stopId"]) >= 0;
                    let isMtrBus = data["bound"].hasOwnProperty("mtr-bus") && data["stops"]["mtr-bus"].indexOf(nearbyStop["stopId"]) >= 0;
                    let isGmb = data["bound"].hasOwnProperty("gmb") && data["stops"]["gmb"].indexOf(nearbyStop["stopId"]) >= 0;
                    if (isKmb || isCtb || isNlb || isMtrBus || isGmb) {
                        let co = isKmb ? "kmb" : (isCtb ? "ctb" : (isNlb ? "nlb" : (isMtrBus ? "mtr-bus" : "gmb")));
                        let key = data["route"] + "," + (co == "nlb" ? data["nlbId"] : data["bound"][co]);
                        if (nearbyRoutes.hasOwnProperty(key)) {
                            if (nearbyRoutes[key]["stop"]["distance"] > nearbyStop["distance"]) {
                                nearbyRoutes[key] = {"stop": nearbyStop, "route": data, "co": co};
                            }
                        } else {
                            nearbyRoutes[key] = {"stop": nearbyStop, "route": data, "co": co};
                        }
                    }
                }
            }

            nearbyLines.clearLayers();
            nearbyStopsMarker.clearLayers();

            if (Object.keys(nearbyRoutes).length == 0) {
                document.getElementById("nearby-routes-content").style.display = "none";
                document.getElementById("nearby-routes-prompt").style.display = "";
                document.getElementById("nearby-routes-prompt").innerHTML = language == "en" ? "There are no nearby bus stops" : "附近沒有巴士站";
                return;
            }
            document.getElementById("nearby-routes-prompt").style.display = "none";
            document.getElementById("nearby-routes-prompt").innerHTML = "";

            let table = 
                "<table class=\"table has-background-grey-lighter is-hoverable div-mobile-max-width\" id=\"fare-table\" style=\"height: 100px; min-width: 40vw;\">" +
                "<tbody>" +
                    "<colgroup class=\"div-only-mobile\">" +
                        "<col span=\"1\" style=\"width: 62%;\">" +
                        "<col span=\"1\" style=\"width: 38%;\">" +
                    "</colgroup>" +
                    "<tr style=\"background-color: #DBDBDB; position: sticky; top: 0;\">" +
                        "<th style=\"position: sticky; top: 0; font-size: 18px;\">" + (language == "en" ? "Route" : "路線") + "</th>" +
                        "<th style=\"position: sticky; top: 0; font-size: 18px; text-align: right;\">" + (language == "en" ? "ETA" : "預計到達時間") + "</th>" +
                    "</tr>";

            let routes = [];
            for (let key in nearbyRoutes) {
                routes.push(nearbyRoutes[key]);
            }
            let hour = (new Date().getUTCHours() + 8) % 24;
            let isNight = hour >= 1 && hour < 5;
            let weekday = new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong", weekday: 'long'});
            let date = new Date().toLocaleString("en-ZA", {timeZone: "Asia/Hong_Kong", year: 'numeric', month: 'numeric', day: 'numeric'}).replaceAll("/", "");
            let isHoliday = weekday == "Saturday" || weekday == "Sunday" || dataSheet["holidays"].indexOf(date) >= 0;

            routes.sort((a, b) => {
                let pa = a["route"]["route"][0];
                let pb = b["route"]["route"][0];
                let sa = a["route"]["route"][a["route"]["route"].length - 1];
                let sb = b["route"]["route"][b["route"]["route"].length - 1];
                let na = Number(a["route"]["route"].match(/[0-9]+/g));
                let nb = Number(b["route"]["route"].match(/[0-9]+/g));
                if (a["route"]["bound"].hasOwnProperty("gmb")) {
                    na += 1000;
                }
                if (b["route"]["bound"].hasOwnProperty("gmb")) {
                    nb += 1000;
                }
                if (pa == "N" || a["route"]["route"] == "270S" || a["route"]["route"] == "271S" || a["route"]["route"] == "293S" || a["route"]["route"] == "701S" || a["route"]["route"] == "796S") {
                    na -= (isNight ? 1 : -1) * 10000;
                }
                if (pb == "N" || b["route"]["route"] == "270S" || b["route"]["route"] == "271S" || b["route"]["route"] == "293S" || b["route"]["route"] == "701S" || b["route"]["route"] == "796S") {
                    nb -= (isNight ? 1 : -1) * 10000;
                }
                if (sa == "S" && a["route"]["route"] != "89S" && a["route"]["route"] != "796S") {
                    na += 1000;
                }
                if (sb == "S" && b["route"]["route"] != "89S" && b["route"]["route"] != "796S") {
                    nb += 1000;
                }
                if (!isHoliday) {
                    if (pa == "R" || sa == "R") {
                        na += 100000;
                    }
                    if (pb == "R" || sb == "R") {
                        nb += 100000;
                    }
                }
                if (!/[0-9]/.test(pa) && pa != "K") {
                    na += 400;
                }
                if (!/[0-9]/.test(pb) && pb != "K") {
                    nb += 400;
                }
                let diff = na - nb;
                if (diff == 0) {
                    diff = a["route"]["route"].localeCompare(b["route"]["route"]);
                }
                if (diff == 0) {
                    diff = Number(a["route"]["serviceType"]) - Number(b["route"]["serviceType"]);
                }
                if (diff == 0) {
                    diff = Number(a["route"]["bound"]["kmb"]) - Number(b["route"]["bound"]["kmb"]);
                }
                return diff;
            });

            let allNearbyStops = {};
            let allOtherStops = {};
            for (let i = 0; i < routes.length; i++) {
                let entry = routes[i];
                let route = entry["route"];
                let stop = entry["stop"];
                let co = entry["co"];

                let stopId = stop["stopId"];
                let bound = co == "nlb" ? route["nlbId"] : route["bound"][co];

                if (allNearbyStops.hasOwnProperty(stopId)) {
                    allNearbyStops[stopId].push(route);
                } else {
                    allNearbyStops[stopId] = [route];
                }
                if (allOtherStops.hasOwnProperty(stopId)) {
                    let list = allOtherStops[stopId];
                    for (let u = 0; u < list.length; u++) {
                        allNearbyStops[stopId].push(list[u]);
                    }
                    delete allOtherStops[stopId];
                }

                let routeNumber = route["route"];
                let stopName = stop["data"]["name"][language == "en" ? "en" : "zh"];
                let destName = route["dest"][language == "en" ? "en" : "zh"];

                if (language == "en") {
                    stopName = capitalize(stopName);
                    destName = capitalize(destName);
                }
                destName = destName.replaceAll("(", "​(").replace(/([^​]{5})/g,"$1​");

                if (entry["co"] == "ctb") {
                    stopName += language == "en" ? " (CTB)" : " (城巴)";
                } else if (entry["co"] == "nlb") {
                    stopName += language == "en" ? " (NLB)" : " (嶼巴)";
                } else if (entry["co"] == "mtr-bus") {
                    stopName += language == "en" ? " (MTR-Bus)" : " (港鐵巴士)";
                } else if (entry["co"] == "gmb") {
                    stopName += language == "en" ? " (GMB)" : " (專線小巴)";
                }

                let routeNumberDisplay = getRouteNumberDisplay(entry["co"], routeNumber, {background: true});

                let allStops = route["stops"][co];

                for (let u = allStops.indexOf(stopId); u < allStops.length; u++) {
                    let routeStopId = allStops[u];
                    if (allNearbyStops.hasOwnProperty(routeStopId)) {
                        allNearbyStops[routeStopId].push(route);
                    } else {
                        if (allOtherStops.hasOwnProperty(routeStopId)) {
                            allOtherStops[routeStopId].push(route);
                        } else {
                            allOtherStops[routeStopId] = [route];
                        } 
                    }
                }

                let index = 1;
                let shareLink = getShareLink();
                for (let i = 1; true; i++) {
                    if (shareLink.indexOf("r" + i + "=") >= 0) {
                        index = i + 1;
                    } else {
                        break;
                    }
                }

                if (co != "ctb" || route["co"].indexOf("kmb") < 0) {
                    let params = "'" + co + "','" + routeNumber + "','" + bound + "','" + route["serviceType"] + "','" + stopId + "','" + allStops[allStops.length - 1] + "'";

                    let distance = Math.round(stop["distance"] * 1000).toFixed(0);
                    let distanceStr = "<i class=\"material-icons\" style=\"font-size: inherit; vertical-align: -12%;\">directions_walk</i>" + distance + (language == "en" ? "m" : "米");

                    table += 
                        "<tr style=\"cursor: pointer;\" onclick=\"handleNearbyRouteClick(" + params + ");\">" +
                            "<th style=\"font-size: 20px;\"><span style=\"font-size: 30px;\">" + getRouteNumberDisplay(entry["co"], routeNumber, {background: true, inverted: true}) + "</span> <br class=\"div-only-mobile\"><span style=\"font-size: 15px;\">" + (language == "en" ? "To " : "往") + "</span>​<span style=\"word-break: keep-all; white-space: break-spaces;\">" + destName + "</span><br><span style=\"font-size: 15px;\">" + applyBbiStopHref(stopName) + " " + distanceStr + "</span></th>" +
                            "<th style=\"text-align: right;\"><span style=\"font-size: 25px;\">​</span><span class=\"eta-update\" id=\"nearby_" + co + "," + stopId + "," + routeNumber + "," + bound + ",1,25,1\"></span></th>" +
                        "</tr>";
                }

                if (co == "kmb") {
                    let task0Id = makeId(10);
                    updatingRouteTasks.push(task0Id);
                    getJSON("https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/route_paths/" + routeNumber + ".json", (err, data) => {
                        try {
                            if (err == null) {
                                let sections = data[bound][route["serviceType"]];
                                if (sections == undefined) {
                                    return;
                                }

                                for (let i = allStops.indexOf(stopId); i < sections.length; i++) {
                                    let path = sections[i];
                                    let pointListRoute = [];
                                    for (let u = 0; u < path.length; u++) {
                                        let position = path[u];
                                        pointListRoute.push(new L.LatLng(position[0], position[1]));
                                    }
                                    let coStr = "";
                                    if (co == "ctb") {
                                        coStr = language == "en" ? " - CTB" : " - 城巴";
                                    } else if (co == "nlb") {
                                        coStr = language == "en" ? " - NLB" : " - 嶼巴";
                                    } else if (co == "mtr-bus") {
                                        coStr = language == "en" ? " - MTR-Bus" : " - 港鐵巴士";
                                    } else if (co == "gmb") {
                                        coStr = language == "en" ? " - GMB" : " - 專線小巴";
                                    }
                                    let desc;
                                    if (language == "en") {
                                        desc = "<b style=\"font-size: 17px\">" + routeNumberDisplay + " <span style=\"font-size: 12px\">To </span><span style=\"font-size: 15px\">" + capitalize(route["dest"]["en"]) + coStr + "</span></b>";
                                    } else {
                                        desc = "<b style=\"font-size: 17px\">" + routeNumberDisplay + " <span style=\"font-size: 12px\">往</span><span style=\"font-size: 15px\">" + route["dest"]["zh"] + coStr + "</span></b>";
                                    }
                                    let color = '#8a0101';
                                    if (routeNumber.startsWith("N")) {
                                        color = '#000000';
                                    } else if (routeNumber.startsWith("R") || routeNumber.endsWith("R")) {
                                        color = '#014c8a';
                                    } else if (routeNumber.endsWith("S") && routeNumber != "89S" && routeNumber != "796S") {
                                        color = '#016166';
                                    } else if (routeNumber.startsWith("P")) {
                                        color = '#996247';
                                    }
                                    new L.Polyline(pointListRoute, {
                                        color: color,
                                        weight: 2,
                                        opacity: 0.7,
                                        smoothFactor: 0.00001
                                    }).addTo(nearbyLines).bindPopup(desc).on("mouseover", e => {if (!isPopupMobile() && !isClicked) {e.target.openPopup(e.latlng)};}).on("mouseout", e => {if (!isClicked) {e.target.closePopup()};}).on("click", e => {isClicked = true; e.target.openPopup();});
                                }
                            } else {
                                printConnectionError("Unable to get response from https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/route_paths/" + routeNumber + ".json. (Is it down?)");
                            }
                        } finally {
                            updatingRouteTasks.splice(updatingRouteTasks.indexOf(task0Id), 1);
                        }
                    });
                }
            }

            for (let stopId in allNearbyStops) {
                let routes = allNearbyStops[stopId].filter((value, index, array) => array.indexOf(value) === index);
                let stop = dataSheet["stopList"][stopId];
                let stopName = stop["name"][language == "en" ? "en" : "zh"];
                if (language == "en") {
                    stopName = capitalize(stopName);
                }

                let distance = Math.round(findDistance(stop["location"], gpsLocation) * 1000).toFixed(0);
                let title = language == "en" ? "Nearby " : "鄰近";
                let distanceStr = "<i class=\"material-icons\" style=\"font-size: inherit; vertical-align: -12%;\">directions_walk</i>" + distance + (language == "en" ? "m" : "米");

                let stopCo = /^[0-9]{6}$/g.test(stopId) ? "ctb" : (/^[0-9]{1,4}$/g.test(stopId) ? "nlb" : (/^[A-Z]?[0-9]{1,3}[A-Z]?-[A-Z][0-9]{3}$/.test(stopId) ? "mtr-bus" : (/^[0-9]{8}$/.test(stopId) ? "gmb" : "kmb")));
                let routesInfo = [];
                for (let i = 0; i < routes.length; i++) {
                    let route = routes[i];
                    let routeNumber = route["route"];
                    let destName = route["dest"][language == "en" ? "en" : "zh"];
                    let co = route["bound"].hasOwnProperty("kmb") ? "kmb" : (route["bound"].hasOwnProperty("ctb") ? "ctb" : (route["bound"].hasOwnProperty("nlb") ? "nlb" : (route["bound"].hasOwnProperty("mtr-bus") ? "mtr-bus" : "gmb")));
                    if (language == "en") {
                        destName = capitalize(destName);
                    }
                    let bound = co == "nlb" ? route["nlbId"] : route["bound"][co];

                    let allStops = route["stops"][co];
                    let params = "'" + co + "','" + routeNumber + "','" + route["bound"][co] + "','" + route["serviceType"] + "','" + stopId + "','" + allStops[allStops.length - 1] + "'";

                    if (co == "ctb" && route["stops"].hasOwnProperty("kmb")) {
                        let kmbAllStops = route["stops"]["kmb"];
                        params = "'kmb','" + routeNumber + "','" + route["bound"]["kmb"] + "','" + route["serviceType"] + "','" + kmbAllStops[allStops.indexOf(kmbAllStops)] + "','" + kmbAllStops[kmbAllStops.length - 1] + "'";
                    }

                    let routeNumberDisplay = getRouteNumberDisplay(co, routeNumber, {background: true});

                    let table = 
                        "<tr class=\"nearby-stop\" style=\"cursor: pointer;\" onclick=\"handleNearbyRouteClick(" + params + ");\">" +
                            "<th><b style=\"font-size: 15px; text-align: center;\">" + routeNumberDisplay + "</b></th>" +
                            "<th width=\"99%\" style=\"padding:0 5px 0 5px;\"><b style=\"font-size: 15px\"><span style=\"font-size: 10px\">" + (language == "en" ? "To " : "往") + "</span><span style=\"font-size: 15px\">" + destName + "</span></b></th>" +
                            "<th style=\"text-align: right;\"><span class=\"eta-update\" id=\"nearbymap_" + co + "," + stopId + "," + routeNumber + "," + bound + ",1,15,2\">⠀⠀⠀⠀⠀⠀⠀</span></th>" +
                        "</tr>";

                    routesInfo.push(table);
                }

                if (stopCo == "ctb") {
                    stopName += language == "en" ? " - CTB" : " - 城巴";
                } else if (stopCo == "nlb") {
                    stopName += language == "en" ? " - NLB" : " - 嶼巴";
                } else if (stopCo == "mtr-bus") {
                    stopName += language == "en" ? " - MTR-Bus" : " - 港鐵巴士";
                } else if (stopCo == "gmb") {
                    stopName += language == "en" ? " - GMB" : " - 專線小巴";
                }
                let info = "<div style=\"text-align: center;\"><p style=\"font-weight: bold;\">[" + title + "] " + applyBbiStopHref(stopName) + " " + distanceStr + "</p></div>";

                let table =
                    "<div class=\"disable-scrollbars mobile-map-action-disable map-route-eta-table\" style=\"max-height: 400px; overflow-y: scroll;\">" +
                        "<table>" +
                            "<tbody>" +
                                routesInfo.join("") +
                            "</tbody>" +
                        "</table>" +
                    "</div>";

                let popUpWidth = window.innerWidth - 200;
                let location = stop["location"];
                L.marker([location["lat"], location["lng"]], {icon: orangeIcon}).addTo(nearbyStopsMarker).bindPopup(info + table, {maxWidth: popUpWidth})
                .on("mouseover", e => {
                    if (!isPopupMobile() && !isClicked) {
                        e.target.openPopup();
                    }
                }).on("mouseout", e => {
                    if (!isClicked) {
                        e.target.closePopup();
                    }
                }).on("click", e => {
                    isClicked = true; 
                    e.target.openPopup();
                    let offset = (0.001 * (e.target.getPopup().getElement().offsetHeight / 200) - (isPopupMobile() ? 0.001 : 0)) * Math.pow(Math.max(1, map.getZoom() - 17), -2);
                    map.flyTo([e.latlng.lat + offset, e.latlng.lng], Math.max(17, map.getZoom()), {"duration": 1});
                    updateEta();
                }).on("popupopen", (e) => {
                    updateEta(); 
                });
            }

            for (let stopId in allOtherStops) {
                let routes = allOtherStops[stopId].filter((value, index, array) => array.indexOf(value) === index);
                let stop = dataSheet["stopList"][stopId];
                let stopName = stop["name"][language == "en" ? "en" : "zh"];
                if (language == "en") {
                    stopName = capitalize(stopName);
                }

                let stopCo = /^[0-9]{6}$/g.test(stopId) ? "ctb" : (/^[0-9]{1,4}$/g.test(stopId) ? "nlb" : (/^[A-Z]?[0-9]{1,3}[A-Z]?-[A-Z][0-9]{3}$/.test(stopId) ? "mtr-bus" : (/^[0-9]{8}$/.test(stopId) ? "gmb" : "kmb")));
                let routesInfo = [];
                for (let i = 0; i < routes.length; i++) {
                    let route = routes[i];
                    let co = route["bound"].hasOwnProperty("kmb") ? "kmb" : (route["bound"].hasOwnProperty("ctb") ? "ctb" : (route["bound"].hasOwnProperty("nlb") ? "nlb" : (route["bound"].hasOwnProperty("mtr-bus") ? "mtr-bus" : "gmb")));
                    let routeNumber = route["route"];
                    let destName = route["dest"][language == "en" ? "en" : "zh"];
                    if (language == "en") {
                        destName = capitalize(destName);
                    }
                    let bound = co == "nlb" ? route["nlbId"] : route["bound"][co];

                    let routeNumberDisplay = getRouteNumberDisplay(co, routeNumber, {background: true});

                    let allStops = route["stops"][co];
                    let startStopId;
                    let lastIndex = -1;
                    for (let u = 0; u < nearbyStops.length; u++) {
                        let stop = nearbyStops[u]["stopId"];
                        let index = allStops.lastIndexOf(stop);
                        if (index >= 0 && index > lastIndex) {
                            startStopId = stop;
                            lastIndex = index;
                        }
                    }
                    let params = "'" + co + "','" + routeNumber + "','" + route["bound"][co] + "','" + route["serviceType"] + "','" + startStopId + "','" + stopId + "'";
                    if (co == "ctb" && route["stops"].hasOwnProperty("kmb")) {
                        let kmbAllStops = route["stops"]["kmb"];
                        params = "'kmb','" + routeNumber + "','" + route["bound"]["kmb"] + "','" + route["serviceType"] + "','" + kmbAllStops[allStops.indexOf(startStopId)] + "','" + kmbAllStops[allStops.indexOf(stopId)] + "'";
                    }

                    let table = 
                        "<tr class=\"nearby-stop\" style=\"cursor: pointer;\" onclick=\"handleNearbyRouteClick(" + params + ");\">" +
                            "<th><b style=\"font-size: 15px\">" + routeNumberDisplay + "</b></th>" +
                            "<th width=\"99%\" style=\"padding:0 5px 0 5px;\"><b style=\"font-size: 15px\"><span style=\"font-size: 10px\">往</span><span style=\"font-size: 15px\">" + destName + "</span></b></th>" +
                            "<th style=\"text-align: right;\"><span class=\"eta-update\" id=\"nearbymap_" + co + "," + stopId + "," + routeNumber + "," + bound + ",1,15,2\">⠀⠀⠀⠀⠀⠀⠀</span></th>" +
                        "</tr>";

                    routesInfo.push(table);
                }

                if (stopCo == "ctb") {
                    stopName += language == "en" ? " - CTB" : " - 城巴";
                } else if (stopCo == "nlb") {
                    stopName += language == "en" ? " - NLB" : " - 嶼巴";
                } else if (stopCo == "mtr-bus") {
                    stopName += language == "en" ? " - MTR-Bus" : " - 港鐵巴士";
                } else if (stopCo == "gmb") {
                    stopName += language == "en" ? " - GMB" : " - 專線小巴";
                }
                let info = "<div style=\"text-align: center;\"><p style=\"font-weight: bold;\">" + (language == "en" ? "[Nearby Route Stop]" : "[鄰近路線站]") + " " + applyBbiStopHref(stopName) + "</p></div>";

                let table =
                    "<div class=\"disable-scrollbars\" style=\"max-height: 400px; overflow-y: scroll;\">" +
                        "<table>" +
                            "<tbody>" +
                                routesInfo.join("") +
                            "</tbody>" +
                        "</table>" + 
                    "</div>";

                let popUpWidth = window.innerWidth - 200;
                let location = stop["location"];
                L.marker([location["lat"], location["lng"]], {icon: blackIcon}).addTo(nearbyLines).bindPopup(info + table, {maxWidth: popUpWidth})
                .on("mouseover", e => {
                    if (!isPopupMobile() && !isClicked) {
                        e.target.openPopup();
                    }
                }).on("mouseout", e => {
                    if (!isClicked) {
                        e.target.closePopup();
                    }
                }).on("click", e => {
                    isClicked = true; 
                    e.target.openPopup();
                    let offset = (0.001 * (e.target.getPopup().getElement().offsetHeight / 200) - (isPopupMobile() ? 0.001 : 0)) * Math.pow(Math.max(1, map.getZoom() - 17), -2);
                    map.flyTo([e.latlng.lat + offset, e.latlng.lng], Math.max(17, map.getZoom()), {"duration": 1});
                    updateEta();
                }).on("popupopen", (e) => {
                    updateEta();
                });
            }

            table += "</tbody></table>";

            document.getElementById("nearby-routes-content").innerHTML = table;
            document.getElementById("nearby-routes-content").style.display = "";

            updateEta();
        } finally {
            updatingRouteTasks.splice(updatingRouteTasks.indexOf(taskId), 1);
        }
    };
    const handleNearbyRouteClick = (co, routeNumber, bound, type, startingStop, endingStop) => {
        let index = 1;
        let shareLink = getShareLink();
        for (let i = 1; true; i++) {
            if (shareLink.indexOf("r" + i + "=") >= 0) {
                index = i + 1;
            } else {
                break;
            }
        }

        let link = shareLink + "&r" + index + "=" + co + "," + routeNumber + "," + bound + "," + type + "," + startingStop + "," + endingStop;
        window.location.href = link;
    };

    let openedLayerSelector = false;
    setInterval(() => {
        if (document.querySelector(".leaflet-control-layers-expanded")) {
            openedLayerSelector = true;
        } else if (openedLayerSelector) {
            setTimeout(() => {
                openedLayerSelector = false;
            }, 700);
        }
    }, 200);

    let _dblClickTimer = null;
    let droppedPin = null;
    const onMapClick = (e) => {
        if (_dblClickTimer !== null) {
            return;
        }
        _dblClickTimer = setTimeout(() => {
            try {
                if (openedLayerSelector) {
                    return;
                }
                if (dataSheet == null) {
                    return;
                }
                if (gpsMarker != null) {
                    return;
                }
                if (openPopups.length > 0) {
                    return;
                }
                if (droppedPin == null) {
                    document.getElementById("pin-remove").disabled = false;
                    droppedPin = new L.marker(e.latlng, {draggable:'true', bounceOnAdd: true, bounceOnAddOptions: {duration: 500, height: 50}}).on('click', (e) => {
                        map.panTo(e.latlng, {"duration": 1})
                    });
                    pin.addLayer(droppedPin);
                    droppedPin.on('dragend', (event) => {
                        droppedPin = event.target;
                        let position = droppedPin.getLatLng();
                        droppedPin.setLatLng(new L.LatLng(position.lat, position.lng), {draggable:'true'});
                        map.panTo(new L.LatLng(position.lat, position.lng), {"duration": 1});
                        updateNearestRoutes(position.lat, position.lng);

                        let shareLink = getShareLink();
                        window.history.replaceState(null, null, shareLink);
                        document.getElementById('language').href = getShareLink(true);
                    });
                } else {
                    droppedPin.setLatLng(e.latlng, {draggable:'true'});
                    droppedPin.bounce({duration: 500, height: 50});
                    let position = droppedPin.getLatLng();
                    map.panTo(new L.LatLng(position.lat, position.lng), {"duration": 1});
                }
                updateNearestRoutes(e.latlng.lat, e.latlng.lng);

                let shareLink = getShareLink();
                window.history.replaceState(null, null, shareLink);
                document.getElementById('language').href = getShareLink(true);
            } finally {
                _dblClickTimer = null;
            }
        }, 500);
    };
    map.on('click', onMapClick).on('dblclick', (e) => {
        clearTimeout(_dblClickTimer);
        _dblClickTimer = null;
    });

    const updateEta = () => {
        let collection = document.getElementsByClassName("eta-update");
        
        let stops = {};
        let ctbEntries = [];
        let nlbEntries = [];
        let mtrBusRoutes = {};
        let gmbStops = {};
        for (let i = 0; i < collection.length; i++) {
            let element = collection[i];
            let tag = element.id.substring(element.id.lastIndexOf("_") + 1);
            let matches = tag.split(",");
            let co = matches[0];
            let stopId = matches[1];
            let routeNumber = matches[2];
            let bound = matches[3];
            let seq = matches[4];
            let fontSize = matches[5];
            let noScheduledType = Number(matches[6]);

            if (co == "kmb") {
                if (stops.hasOwnProperty(stopId)) {
                    stops[stopId].push([element, stopId, routeNumber, bound, seq, fontSize, noScheduledType, co]);
                } else {
                    stops[stopId] = [[element, stopId, routeNumber, bound, seq, fontSize, noScheduledType, co]];
                }
            } else if (co == "ctb") {
                ctbEntries.push([element, stopId, routeNumber, bound, seq, fontSize, noScheduledType, co]);
            } else if (co == "nlb") {
                nlbEntries.push([element, stopId, routeNumber, bound, seq, fontSize, noScheduledType, co]);
            } else if (co == "mtr-bus") {
                if (mtrBusRoutes.hasOwnProperty(routeNumber)) {
                    mtrBusRoutes[routeNumber].push([element, stopId, routeNumber, bound, seq, fontSize, noScheduledType, co]);
                } else {
                    mtrBusRoutes[routeNumber] = [[element, stopId, routeNumber, bound, seq, fontSize, noScheduledType, co]];
                }
            } else if (co == "gmb") {
                if (gmbStops.hasOwnProperty(stopId)) {
                    gmbStops[stopId].push([element, stopId, routeNumber, bound, seq, fontSize, noScheduledType, co]);
                } else {
                    gmbStops[stopId] = [[element, stopId, routeNumber, bound, seq, fontSize, noScheduledType, co]];
                }
            }
        }

        for (let stopId in gmbStops) {
            let list = gmbStops[stopId];
            let resolvedStopEtaUrl = gmbStopEtaUrl.replace("{stop}", stopId);
            getJSON(resolvedStopEtaUrl, (err, data) => {
                if (err == null) {
                    for (let m = 0; m < list.length; m++) {
                        let entry = list[m];
                        let elementRouteNumber = entry[2];
                        let elementBound = entry[3];
                        let elementSeq = entry[4];
                        let elementFontSize = entry[5];
                        let elementScheduledType = entry[6];
                        if (elementSeq == 1) {
                            if (language == "en") {
                                entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>No scheduled departures at this moment";
                            } else {
                                entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>暫時沒有預定班次";
                            }
                        } else {
                            entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>-";
                        }
                    }

                    for (let i = 0; i < data["data"].length; i++) {
                        let routeData = data["data"][i];
                        let buses = routeData["eta"];
                        let filteredEntry = Object.entries(dataSheet["routeList"]).filter(r => r[1]["bound"].hasOwnProperty("gmb") && r[1]["gtfsId"] == routeData["route_id"])[0];
                        if (filteredEntry != undefined && buses != undefined) {
                            let routeNumber = filteredEntry[1]["route"];
                            for (let u = 0; u < buses.length; u++) {
                                let bus = buses[u];
                                let seq = bus["eta_seq"];
                                let eta = bus["timestamp"];
                                let remark = language == "en" ? bus["remarks_en"] : bus["remarks_tc"];
                                if (remark == null) {
                                    remark = "";
                                }

                                let mins = eta == null ? -999 : Math.round((new Date(eta) - new Date()) / 1000 / 60);
                                
                                for (let m = 0; m < list.length; m++) {
                                    let entry = list[m];
                                    let elementRouteNumber = entry[2];
                                    let elementSeq = entry[4];
                                    let elementFontSize = entry[5];
                                    let elementScheduledType = entry[6];

                                    if (elementRouteNumber == routeNumber) {
                                        let message = "";
                                        if (language == "en") {
                                            if (mins > 0) {
                                                message = (elementScheduledType == 2 ? "<span style=\"white-space: nowrap\">" : "") + "<b style=\"font-size: " + elementFontSize + "px;\">" + mins + "</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " Min." + (elementScheduledType == 2 ? "</span>" : "");
                                            } else if (mins > -60) {
                                                message = (elementScheduledType == 2 ? "<span style=\"white-space: nowrap\">" : "") + "<b style=\"font-size: " + elementFontSize + "px;\">-</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " Min." + (elementScheduledType == 2 ? "</span>" : "");
                                            }
                                            if (remark != "" && elementScheduledType != 2) {
                                                if (elementScheduledType > 0) {
                                                    message += (message == "" ? remark : " <br class=\"div-only-mobile\"><span class=\"div-only-mobile\" style=\"font-size: 12px\">(" + remark + ")</span><span class=\"desk\">(" + remark + ")</span>");
                                                } else {
                                                    message += (message == "" ? remark : " (" + remark + ")");
                                                }
                                            }
                                        } else {
                                            if (mins > 0) {
                                                message = "<span style=\"white-space: nowrap;\"><b style=\"font-size: " + elementFontSize + "px;\">" + mins + "</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " <span style=\"word-break: keep-all;\">分鐘</span></span>";
                                            } else if (mins > -60) {
                                                message = "<span style=\"white-space: nowrap;\"><b style=\"font-size: " + elementFontSize + "px;\">-</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " <span style=\"word-break: keep-all;\">分鐘</span></span>";
                                            }
                                            if (remark != "" && elementScheduledType != 2) {
                                                if (elementScheduledType > 0) {
                                                    message += (message == "" ? remark : " <br class=\"div-only-mobile\"><span class=\"div-only-mobile\" style=\"font-size: 12px\">(" + remark + ")</span><span class=\"desk\">(" + remark + ")</span>");
                                                } else {
                                                    message += (message == "" ? remark : " (" + remark + ")");
                                                }
                                            }
                                        }
                                        message = message
                                            .replaceAll("原定", "預定")
                                            .replaceAll("最後班次", "尾班車")
                                            .replaceAll("尾班車已過", "尾班車已過本站");

                                        if (message == "") {
                                            if (elementSeq == 1) {
                                                if (language == "en") {
                                                    entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>No scheduled departures at this moment";
                                                } else {
                                                    entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>暫時沒有預定班次";
                                                }
                                            } else {
                                                entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>-";
                                            }
                                        } else if (elementSeq == seq) {
                                            entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>" + message;
                                        } else if (elementSeq > seq) {
                                            entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>-";
                                        }
                                    }
                                }
                            }
                        }
                    }
                } else {
                    printConnectionError("Unable to get response from " + resolvedStopEtaUrl + ". (Is it down?)");
                }
            });
        }

        for (let routeNumber in mtrBusRoutes) {
            let list = mtrBusRoutes[routeNumber];
            postJSON(mtrBusRouteEtaUrl, {"language": language, "routeName": routeNumber}, (err, data) => {
                if (err == null) {
                    for (let m = 0; m < list.length; m++) {
                        let entry = list[m];
                        let elementRouteNumber = entry[2];
                        let elementBound = entry[3];
                        let elementSeq = entry[4];
                        let elementFontSize = entry[5];
                        let elementScheduledType = entry[6];
                        if (elementSeq == 1) {
                            if (language == "en") {
                                entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>No scheduled departures at this moment";
                            } else {
                                entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>暫時沒有預定班次";
                            }
                        } else {
                            entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>-";
                        }
                    }

                    let busStops = data["busStop"];
                    for (let k = 0; k < busStops.length; k++) {
                        let busStop = busStops[k];
                        let buses = busStop["bus"];
                        let stopId = busStop["busStopId"];
                        for (let u = 0; u < buses.length; u++) {
                            let bus = buses[u];
                            let seq = u + 1;
                            let eta = Number(bus["arrivalTimeInSecond"]);
                            if (eta >= 108000) {
                                eta = Number(bus["departureTimeInSecond"]);
                            }
                            let remark = bus["busRemark"] == null ? "" : bus["busRemark"];
                            let isScheduled = bus["isScheduled"] == "1";
                            if (isScheduled) {
                                if (remark != "") {
                                    remark += "/";
                                }
                                remark += language == "en" ? "Scheduled Bus" : "預定班次";
                            }
                            let isDelayed = bus["isDelayed"] == "1";
                            if (isDelayed) {
                                if (remark != "") {
                                    remark += "/";
                                }
                                remark += language == "en" ? "Bus Delayed" : "行車緩慢";
                            }

                            let mins = eta == null ? -999 : Math.floor(eta / 60);
                            
                            for (let m = 0; m < list.length; m++) {
                                let entry = list[m];
                                let elementStopId = entry[1];
                                let elementRouteNumber = entry[2];
                                let elementSeq = entry[4];
                                let elementFontSize = entry[5];
                                let elementScheduledType = entry[6];

                                if (elementRouteNumber == routeNumber && mtrBusStopAliasList[elementStopId].indexOf(stopId) >= 0) {
                                    let message = "";
                                    if (language == "en") {
                                        if (mins > 0) {
                                            message = (elementScheduledType == 2 ? "<span style=\"white-space: nowrap\">" : "") + "<b style=\"font-size: " + elementFontSize + "px;\">" + mins + "</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " Min." + (elementScheduledType == 2 ? "</span>" : "");
                                        } else if (mins > -60) {
                                            message = (elementScheduledType == 2 ? "<span style=\"white-space: nowrap\">" : "") + "<b style=\"font-size: " + elementFontSize + "px;\">-</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " Min." + (elementScheduledType == 2 ? "</span>" : "");
                                        }
                                        if (remark != "" && elementScheduledType != 2) {
                                            if (elementScheduledType > 0) {
                                                message += (message == "" ? remark : " <br class=\"div-only-mobile\"><span class=\"div-only-mobile\" style=\"font-size: 12px\">(" + remark + ")</span><span class=\"desk\">(" + remark + ")</span>");
                                            } else {
                                                message += (message == "" ? remark : " (" + remark + ")");
                                            }
                                        }
                                    } else {
                                        if (mins > 0) {
                                            message = "<span style=\"white-space: nowrap;\"><b style=\"font-size: " + elementFontSize + "px;\">" + mins + "</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " <span style=\"word-break: keep-all;\">分鐘</span></span>";
                                        } else if (mins > -60) {
                                            message = "<span style=\"white-space: nowrap;\"><b style=\"font-size: " + elementFontSize + "px;\">-</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " <span style=\"word-break: keep-all;\">分鐘</span></span>";
                                        }
                                        if (remark != "" && elementScheduledType != 2) {
                                            if (elementScheduledType > 0) {
                                                message += (message == "" ? remark : " <br class=\"div-only-mobile\"><span class=\"div-only-mobile\" style=\"font-size: 12px\">(" + remark + ")</span><span class=\"desk\">(" + remark + ")</span>");
                                            } else {
                                                message += (message == "" ? remark : " (" + remark + ")");
                                            }
                                        }
                                    }
                                    message = message
                                        .replaceAll("原定", "預定")
                                        .replaceAll("最後班次", "尾班車")
                                        .replaceAll("尾班車已過", "尾班車已過本站");

                                    if (message == "") {
                                        if (elementSeq == 1) {
                                            if (language == "en") {
                                                entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>No scheduled departures at this moment";
                                            } else {
                                                entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>暫時沒有預定班次";
                                            }
                                        } else {
                                            entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>-";
                                        }
                                    } else if (elementSeq == seq) {
                                        entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>" + message;
                                    } else if (elementSeq > seq) {
                                        entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>-";
                                    }
                                }
                            }
                        }
                    }
                } else {
                    printConnectionError("Unable to get response from " + mtrBusRouteEtaUrl + ". (Is it down?)");
                }
            });
        }

        for (let i = 0; i < nlbEntries.length; i++) {
            let entry = nlbEntries[i];
            let stopId = entry[1];
            let routeNumber = entry[2];
            let routeId = entry[3];
            let resolvedStopEtaUrl = nlbStopRouteEtaUrl.replace("{stop}", stopId).replace("{route}", routeId).replace("{lang}", language);
            getJSON(resolvedStopEtaUrl, (err, data) => {
                if (err == null) {
                    let elementRouteNumber = entry[2];
                    let elementBound = entry[3];
                    let elementSeq = entry[4];
                    let elementFontSize = entry[5];
                    let elementScheduledType = entry[6];

                    if (elementSeq == 1) {
                        if (language == "en") {
                            entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>No scheduled departures at this moment";
                        } else {
                            entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>暫時沒有預定班次";
                        }
                    } else {
                        entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>-";
                    }

                    if (Object.keys(data) == 0 || !data.hasOwnProperty("estimatedArrivals")) {
                        return;
                    }
                    let buses = data["estimatedArrivals"];
                    for (let u = 0; u < buses.length; u++) {
                        let bus = buses[u];
                        let seq = u + 1;
                        let eta = bus["estimatedArrivalTime"] + "+08:00";
                        let variant = bus["routeVariantName"].trim();

                        let mins = eta == null ? -999 : Math.round((new Date(eta) - new Date()) / 1000 / 60);

                        if (elementRouteNumber == routeNumber) {
                            let message = "";
                            if (language == "en") {
                                if (mins > 0) {
                                    message = (elementScheduledType == 2 ? "<span style=\"white-space: nowrap\">" : "") + "<b style=\"font-size: " + elementFontSize + "px;\">" + mins + "</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " Min." + (elementScheduledType == 2 ? "</span>" : "");
                                } else if (mins > -60) {
                                    message = (elementScheduledType == 2 ? "<span style=\"white-space: nowrap\">" : "") + "<b style=\"font-size: " + elementFontSize + "px;\">-</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " Min." + (elementScheduledType == 2 ? "</span>" : "");
                                }
                                if (variant != "" && elementScheduledType != 2) {
                                    if (elementScheduledType > 0) {
                                        message += (message == "" ? variant : " <br class=\"div-only-mobile\"><span class=\"div-only-mobile\" style=\"font-size: 12px\">(" + variant + ")</span><span class=\"desk\">(" + variant + ")</span>");
                                    } else {
                                        message += (message == "" ? variant : " (" + variant + ")");
                                    }
                                }
                            } else {
                                if (mins > 0) {
                                    message = "<span style=\"white-space: nowrap;\"><b style=\"font-size: " + elementFontSize + "px;\">" + mins + "</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " <span style=\"word-break: keep-all;\">分鐘</span></span>";
                                } else if (mins > -60) {
                                    message = "<span style=\"white-space: nowrap;\"><b style=\"font-size: " + elementFontSize + "px;\">-</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " <span style=\"word-break: keep-all;\">分鐘</span></span>";
                                }
                                if (variant != "" && elementScheduledType != 2) {
                                    if (elementScheduledType > 0) {
                                        message += (message == "" ? variant : " <br class=\"div-only-mobile\"><span class=\"div-only-mobile\" style=\"font-size: 12px\">(" + variant + ")</span><span class=\"desk\">(" + variant + ")</span>");
                                    } else {
                                        message += (message == "" ? variant : " (" + variant + ")");
                                    }
                                }
                            }

                            if (message == "") {
                                if (elementSeq == 1) {
                                    if (language == "en") {
                                        entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>No scheduled departures at this moment";
                                    } else {
                                        entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>暫時沒有預定班次";
                                    }
                                } else {
                                    entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>-";
                                }
                            } else if (elementSeq == seq) {
                                entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>" + message;
                            } else if (elementSeq > seq) {
                                entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>-";
                            }
                        }
                    }
                } else {
                    printConnectionError("Unable to get response from " + resolvedStopEtaUrl + ". (Is it down?)");
                }
            });
        }

        for (let i = 0; i < ctbEntries.length; i++) {
            let entry = ctbEntries[i];
            let stopId = entry[1];
            let routeNumber = entry[2];
            let resolvedStopEtaUrl = ctbStopEtaUrl.replace("{stop}", stopId).replace("{route}", routeNumber);
            getJSON(resolvedStopEtaUrl, (err, data) => {
                if (err == null) {
                    let elementRouteNumber = entry[2];
                    let elementBound = entry[3];
                    let elementSeq = entry[4];
                    let elementFontSize = entry[5];
                    let elementScheduledType = entry[6];

                    if (elementSeq == 1) {
                        if (language == "en") {
                            entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>No scheduled departures at this moment";
                        } else {
                            entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>暫時沒有預定班次";
                        }
                    } else {
                        entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>-";
                    }

                    let buses = data["data"];
                    for (let u = 0; u < buses.length; u++) {
                        let bus = buses[u];
                        if (bus["co"] == "CTB") {
                            let routeNumber = bus["route"];
                            let bound = bus["dir"];
                            let seq = bus["eta_seq"];
                            let eta = bus["eta"];

                            let mins = eta == null ? -999 : Math.round((new Date(eta) - new Date()) / 1000 / 60);

                            if (elementRouteNumber == routeNumber && elementBound == bound) {
                                let message = "";
                                if (language == "en") {
                                    if (mins > 0) {
                                        message = (elementScheduledType == 2 ? "<span style=\"white-space: nowrap\">" : "") + "<b style=\"font-size: " + elementFontSize + "px;\">" + mins + "</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " Min." + (elementScheduledType == 2 ? "</span>" : "");
                                    } else if (mins > -60) {
                                        message = (elementScheduledType == 2 ? "<span style=\"white-space: nowrap\">" : "") + "<b style=\"font-size: " + elementFontSize + "px;\">-</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " Min." + (elementScheduledType == 2 ? "</span>" : "");
                                    }
                                    if (bus["rmk_en"] != "" && elementScheduledType != 2) {
                                        if (elementScheduledType > 0) {
                                            message += (message == "" ? bus["rmk_en"] : " <br class=\"div-only-mobile\"><span class=\"div-only-mobile\" style=\"font-size: 12px\">(" + bus["rmk_en"] + ")</span><span class=\"desk\">(" + bus["rmk_en"] + ")</span>");
                                        } else {
                                            message += (message == "" ? bus["rmk_en"] : " (" + bus["rmk_en"] + ")");
                                        }
                                    }
                                } else {
                                    if (mins > 0) {
                                        message = "<span style=\"white-space: nowrap;\"><b style=\"font-size: " + elementFontSize + "px;\">" + mins + "</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " <span style=\"word-break: keep-all;\">分鐘</span></span>";
                                    } else if (mins > -60) {
                                        message = "<span style=\"white-space: nowrap;\"><b style=\"font-size: " + elementFontSize + "px;\">-</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " <span style=\"word-break: keep-all;\">分鐘</span></span>";
                                    }
                                    if (bus["rmk_tc"] != "" && elementScheduledType != 2) {
                                        if (elementScheduledType > 0) {
                                            message += (message == "" ? bus["rmk_tc"] : " <br class=\"div-only-mobile\"><span class=\"div-only-mobile\" style=\"font-size: 12px\">(" + bus["rmk_tc"] + ")</span><span class=\"desk\">(" + bus["rmk_tc"] + ")</span>");
                                        } else {
                                            message += (message == "" ? bus["rmk_tc"] : " (" + bus["rmk_tc"] + ")");
                                        }
                                    }
                                }
                                message = message
                                    .replaceAll("原定", "預定")
                                    .replaceAll("最後班次", "尾班車")
                                    .replaceAll("尾班車已過", "尾班車已過本站");

                                if (message == "") {
                                    if (elementSeq == 1) {
                                        if (language == "en") {
                                            entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>No scheduled departures at this moment";
                                        } else {
                                            entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>暫時沒有預定班次";
                                        }
                                    } else {
                                        entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>-";
                                    }
                                } else if (elementSeq == seq) {
                                    entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>" + message;
                                } else if (elementSeq > seq) {
                                    entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>-";
                                }
                            }
                        }
                    }
                } else {
                    printConnectionError("Unable to get response from " + resolvedStopEtaUrl + ". (Is it down?)");
                }
            });
        }

        for (let stopId in stops) {
            let list = stops[stopId];
            let resolvedStopEtaUrl = kmbStopEtaUrl.replace("{stop}", stopId);
            getJSON(resolvedStopEtaUrl, (err, data) => {
                if (err == null) {
                    for (let m = 0; m < list.length; m++) {
                        let entry = list[m];
                        let elementRouteNumber = entry[2];
                        let elementBound = entry[3];
                        let elementSeq = entry[4];
                        let elementFontSize = entry[5];
                        let elementScheduledType = entry[6];
                        if (elementSeq == 1) {
                            if (language == "en") {
                                entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>No scheduled departures at this moment";
                            } else {
                                entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>暫時沒有預定班次";
                            }
                        } else {
                            entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>-";
                        }
                    }

                    let buses = data["data"];
                    for (let u = 0; u < buses.length; u++) {
                        let bus = buses[u];
                        if (bus["co"] == "KMB") {
                            let routeNumber = bus["route"];
                            let bound = bus["dir"];
                            let seq = bus["eta_seq"];
                            let eta = bus["eta"];

                            let mins = eta == null ? -999 : Math.round((new Date(eta) - new Date()) / 1000 / 60);
                            
                            for (let m = 0; m < list.length; m++) {
                                let entry = list[m];
                                let elementRouteNumber = entry[2];
                                let elementBound = entry[3];
                                let elementSeq = entry[4];
                                let elementFontSize = entry[5];
                                let elementScheduledType = entry[6];

                                if (elementRouteNumber == routeNumber && elementBound == bound) {
                                    let message = "";
                                    if (language == "en") {
                                        if (mins > 0) {
                                            message = (elementScheduledType == 2 ? "<span style=\"white-space: nowrap\">" : "") + "<b style=\"font-size: " + elementFontSize + "px;\">" + mins + "</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " Min." + (elementScheduledType == 2 ? "</span>" : "");
                                        } else if (mins > -60) {
                                            message = (elementScheduledType == 2 ? "<span style=\"white-space: nowrap\">" : "") + "<b style=\"font-size: " + elementFontSize + "px;\">-</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " Min." + (elementScheduledType == 2 ? "</span>" : "");
                                        }
                                        if (bus["rmk_en"] != "" && elementScheduledType != 2) {
                                            if (elementScheduledType > 0) {
                                                message += (message == "" ? bus["rmk_en"] : " <br class=\"div-only-mobile\"><span class=\"div-only-mobile\" style=\"font-size: 12px\">(" + bus["rmk_en"] + ")</span><span class=\"desk\">(" + bus["rmk_en"] + ")</span>");
                                            } else {
                                                message += (message == "" ? bus["rmk_en"] : " (" + bus["rmk_en"] + ")");
                                            }
                                        }
                                    } else {
                                        if (mins > 0) {
                                            message = "<span style=\"white-space: nowrap;\"><b style=\"font-size: " + elementFontSize + "px;\">" + mins + "</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " <span style=\"word-break: keep-all;\">分鐘</span></span>";
                                        } else if (mins > -60) {
                                            message = "<span style=\"white-space: nowrap;\"><b style=\"font-size: " + elementFontSize + "px;\">-</b>" + (elementScheduledType == 1 ? "<br class=\"div-only-mobile\">" : "") + " <span style=\"word-break: keep-all;\">分鐘</span></span>";
                                        }
                                        if (bus["rmk_tc"] != "" && elementScheduledType != 2) {
                                            if (elementScheduledType > 0) {
                                                message += (message == "" ? bus["rmk_tc"] : " <br class=\"div-only-mobile\"><span class=\"div-only-mobile\" style=\"font-size: 12px\">(" + bus["rmk_tc"] + ")</span><span class=\"desk\">(" + bus["rmk_tc"] + ")</span>");
                                            } else {
                                                message += (message == "" ? bus["rmk_tc"] : " (" + bus["rmk_tc"] + ")");
                                            }
                                        }
                                    }
                                    message = message
                                        .replaceAll("原定", "預定")
                                        .replaceAll("最後班次", "尾班車")
                                        .replaceAll("尾班車已過", "尾班車已過本站");

                                    if (message == "") {
                                        if (elementSeq == 1) {
                                            if (language == "en") {
                                                entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>No scheduled departures at this moment";
                                            } else {
                                                entry[0].innerHTML = elementScheduledType > 0 ? "<i class=\"material-icons\" style=\"font-size: " + elementFontSize + "px; vertical-align: -12%;\">schedule</i>" : "<b style=\"font-size: " + elementFontSize + "px;\"></b>暫時沒有預定班次";
                                            }
                                        } else {
                                            entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>-";
                                        }
                                    } else if (elementSeq == seq) {
                                        entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>" + message;
                                    } else if (elementSeq > seq) {
                                        entry[0].innerHTML = "<b style=\"font-size: " + elementFontSize + "px;\"></b>-";
                                    }
                                }
                            }
                        }
                    }
                } else {
                    printConnectionError("Unable to get response from " + resolvedStopEtaUrl + ". (Is it down?)");
                }
            });
        }
    };

    setInterval(updateEta, 15000);

    const kmbRouteExists = (route) => {
        for (let i = 0; i < kmbRouteList.length; i++) {
            let kmbRoute = kmbRouteList[i];
            if (route["route"] == kmbRoute["route"] && route["bound"]["kmb"] == kmbRoute["bound"] && route["serviceType"] == kmbRoute["service_type"] && route["orig"]["zh"].replaceAll("／", "/") == kmbRoute["orig_tc"].replaceAll("／", "/") && route["dest"]["zh"].replaceAll("／", "/") == kmbRoute["dest_tc"].replaceAll("／", "/")) {
                return true;
            }
        }
        return false;
    };
    const matchTwoWaySectionFareStop = (stops, name, invert = false) => {
        name = name.replaceAll("巿", "市");
        let task = (i) => {
            let stop = stops[i].replaceAll("巿", "市");
            if (stop.toUpperCase() == name.toUpperCase()) {
                return i;
            } else if (stop.toUpperCase().includes(name.toUpperCase())) {
                return i;
            } else {
                let normalizedStop = stop.toUpperCase().replaceAll("轉車站", "").replaceAll("(", "").replaceAll(")", "").trim();
                let normalizedName = name.toUpperCase().replaceAll("輕鐵", "").replaceAll("邨", "").replaceAll("落馬洲", "新田運輸交匯處").replaceAll("(", "").replaceAll(")", "").trim();
                let area = regionalTwoWaySectionFare["area"];
                let areaStripped = normalizedName;
                for (let u = 0; u < area.length; u++) {
                    areaStripped = areaStripped.replaceAll(area[u], "").trim();
                }
                if (areaStripped.length > 1) {
                    normalizedName = areaStripped;
                } else {
                    normalizedName = normalizedName.replaceAll(areaStripped, "");
                }
                if (normalizedStop.includes(normalizedName)) {
                    return i;
                }
            }
            return -1;
        };

        if (invert) {
            for (let i = stops.length - 1; i >= 0; i--) {
                if (task(i) >= 0) {
                    return i;
                }
            }
        } else {
            for (let i = 0; i < stops.length; i++) {
                if (task(i) >= 0) {
                    return i;
                }
            }
        }
        return -1;
    };
    const checkTwoWaySectionFare = (routeNumber, stops, startingName, endingName) => {
        let routes = regionalTwoWaySectionFare["routes"];
        let result = null;
        let fare = -1000;
        for (let i = 0; i < routes.length; i++) {
            let data = routes[i];
            if (data["route_number"] == routeNumber) {
                let sectionStartIndex = matchTwoWaySectionFareStop(stops, data["start"]);
                let sectionEndIndex = matchTwoWaySectionFareStop(stops, data["end"], true);
                if (sectionStartIndex >= 0 && sectionEndIndex >= 0 && sectionStartIndex < sectionEndIndex && stops.indexOf(startingName) >= sectionStartIndex && stops.indexOf(endingName) <= sectionEndIndex) {
                    if (fare <= -999 || fare > data["fare"]) {
                        result = [sectionStartIndex, sectionEndIndex, data["fare"]];
                        fare = data["fare"];
                    }
                }
            }
        }
        return result;
    };
    const stopIdsToNames = (stops, lang = "zh") => {
        let names = [];
        for (let i = 0; i < stops.length; i++) {
            let stop = dataSheet["stopList"][stops[i]];
            let name = lang == "en" ? capitalize(stop["name"]["en"]) : stop["name"]["zh"];
            names.push(name);
        }
        return names;
    };
    const stopIdsToDetails = (stops) => {
        let stopDetails = [];
        for (let i = 0; i < stops.length; i++) {
            let stop = dataSheet["stopList"][stops[i]];
            stopDetails.push([stops[i], stop]);
        }
        return stopDetails;
    };
    const EARTH_RADIUS = 6371; // KM
    const toRadians = (angle) => {
        return (angle * Math.PI) / 180;
    };
    const findDistance = (location, other) => {
        const lat1 = toRadians(Number(location["lat"]));
        const lat2 = toRadians(Number(other["lat"]));
        const lng1 = toRadians(Number(location["lng"]));
        const lng2 = toRadians(Number(other["lng"]));

        const d_lon = lng2 - lng1;
        const d_lat = lat2 - lat1;
        const a = Math.sin(d_lat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(d_lon / 2) ** 2;

        const c = 2 * Math.asin(Math.sqrt(a));

        return c * EARTH_RADIUS;
    };
    const findInterchangeStop = (stops1, stops2) => {
        let result = null;
        for (let i = 0; i < stops1.length; i++) {
            let stop1Location = stops1[i][1]["location"];
            for (let u = stops2.length - 1; u >= 0; u--) {
                let stop2Location = stops2[u][1]["location"];
                let distance = findDistance(stop1Location, stop2Location);
                //console.log(stops1[i][1]["name"]["zh"] + " " + stops2[u][1]["name"]["zh"] + " " + distance);
                if (result == null || result[2] > distance) {
                    result = [stops1[i][0], stops2[u][0], distance];
                }
            }
        }
        return result;
    };
    const findCloestStop = (cloestTo, stops) => {
        let result = null;
        let stop1Location = cloestTo[1]["location"];
        for (let u = stops.length - 1; u >= 0; u--) {
            let stop2Location = stops[u][1]["location"];
            let distance = findDistance(stop1Location, stop2Location);
            //console.log(cloestTo[1]["name"]["zh"] + " " + stops[u][1]["name"]["zh"] + " " + distance);
            if (result == null || result[1] > distance) {
                result = [stops[u][0], distance];
            }
        }
        return result;
    };
    const valueExists = (value, selectElement) => {
        for (let i = 0; i < selectElement.options.length; i++) {
            if (selectElement.options[i].value == value) {
                return true;
            }
        }
        return false;
    };
    const hasRouteStartWith = (str) => {
        for (let key in dataSheet["routeList"]) {
            if (dataSheet["routeList"][key]["route"].startsWith(str)) {
                return true;
            }
        }
        return false;
    };

    const updateRoutes = () => {
        let collection = document.getElementsByClassName("route-input-element");
        if (collection.length == 0) {
            return;
        }
        for (let i = 0; i < collection.length; i++) {
            let leg = i + 1;
            let routeNumber = document.getElementById('route-' + leg).value.toUpperCase();
            document.getElementById('route-' + leg).value = routeNumber;
            while (!hasRouteStartWith(routeNumber)) {
                routeNumber = routeNumber.substring(0, routeNumber.length - 1);
                document.getElementById('route-' + leg).value = routeNumber;
            }
            let routes = [];

            for (let key in dataSheet["routeList"]) {
                let data = dataSheet["routeList"][key];
                if (data["route"] == routeNumber && ((data["bound"].hasOwnProperty("kmb") && kmbRouteExists(data)) || data["bound"].hasOwnProperty("ctb") || data["bound"].hasOwnProperty("nlb") || data["bound"].hasOwnProperty("mtr-bus") || data["bound"].hasOwnProperty("gmb"))) {
                    routes.push([key, data]);
                }
            }
            let lastSelected = document.getElementById('route-' + leg + '-type').selectedIndex;
            removeOptions(document.getElementById('route-' + leg + '-type'));

            routes.sort((a, b) => {
                let coAStr = a[1]["bound"].hasOwnProperty("kmb") ? "kmb" : (a[1]["bound"].hasOwnProperty("ctb") ? "ctb" : (a[1]["bound"].hasOwnProperty("nlb") ? "nlb" : (a[1]["bound"].hasOwnProperty("mtr-bus") ? "mtr-bus" : "gmb")));
                let coBStr = b[1]["bound"].hasOwnProperty("kmb") ? "kmb" : (b[1]["bound"].hasOwnProperty("ctb") ? "ctb" : (b[1]["bound"].hasOwnProperty("nlb") ? "nlb" : (b[1]["bound"].hasOwnProperty("mtr-bus") ? "mtr-bus" : "gmb")));
                let coA = coAStr == "kmb" ? 0 : (coAStr == "ctb" ? 1 : (coAStr == "nlb" ? 2 : (coAStr == "mtr-bus" ? 3 : 4)));
                let coB = coBStr == "kmb" ? 0 : (coBStr == "ctb" ? 1 : (coBStr == "nlb" ? 2 : (coBStr == "mtr-bus" ? 3 : 4)));
                if (coA != coB) {
                    return coA - coB;
                }
                if (coA == 2) {
                    return Number(a[1]["nlbId"]) - Number(b[1]["nlbId"]);
                } else {
                    if (coA == 4) {
                        let gtfsDiff = Number(a[1]["gtfsId"]) - Number(b[1]["gtfsId"]);
                        if (gtfsDiff != 0) {
                            return gtfsDiff;
                        }
                    }
                    let typeDiff = Number(a[1]["serviceType"]) - Number(b[1]["serviceType"]);
                    if (typeDiff == 0) {
                        if (coA == 1) {
                            return a[1].hasOwnProperty("ctbSpecial") - b[1].hasOwnProperty("ctbSpecial");
                        }
                        return -a[1]["bound"][coAStr].localeCompare(b[1]["bound"][coBStr]);
                    } else {
                        return typeDiff;
                    }
                }
            });
            let lastCo = null;
            let sepCounter = -2;
            for (let u = 0; u < routes.length; u++) {
                let route = routes[u][1];
                let co = route["bound"].hasOwnProperty("kmb") ? "kmb" : (route["bound"].hasOwnProperty("ctb") ? "ctb" : (route["bound"].hasOwnProperty("nlb") ? "nlb" : (route["bound"].hasOwnProperty("mtr-bus") ? "mtr-bus" : "gmb")));
                let bound = co == "nlb" ? route["nlbId"] : route["bound"][co];
                let type = route["serviceType"];
                let name = language == "en" ? "To " + capitalize(route["dest"]["en"]) : "往" + route["dest"]["zh"];
                if (route.hasOwnProperty("ctbCircularDests")) {
                    let circularDests = route["ctbCircularDests"].map(e => e[language]).join(", ");
                    if (language == "en") {
                        name += " (" + circularDests + " Circular)";
                    } else {
                        name += " (" + circularDests + " 循環線)";
                    }
                }
                if (co == "nlb") {
                    let mainRoute = null;
                    let currentNlbId = 9999;
                    for (let k = 0; k < routes.length; k++) {
                        let data = routes[k][1];
                        if (data["bound"].hasOwnProperty(co) && data["serviceType"] == 1) {
                            let nlbId = Number(data["nlbId"]);
                            if (nlbId < currentNlbId && (data["orig"]["zh"] == route["orig"]["zh"] || data["dest"]["zh"] == route["dest"]["zh"])) {
                                currentNlbId = nlbId;
                                mainRoute = data;
                            }
                        }
                    }
                    if (mainRoute != null && mainRoute != route) {
                        if (mainRoute["dest"]["zh"] != route["dest"]["zh"]) {
                            if (language == "en") {
                                name += " - Special To " + capitalize(route["dest"]["en"]);
                            } else {
                                name += " - 特別班 開往" + route["dest"]["zh"];
                            }
                        } else if (mainRoute["orig"]["zh"] != route["orig"]["zh"]) {
                            if (language == "en") {
                                name += " - Special From " + capitalize(route["orig"]["en"]);
                            } else {
                                name += " - 特別班 從" + route["orig"]["zh"] + "開出";
                            }
                        } else {
                            let mainRouteFirstStop = dataSheet["stopList"][mainRoute["stops"][co][0]]["name"];
                            let mainRouteLastStop = dataSheet["stopList"][mainRoute["stops"][co][mainRoute["stops"][co].length - 1]]["name"];
                            let routeFirstStop = dataSheet["stopList"][route["stops"][co][0]]["name"];
                            let routeLastStop = dataSheet["stopList"][route["stops"][co][route["stops"][co].length - 1]]["name"];

                            if (mainRouteLastStop["zh"] != routeLastStop["zh"]) {
                                if (language == "en") {
                                    name += " - Special To " + capitalize(routeLastStop["en"]);
                                } else {
                                    name += " - 特別班 開往" + routeLastStop["zh"];
                                }
                            } else if (mainRouteFirstStop["zh"] != routeFirstStop["zh"]) {
                                if (language == "en") {
                                    name += " - Special From " + capitalize(routeFirstStop["en"]);
                                } else {
                                    name += " - 特別班 從" + routeFirstStop["zh"] + "開出";
                                }
                            } else {
                                let difference = route["stops"][co]
                                    .filter(x => !mainRoute["stops"][co].includes(x))
                                    .map(x => dataSheet["stopList"][x]["name"][language]);
                                if (difference.length > 0) {
                                    let differenceStr = difference.join(", ");
                                    if (language == "en") {
                                        name += " - Special Via " + differenceStr;
                                    } else {
                                        name += " - 特別班 經" + differenceStr;
                                    }
                                } else {
                                    difference = mainRoute["stops"][co]
                                        .filter(x => !route["stops"][co].includes(x))
                                        .map(x => dataSheet["stopList"][x]["name"][language]);
                                    if (difference.length > 0) {
                                        let differenceStr = difference.join(", ");
                                        if (language == "en") {
                                            name += " - Special Skipping " + differenceStr;
                                        } else {
                                            name += " - 特別班 不經" + differenceStr;
                                        }
                                    } else {
                                        if (language == "en") {
                                            name += " - Special";
                                        } else {
                                            name += " - 特別班";
                                        }
                                    }
                                }
                            }
                        }
                    }
                } else if (type != 1 || route.hasOwnProperty("ctbSpecial")) {
                    for (let k = 0; k < routes.length; k++) {
                        let data = routes[k][1];
                        if (data["bound"].hasOwnProperty(co) && (co != "kmb" || kmbRouteExists(data)) && ((co == "ctb" && route["serviceType"] == 1) ? (route["ctbSpecial"] == "Any" ? !data.hasOwnProperty("ctbSpecial") : route["ctbSpecial"] == data["bound"][co]) : (data["bound"][co] == bound)) && data["serviceType"] == 1) {
                            if (co != "ctb" && data["dest"]["zh"] != route["dest"]["zh"]) {
                                if (language == "en") {
                                    name += " - Special To " + capitalize(route["dest"]["en"]);
                                } else {
                                    name += " - 特別班 開往" + route["dest"]["zh"];
                                }
                            } else if (co != "ctb" && data["orig"]["zh"] != route["orig"]["zh"]) {
                                if (language == "en") {
                                    name += " - Special From " + capitalize(route["orig"]["en"]);
                                } else {
                                    name += " - 特別班 從" + route["orig"]["zh"] + "開出";
                                }
                            } else {
                                let mainRouteFirstStop = dataSheet["stopList"][data["stops"][co][0]]["name"];
                                let mainRouteLastStop = dataSheet["stopList"][data["stops"][co][data["stops"][co].length - 1]]["name"];
                                let routeFirstStop = dataSheet["stopList"][route["stops"][co][0]]["name"];
                                let routeLastStop = dataSheet["stopList"][route["stops"][co][route["stops"][co].length - 1]]["name"];

                                if (mainRouteLastStop["zh"] != routeLastStop["zh"]) {
                                    if (language == "en") {
                                        name += " - Special To " + capitalize(routeLastStop["en"]);
                                    } else {
                                        name += " - 特別班 開往" + routeLastStop["zh"];
                                    }
                                } else if (mainRouteFirstStop["zh"] != routeFirstStop["zh"]) {
                                    if (language == "en") {
                                        name += " - Special From " + capitalize(routeFirstStop["en"]);
                                    } else {
                                        name += " - 特別班 從" + routeFirstStop["zh"] + "開出";
                                    }
                                } else {
                                    let difference = route["stops"][co]
                                        .filter(x => !data["stops"][co].includes(x))
                                        .map(x => dataSheet["stopList"][x]["name"][language]);
                                    if (difference.length > 0) {
                                        let differenceStr = difference.join(", ");
                                        if (language == "en") {
                                            name += " - Special Via " + differenceStr;
                                        } else {
                                            name += " - 特別班 經" + differenceStr;
                                        }
                                    } else {
                                        difference = data["stops"][co]
                                            .filter(x => !route["stops"][co].includes(x))
                                            .map(x => dataSheet["stopList"][x]["name"][language]);
                                        if (difference.length > 0) {
                                            let differenceStr = difference.join(", ");
                                            if (language == "en") {
                                                name += " - Special Skipping " + differenceStr;
                                            } else {
                                                name += " - 特別班 不經" + differenceStr;
                                            }
                                        } else {
                                            if (language == "en") {
                                                name += " - Special";
                                            } else {
                                                name += " - 特別班";
                                            }
                                        }
                                    }
                                }
                            }
                            break;
                        }
                    }
                }
                if (co == "ctb") {
                    name += language == "en" ? " - CTB" : " - 城巴";
                } else if (co == "nlb") {
                    name += language == "en" ? " - NLB" : " - 嶼巴";
                } else if (co == "mtr-bus") {
                    name += language == "en" ? " - MTR-Bus" : " - 港鐵巴士";
                } else if (co == "gmb") {
                    name += language == "en" ? " - GMB" : " - 專線小巴";
                }

                if (lastCo != null && lastCo != co) {
                    addOptions(document.getElementById('route-' + leg + '-type'), "-------------", "route-" + leg + "-type-" + lastCo + "-sep", sepCounter--);
                }
                addOptions(document.getElementById('route-' + leg + '-type'), name, "route-" + leg + "-type-" + bound + type, routes[u][0] + "_" + type);
                lastCo = co;
            }

            document.getElementById('route-' + leg + '-type').selectedIndex = Math.max(lastSelected, 1) < document.getElementById('route-' + leg + '-type').options.length ? lastSelected : 0;
        }

        updateStartingStops();
    };
    const updateStartingStops = () => {
        let collection = document.getElementsByClassName("route-input-element");
        if (collection.length == 0) {
            return;
        }
        for (let i = 0; i < collection.length; i++) {
            let leg = i + 1;
            let lastSelected = document.getElementById('route-' + leg + '-start').value;
            let lastSelectedName = "";
            try {
                lastSelectedName = document.getElementById('route-' + leg + '-start').options[document.getElementById('route-' + leg + '-start').selectedIndex].text;
            } catch (ignore) {}
            removeOptions(document.getElementById('route-' + leg + '-start'));
            let key = document.getElementById('route-' + leg + '-type').value;
            let routeKey = key.substring(0, key.indexOf("_"));
            let route = dataSheet["routeList"][routeKey];
            if (route == undefined) {
                continue;
            }
            let co = route["bound"].hasOwnProperty("kmb") ? "kmb" : (route["bound"].hasOwnProperty("ctb") ? "ctb" : (route["bound"].hasOwnProperty("nlb") ? "nlb" : (route["bound"].hasOwnProperty("mtr-bus") ? "mtr-bus" : "gmb")));
            let stops = route["stops"][co];
            for (let k = 0; k < stops.length - 1; k++) {
                let stopId = stops[k];
                let stop = dataSheet["stopList"][stopId];
                let name = (k + 1) + ". " + (language == "en" ? capitalize(stop["name"]["en"]) : stop["name"]["zh"]);
                addOptions(document.getElementById('route-' + leg + '-start'), name, "route-" + leg + "-start-" + k, k);
            }

            let sameNameArray = [...document.getElementById('route-' + leg + '-start').options].filter((a) => a.text == lastSelectedName);
            if (sameNameArray.length >= 0 && sameNameArray[0] != undefined && sameNameArray[0].value >= 0) {
                document.getElementById('route-' + leg + '-start').value = sameNameArray[0].value;
            } else {
                document.getElementById('route-' + leg + '-start').value = Math.max(lastSelected, 0) < document.getElementById('route-' + leg + '-start').options.length ? lastSelected : -1;
            }
        }

        updateDestinationStops();
    };
    const updateDestinationStops = () => {
        let collection = document.getElementsByClassName("route-input-element");
        if (collection.length == 0) {
            return;
        }
        for (let i = 0; i < collection.length; i++) {
            let leg = i + 1;
            let lastSelected = document.getElementById('route-' + leg + '-end').value;
            let lastSelectedName = "";
            try {
                lastSelectedName = document.getElementById('route-' + leg + '-end').options[document.getElementById('route-' + leg + '-end').selectedIndex].text;
            } catch (ignore) {}
            removeOptions(document.getElementById('route-' + leg + '-end'));
            let key = document.getElementById('route-' + leg + '-type').value;
            let routeKey = key.substring(0, key.indexOf("_"));
            let route = dataSheet["routeList"][routeKey];
            if (route == undefined) {
                continue;
            }
            let co = route["bound"].hasOwnProperty("kmb") ? "kmb" : (route["bound"].hasOwnProperty("ctb") ? "ctb" : (route["bound"].hasOwnProperty("nlb") ? "nlb" : (route["bound"].hasOwnProperty("mtr-bus") ? "mtr-bus" : "gmb")));
            let stops = route["stops"][co];
            let startingStop = Number(document.getElementById('route-' + leg + '-start').value);
            for (let k = startingStop + 1; k < stops.length; k++) {
                let stopId = stops[k];
                let stop = dataSheet["stopList"][stopId];
                let name = (k + 1) + ". " + (language == "en" ? capitalize(stop["name"]["en"]) : stop["name"]["zh"]);
                addOptions(document.getElementById('route-' + leg + '-end'), name, "route-" + leg + "-end-" + k, k);
            }

            let sameNameArray = [...document.getElementById('route-' + leg + '-end').options].filter((a) => a.text == lastSelectedName);
            if (sameNameArray.length >= 0 && sameNameArray[0] != undefined && sameNameArray[0].value >= 0) {
                document.getElementById('route-' + leg + '-end').value = sameNameArray[0].value;
            } else {
                document.getElementById('route-' + leg + '-end').value = Math.max(lastSelected, 0) > startingStop ? lastSelected : -1;
            }
        }
    };

    const checkFlag = (condition, task) => {
        if (condition() === false) {
            window.setTimeout(() => checkFlag(condition, task), 100);
        } else {
            task();
        }
    }
    const makeId = (length) => {
        let result = '';
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        const charactersLength = characters.length;
        let counter = 0;
        while (counter < length) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
            counter += 1;
        }
        return result;
    }

    const executeGetGSONTasks = (tasks) => {
        if (tasks.length == 0) {
            return;
        }
        let entry = tasks[0];
        getJSON(entry[0], (err, data) => {
            try {
                entry[1](err, data);
            } finally {
                tasks.shift()
                executeGetGSONTasks(tasks);
            }
        });
    };

    let currentShareParameters = "";
    let calculateTasks = [];
    const calculate = () => {
        let collection = document.getElementsByClassName("route-input-element");
        if (collection.length == 0) {
            return;
        }
        if (calculateTasks.length > 0) {
            checkFlag(() => calculateTasks.length == 0, calculate);
            return;
        }

        let taskId = makeId(10);
        calculateTasks.push(taskId);
        let shareParameters = [];
        try {
            for (let i = 0; i < collection.length; i++) {
                let leg = i + 1;
                let key = document.getElementById('route-' + leg + '-type').value;
                if (key.startsWith("-") || key == "") {
                    let routeNumber = document.getElementById('route-' + leg).value.toUpperCase();
                    let routeValid = false;

                    for (let key in dataSheet["routeList"]) {
                        let data = dataSheet["routeList"][key];
                        if (data["route"] == routeNumber) {
                            routeValid = true;
                            break;
                        }
                    }
                    return;
                }
                let routeKey = key.substring(0, key.indexOf("_"));
                let route = dataSheet["routeList"][routeKey];
                if (route["fares"] == null) {
                    let resolvedRouteDataUrl = kmbRouteDataUrl.replace("{route}", route["route"]).replace("{bound}", route["bound"]["kmb"] == "O" ? 1 : 2).replace("{type}", route["serviceType"])
                    getJSON(resolvedRouteDataUrl, (err, data) => {
                        if (err == null) {
                            let faresArray = [];
                            let routeStops = data["data"]["routeStops"]
                            for (let u = 0; u < routeStops.length; u++) {
                                let routeStop = routeStops[u];
                                faresArray.push(routeStop["AirFare"]);
                            }
                            route["fares"] = faresArray;
                            calculate();
                        } else {
                            printConnectionError("Unable to get response from " + resolvedRouteDataUrl + ". (Is it down?)");
                        }
                    });
                    return;
                }
            }

            let rowsData = [];

            let consecutiveInterchanges = 1;
            let lastRouteNumber = -1;
            let lastFare = 0;
            let lastCo = null;
            let lastBound = null;
            let lastGtfsId = -1;
            let lastStopDetails = null;
            for (let i = 0; i < collection.length; i++) {
                let leg = i + 1;
                let key = document.getElementById('route-' + leg + '-type').value;
                let routeKey = key.substring(0, key.indexOf("_"));
                let route = dataSheet["routeList"][routeKey];
                let co = route["bound"].hasOwnProperty("kmb") ? "kmb" : (route["bound"].hasOwnProperty("ctb") ? "ctb" : (route["bound"].hasOwnProperty("nlb") ? "nlb" : (route["bound"].hasOwnProperty("mtr-bus") ? "mtr-bus" : "gmb")));
                let routeNumber = route["route"];
                let stops = route["stops"][co];
                let displayStopNames = stopIdsToNames(stops, language);
                let stopNames = stopIdsToNames(stops);
                let stopDetails = stopIdsToDetails(stops);
                let startingStopIndex = Number(document.getElementById('route-' + leg + '-start').value);
                let endingStopIndex = Number(document.getElementById('route-' + leg + '-end').value);
                if (startingStopIndex <= -1) {
                    return;
                }
                if (endingStopIndex <= -1) {
                    return;
                }
                if (i == 0) {
                    let startingStopId = stops[startingStopIndex];
                    let startingStop = dataSheet["stopList"][startingStopId];
                    let startingName = startingStop["name"]["zh"];

                    let endingStopId = stops[endingStopIndex];
                    let endingStop = dataSheet["stopList"][endingStopId];
                    let endingName = endingStop["name"]["zh"];

                    let note = "-";
                    let twoWaySectionFare = co == "kmb" ? checkTwoWaySectionFare(routeNumber, stopNames, startingName, endingName) : null;
                    let fare = 0;
                    if (twoWaySectionFare == null) {
                        fare = Number(route["fares"][startingStopIndex]);
                    } else {
                        fare = twoWaySectionFare[2];
                        if (language == "en") {
                            note = "Octopus Two-way Section Fare -&nbsp;" + displayStopNames[twoWaySectionFare[0]] + " to " + displayStopNames[twoWaySectionFare[1]];
                        } else {
                            note = "八達通雙向分段收費 -&nbsp;" + displayStopNames[twoWaySectionFare[0]] + " 至 " + displayStopNames[twoWaySectionFare[1]];
                        }
                    }
                    if (co == "nlb") {
                        if (note != "-") {
                            note += " / ";
                        } else {
                            note = "";
                        }
                        note += (language == "en" ? "NLB Two-way Section Fares & Holiday Fares Not Taken Into Account (If Any)" : "未有計算嶼巴雙向分段收費及假日收費(如有)");
                    } else if (co == "gmb") {
                        if (note != "-") {
                            note += " / ";
                        } else {
                            note = "";
                        }
                        note += (language == "en" ? "GMB Two-way Section Fares Not Taken Into Account (If Any)" : "未有計算專線小巴雙向分段收費(如有)");
                    }

                    rowsData.push([routeNumber, startingName, endingName, null, null, null, note, fare, route, stopNames, stopDetails, stops, startingStopIndex, endingStopIndex, displayStopNames]);

                    lastFare = fare;
                    lastRouteNumber = routeNumber;
                    consecutiveInterchanges = 1;
                    lastBound = co == "nlb" ? route["nlbId"] : route["bound"][co];
                    lastStopDetails = stopDetails.slice(startingStopIndex + 1, endingStopIndex + 1);
                    lastCo = co;
                    lastGtfsId = route["gtfsId"];
                } else {
                    let endingStopId = stops[endingStopIndex];
                    let endingStop = dataSheet["stopList"][endingStopId];
                    let endingName = endingStop["name"]["zh"];

                    let interchangeStopResult = findInterchangeStop(lastStopDetails, stopDetails.slice(startingStopIndex, endingStopIndex));

                    let interchangeStopId1 = interchangeStopResult[0];
                    let interchangeStop1 = dataSheet["stopList"][interchangeStopId1];
                    let interchangeName1 = interchangeStop1["name"]["zh"];

                    let interchangeStopId2 = interchangeStopResult[1];
                    let interchangeStop2 = dataSheet["stopList"][interchangeStopId2];
                    let interchangeName2 = interchangeStop2["name"]["zh"];

                    let note = "-";
                    let twoWaySectionFare = co == "kmb" ? checkTwoWaySectionFare(routeNumber, stopNames, interchangeName2, endingName) : null;
                    let fare = 0;
                    if (twoWaySectionFare == null) {
                        fare = Number(route["fares"][startingStopIndex]);
                    } else {
                        fare = twoWaySectionFare[2];
                        if (language == "en") {
                            note = "Octopus Two-way Section Fare -&nbsp;" + displayStopNames[twoWaySectionFare[0]] + " to " + displayStopNames[twoWaySectionFare[1]];
                        } else {
                            note = "八達通雙向分段收費 -&nbsp;" + displayStopNames[twoWaySectionFare[0]] + " 至 " + displayStopNames[twoWaySectionFare[1]];
                        }
                    }

                    let hasBbi = false;
                    if (co == "kmb") {
                        let bbiDataSheet = lastBound == "O" ? bbiF1 : bbiB1;
                        if (rowsData[i - 1][8]["dest"]["zh"].indexOf("循環線") >= 0) {
                            bbiDataSheet = {};
                            for (let key in bbiF1) {
                                bbiDataSheet[key] = [...bbiF1[key]];
                            }
                            for (let key in bbiB1) {
                                if (bbiDataSheet.hasOwnProperty(key)) {
                                    bbiDataSheet[key] = bbiDataSheet[key].concat(bbiB1[key]);
                                } else {
                                    bbiDataSheet[key] = [...bbiB1[key]];
                                }
                            }
                        } else if (bbiDataSheet[lastRouteNumber] != undefined) {
                            let bbiData = bbiDataSheet[lastRouteNumber];
                            if (bbiData.length > 0) {
                                if (bbiData[0]["bbi_direction"] != rowsData[i - 1][8]["dest"]["zh"] && rowsData[i - 1][8]["dest"]["zh"].indexOf("循環線") < 0) {
                                    bbiDataSheet = lastBound == "O" ? bbiB1 : bbiF1;
                                }
                            }
                        }
                        if (bbiDataSheet[lastRouteNumber] != undefined) {
                            let bbiData = bbiDataSheet[lastRouteNumber];
                            for (let k = 0; k < bbiData.length; k++) {
                                let bbiRoute = bbiData[k];
                                let routeDest = null;
                                let type = route["stops"]["kmb"];
                                let bound = route["bound"]["kmb"];
                                if (type == 1) {
                                    routeDest = route["dest"]["zh"];
                                } else {
                                    for (let key in dataSheet["routeList"]) {
                                        let data = dataSheet["routeList"][key];
                                        if (data["route"] == routeNumber && data["bound"].hasOwnProperty("kmb") && data["bound"]["kmb"] == bound && data["serviceType"] == 1) {
                                            routeDest = data["dest"]["zh"];
                                            break;
                                        }
                                    }
                                }
                                if (bbiRoute["bbi_route_number"].replace("(城巴)", "") == routeNumber && (bbiRoute["destination"] == routeDest.replace("(循環線)", "") || routeDest.indexOf("循環線") >= 0)) {
                                    let maxChanges = bbiRoute["max_change"];
                                    if (maxChanges >= consecutiveInterchanges++) {
                                        hasBbi = true;
                                        let timeLimit = bbiRoute["time_limit"];
                                        let recommendedBbi = bbiRoute["recommended_bbi"];

                                        if (recommendedBbi != "任何能接駁第二程路線的巴士站") {
                                            let recommendedBbiIndex = stopNamesIndexOf(recommendedBbi, stopNames);
                                            if (recommendedBbiIndex >= startingStopIndex && recommendedBbiIndex <= endingStopIndex) {
                                                let interchangeStopClosestResult = findCloestStop(stopDetails[recommendedBbiIndex], rowsData[i - 1][10]);
                                                let interchangeStopIndex = rowsData[i - 1][11].indexOf(interchangeStopClosestResult[0]);
                                                if (interchangeStopIndex >= rowsData[i - 1][12] && interchangeStopIndex <= rowsData[i - 1][13]) {
                                                    interchangeName2 = bbiRoute["recommended_bbi"];
                                                    interchangeStopId2 = stops[recommendedBbiIndex];
                                                    startingStopIndex = recommendedBbiIndex;
                                                    interchangeStop1 = dataSheet["stopList"][interchangeStopClosestResult[0]];
                                                    interchangeName1 = interchangeStop1["name"]["zh"];
                                                }
                                            }
                                        }

                                        if (rowsData[i - 1][2] != interchangeName1) {
                                            rowsData[i - 1][2] = interchangeName1;
                                            let newEndingStopIndex = rowsData[i - 1][9].indexOf(interchangeName1);
                                            rowsData[i - 1][13] = newEndingStopIndex;
                                            let twoWaySectionFare0 = lastCo == "kmb" ? checkTwoWaySectionFare(rowsData[i - 1][0], rowsData[i - 1][9], rowsData[i - 1][1], interchangeName1) : null;
                                            let fare0 = 0;
                                            let note0 = "-";
                                            if (twoWaySectionFare0 == null) {
                                                fare0 = Number(rowsData[i - 1][8]["fares"][rowsData[i - 1][12]]);
                                            } else {
                                                fare0 = twoWaySectionFare0[2];
                                                if (language == "en") {
                                                    note0 = "Octopus Two-way Section Fare -&nbsp;" + rowsData[i - 1][14][twoWaySectionFare[0]] + " to " + rowsData[i - 1][14][twoWaySectionFare[1]];
                                                } else {
                                                    note0 = "八達通雙向分段收費 -&nbsp;" + rowsData[i - 1][14][twoWaySectionFare0[0]] + " 至 " + rowsData[i - 1][14][twoWaySectionFare0[1]];
                                                }
                                            }
                                            if (lastCo == "nlb") {
                                                if (note0 != "-") {
                                                    note0 += " / ";
                                                } else {
                                                    note0 = "";
                                                }
                                                note0 += (language == "en" ? "NLB Two-way Section Fares & Holiday Fares Not Taken Into Account (If Any)" : "未有計算嶼巴雙向分段收費及假日收費(如有)");
                                            } else if (lastCo == "gmb") {
                                                if (note != "-") {
                                                    note += " / ";
                                                } else {
                                                    note = "";
                                                }
                                                note += (language == "en" ? "GMB Two-way Section Fares Not Taken Into Account (If Any)" : "未有計算專線小巴雙向分段收費(如有)");
                                            }
                                            lastFare = fare0;
                                            lastStopDetails = stopDetails.slice(rowsData[i - 1][10] + 1, newEndingStopIndex + 1);

                                            rowsData[i - 1][6] = note0;
                                            rowsData[i - 1][7] = fare0;
                                        }

                                        let discountType = bbiRoute["discount_type"];
                                        let discount = bbiRoute["discount"];
                                        if (discountType == "free") {
                                            fare = 0;
                                        } else if (discountType == "discount") {
                                            fare -= discount;
                                        } else if (discountType == "combined_fare") {
                                            fare = discount - lastFare;
                                        } else if (discountType == "fixed_fare") {
                                            fare = discount;
                                        } else if (discountType == "return") {
                                            fare = -discount;
                                        }
                                        fare = roundTo1Decimal(fare);

                                        let discount_message = bbiRoute["discount_raw"];
                                        if (language == "en") {
                                            discount_message = discount_message
                                                    .replace("減", "Discount")
                                                    .replace("兩程合共", "Combined Fare")
                                                    .replace("免費", "Free")
                                                    .replace("付", "Pay")
                                                    .replace("回贈", "Rebate");

                                        }

                                        startingStopIndex = stops.indexOf(interchangeStopId2);

                                        rowsData.push([routeNumber, interchangeName2, endingName, discount_message, maxChanges, timeLimit, note, fare, route, stopNames, stopDetails, stops, startingStopIndex, endingStopIndex, displayStopNames]);
                                    }
                                    break;
                                }
                            }
                        }
                        if (!hasBbi) {
                            if (lastCo == "nlb" && (lastBound == "7" || lastBound == "8" || lastBound == "14" || lastBound == "17" || lastBound == "18" || lastBound == "22")) {
                                hasBbi = true;
                                let timeLimit = 150;
                                let maxChanges = 8;

                                if (rowsData[i - 1][2] != interchangeName1) {
                                    rowsData[i - 1][2] = interchangeName1;
                                    let newEndingStopIndex = rowsData[i - 1][9].indexOf(interchangeName1);
                                    rowsData[i - 1][13] = newEndingStopIndex;
                                    
                                    let fare0 = 0;
                                    let note0 = "-";
                                    fare0 = Number(rowsData[i - 1][8]["fares"][rowsData[i - 1][12]]);
                                    lastFare = fare0;
                                    lastStopDetails = stopDetails.slice(rowsData[i - 1][10] + 1, newEndingStopIndex + 1);

                                    if (lastCo == "nlb") {
                                        if (note0 != "-") {
                                            note0 += " / ";
                                        } else {
                                            note0 = "";
                                        }
                                        note0 += (language == "en" ? "NLB Two-way Section Fares & Holiday Fares Not Taken Into Account (If Any)" : "未有計算嶼巴雙向分段收費及假日收費(如有)");
                                    } else if (lastCo == "gmb") {
                                        if (note != "-") {
                                            note += " / ";
                                        } else {
                                            note = "";
                                        }
                                        note += (language == "en" ? "GMB Two-way Section Fares Not Taken Into Account (If Any)" : "未有計算專線小巴雙向分段收費(如有)");
                                    }

                                    rowsData[i - 1][6] = note0;
                                    rowsData[i - 1][7] = fare0;
                                }

                                let discount = 1;
                                let discount_message = "減 $" + roundTo1Decimal(discount);
                                fare -= discount;
                                fare = roundTo1Decimal(fare);

                                if (language == "en") {
                                    discount_message = discount_message
                                            .replace("減", "Discount")
                                            .replace("兩程合共", "Combined Fare")
                                            .replace("免費", "Free")
                                            .replace("付", "Pay")
                                            .replace("回贈", "Rebate");

                                }

                                startingStopIndex = stops.indexOf(interchangeStopId2);

                                rowsData.push([routeNumber, interchangeName2, endingName, discount_message, maxChanges, timeLimit, note, fare, route, stopNames, stopDetails, stops, startingStopIndex, endingStopIndex, displayStopNames]);
                            } else if (lastCo == "gmb") {
                                let bound = route["bound"][co];
                                if (bbiGmbKmb["kmb"].hasOwnProperty(routeNumber) && bbiGmbKmb["kmb"][routeNumber].hasOwnProperty(bound)) {
                                    let kmbGmbList = bbiGmbKmb["kmb"][routeNumber][bound];
                                    if (kmbGmbList.indexOf(lastGtfsId)) {
                                        hasBbi = true;
                                        let timeLimit = 150;
                                        let maxChanges = 8;

                                        if (rowsData[i - 1][2] != interchangeName1) {
                                            rowsData[i - 1][2] = interchangeName1;
                                            let newEndingStopIndex = rowsData[i - 1][9].indexOf(interchangeName1);
                                            rowsData[i - 1][13] = newEndingStopIndex;
                                            
                                            let fare0 = 0;
                                            let note0 = "-";
                                            fare0 = Number(rowsData[i - 1][8]["fares"][rowsData[i - 1][12]]);
                                            lastFare = fare0;
                                            lastStopDetails = stopDetails.slice(rowsData[i - 1][10] + 1, newEndingStopIndex + 1);

                                            if (lastCo == "nlb") {
                                                if (note0 != "-") {
                                                    note0 += " / ";
                                                } else {
                                                    note0 = "";
                                                }
                                                note0 += (language == "en" ? "NLB Two-way Section Fares & Holiday Fares Not Taken Into Account (If Any)" : "未有計算嶼巴雙向分段收費及假日收費(如有)");
                                            } else if (lastCo == "gmb") {
                                                if (note != "-") {
                                                    note += " / ";
                                                } else {
                                                    note = "";
                                                }
                                                note += (language == "en" ? "GMB Two-way Section Fares Not Taken Into Account (If Any)" : "未有計算專線小巴雙向分段收費(如有)");
                                            }

                                            rowsData[i - 1][6] = note0;
                                            rowsData[i - 1][7] = fare0;
                                        }

                                        let discount = 1;
                                        let discount_message = "減 $" + roundTo1Decimal(discount);
                                        fare -= discount;
                                        fare = roundTo1Decimal(fare);

                                        if (language == "en") {
                                            discount_message = discount_message
                                                    .replace("減", "Discount")
                                                    .replace("兩程合共", "Combined Fare")
                                                    .replace("免費", "Free")
                                                    .replace("付", "Pay")
                                                    .replace("回贈", "Rebate");

                                        }

                                        startingStopIndex = stops.indexOf(interchangeStopId2);

                                        rowsData.push([routeNumber, interchangeName2, endingName, discount_message, maxChanges, timeLimit, note, fare, route, stopNames, stopDetails, stops, startingStopIndex, endingStopIndex, displayStopNames]);
                                    }
                                }
                            }
                        }
                    } else if (co == "ctb") {
                        let lastRouteData = rowsData[i - 1][8];
                        for (let k = 0; k < bbiCtb.length; k++) {
                            let entry = bbiCtb[k];
                            let firstRoute = entry["firstRoute"].trim();
                            let firstBound = entry["firstBound"].trim() == "F" ? "O" : "I";
                            let secondRoute = entry["secondRoute"].trim();
                            let secondBound = entry["secondBound"].trim() == "F" ? "O" : "I";
                            if (lastCo != "ctb") {
                                firstBound = firstBound == "O" ? "I" : "O";
                            }
                            if (routeNumber == secondRoute && route["bound"]["ctb"] == secondBound && lastRouteNumber == firstRoute && lastBound == firstBound) {
                                let remark = language == "en" ? entry["remarkEn"] : entry["remark"];

                                let maxChanges = 3;
                                if (maxChanges >= consecutiveInterchanges++) {
                                    hasBbi = true;
                                    let timeLimit = entry["timeLimit"];
                                    let recommendedBbi = entry["stopName"];

                                    let recommendedBbiIndex = stopNamesIndexOf(recommendedBbi, stopNames);
                                    if (recommendedBbiIndex >= startingStopIndex && recommendedBbiIndex <= endingStopIndex) {
                                        let interchangeStopClosestResult = findCloestStop(stopDetails[recommendedBbiIndex], rowsData[i - 1][10]);
                                        let interchangeStopIndex = rowsData[i - 1][11].indexOf(interchangeStopClosestResult[0]);
                                        if (interchangeStopIndex >= rowsData[i - 1][12] && interchangeStopIndex <= rowsData[i - 1][13]) {
                                            interchangeName2 = entry["stopName"];
                                            interchangeStopId2 = stops[recommendedBbiIndex];
                                            startingStopIndex = recommendedBbiIndex;
                                            interchangeStop1 = dataSheet["stopList"][interchangeStopClosestResult[0]];
                                            interchangeName1 = interchangeStop1["name"]["zh"];
                                        }
                                    }

                                    if (remark != "") {
                                        if (note != "-") {
                                            note += " / ";
                                        } else {
                                            note = "";
                                        }
                                        note += remark;
                                    }

                                    if (rowsData[i - 1][2] != interchangeName1) {
                                        rowsData[i - 1][2] = interchangeName1;
                                        let newEndingStopIndex = rowsData[i - 1][9].indexOf(interchangeName1);
                                        rowsData[i - 1][13] = newEndingStopIndex;
                                        let twoWaySectionFare0 = lastCo == "kmb" ? checkTwoWaySectionFare(rowsData[i - 1][0], rowsData[i - 1][9], rowsData[i - 1][1], interchangeName1) : null;
                                        let fare0 = 0;
                                        let note0 = "-";
                                        if (twoWaySectionFare0 == null) {
                                            fare0 = Number(rowsData[i - 1][8]["fares"][rowsData[i - 1][12]]);
                                        } else {
                                            fare0 = twoWaySectionFare0[2];
                                            if (language == "en") {
                                                note0 = "Octopus Two-way Section Fare -&nbsp;" + rowsData[i - 1][14][twoWaySectionFare[0]] + " to " + rowsData[i - 1][14][twoWaySectionFare[1]];
                                            } else {
                                                note0 = "八達通雙向分段收費 -&nbsp;" + rowsData[i - 1][14][twoWaySectionFare0[0]] + " 至 " + rowsData[i - 1][14][twoWaySectionFare0[1]];
                                            }
                                        }
                                        if (lastCo == "nlb") {
                                            if (note0 != "-") {
                                                note0 += " / ";
                                            } else {
                                                note0 = "";
                                            }
                                            note0 += (language == "en" ? "NLB Two-way Section Fares & Holiday Fares Not Taken Into Account (If Any)" : "未有計算嶼巴雙向分段收費及假日收費(如有)");
                                        } else if (lastCo == "gmb") {
                                            if (note != "-") {
                                                note += " / ";
                                            } else {
                                                note = "";
                                            }
                                            note += (language == "en" ? "GMB Two-way Section Fares Not Taken Into Account (If Any)" : "未有計算專線小巴雙向分段收費(如有)");
                                        }
                                        lastFare = fare0;
                                        lastStopDetails = stopDetails.slice(rowsData[i - 1][10] + 1, newEndingStopIndex + 1);

                                        rowsData[i - 1][6] = note0;
                                        rowsData[i - 1][7] = fare0;
                                    }

                                    let discountType = entry["discount"];
                                    let discount = Number(entry["discountAmount"]["adult"]);
                                    let discount_message;
                                    if (discountType == "L2") {
                                        fare = 0;
                                        discount_message = "免費";
                                    } else if (discountType == "FR" || discountType == "FF") {
                                        fare -= discount;
                                        discount_message = "減 $" + roundTo1Decimal(discount);
                                    } else if (discountType == "TF") {
                                        fare = discount - lastFare;
                                        discount_message = "兩程合共 $" + roundTo1Decimal(discount + lastFare);
                                    } else if (discountType == "L1") {
                                        fare = fare - lastFare;
                                        let rounded = roundTo1Decimal(fare);
                                        if (rounded < 0) {
                                            discount_message = "回贈 $" + (-rounded);
                                        } else if (rounded > 0) {
                                            discount_message = "付 $" + rounded;
                                        } else {
                                            discount_message = "免費";
                                        }
                                    }
                                    fare = roundTo1Decimal(fare);

                                    if (language == "en") {
                                        discount_message = discount_message
                                                .replace("減", "Discount")
                                                .replace("兩程合共", "Combined Fare")
                                                .replace("免費", "Free")
                                                .replace("付", "Pay")
                                                .replace("回贈", "Rebate");

                                    }

                                    startingStopIndex = stops.indexOf(interchangeStopId2);

                                    rowsData.push([routeNumber, interchangeName2, endingName, discount_message, maxChanges, timeLimit, note, fare, route, stopNames, stopDetails, stops, startingStopIndex, endingStopIndex, displayStopNames]);
                                }
                                break;
                            }
                        }
                    } else if (co == "nlb") {
                        if (note != "-") {
                            note += " / ";
                        } else {
                            note = "";
                        }
                        note += (language == "en" ? "NLB Two-way Section Fares & Holiday Fares Not Taken Into Account (If Any)" : "未有計算嶼巴雙向分段收費及假日收費(如有)");

                        if (lastCo == "kmb" && lastRouteNumber.startsWith("E") && lastBound == "O") {
                            hasBbi = true;
                            let timeLimit = 150;
                            let maxChanges = 8;

                            if (rowsData[i - 1][2] != interchangeName1) {
                                rowsData[i - 1][2] = interchangeName1;
                                let newEndingStopIndex = rowsData[i - 1][9].indexOf(interchangeName1);
                                rowsData[i - 1][13] = newEndingStopIndex;
                                let twoWaySectionFare0 = lastCo == "kmb" ? checkTwoWaySectionFare(rowsData[i - 1][0], rowsData[i - 1][9], rowsData[i - 1][1], interchangeName1) : null;
                                let fare0 = 0;
                                let note0 = "-";
                                if (twoWaySectionFare0 == null) {
                                    fare0 = Number(rowsData[i - 1][8]["fares"][rowsData[i - 1][12]]);
                                } else {
                                    fare0 = twoWaySectionFare0[2];
                                    if (language == "en") {
                                        note0 = "Octopus Two-way Section Fare -&nbsp;" + rowsData[i - 1][14][twoWaySectionFare[0]] + " to " + rowsData[i - 1][14][twoWaySectionFare[1]];
                                    } else {
                                        note0 = "八達通雙向分段收費 -&nbsp;" + rowsData[i - 1][14][twoWaySectionFare0[0]] + " 至 " + rowsData[i - 1][14][twoWaySectionFare0[1]];
                                    }
                                }
                                if (lastCo == "nlb") {
                                    if (note0 != "-") {
                                        note0 += " / ";
                                    } else {
                                        note0 = "";
                                    }
                                    note0 += (language == "en" ? "NLB Two-way Section Fares & Holiday Fares Not Taken Into Account (If Any)" : "未有計算嶼巴雙向分段收費及假日收費(如有)");
                                } else if (lastCo == "gmb") {
                                    if (note != "-") {
                                        note += " / ";
                                    } else {
                                        note = "";
                                    }
                                    note += (language == "en" ? "GMB Two-way Section Fares Not Taken Into Account (If Any)" : "未有計算專線小巴雙向分段收費(如有)");
                                }
                                lastFare = fare0;
                                lastStopDetails = stopDetails.slice(rowsData[i - 1][10] + 1, newEndingStopIndex + 1);

                                rowsData[i - 1][6] = note0;
                                rowsData[i - 1][7] = fare0;
                            }

                            let discount = 1;
                            let discount_message = "減 $" + roundTo1Decimal(discount);
                            fare -= discount;
                            fare = roundTo1Decimal(fare);

                            if (language == "en") {
                                discount_message = discount_message
                                        .replace("減", "Discount")
                                        .replace("兩程合共", "Combined Fare")
                                        .replace("免費", "Free")
                                        .replace("付", "Pay")
                                        .replace("回贈", "Rebate");

                            }

                            startingStopIndex = stops.indexOf(interchangeStopId2);

                            rowsData.push([routeNumber, interchangeName2, endingName, discount_message, maxChanges, timeLimit, note, fare, route, stopNames, stopDetails, stops, startingStopIndex, endingStopIndex, displayStopNames]);
                        }
                    } else if (co == "gmb") {
                        if (note != "-") {
                            note += " / ";
                        } else {
                            note = "";
                        }
                        note += (language == "en" ? "GMB Two-way Section Fares Not Taken Into Account (If Any)" : "未有計算專線小巴雙向分段收費(如有)");

                        let key = route["gtfsId"] + "_" + route["bound"]["gmb"];
                        if (lastCo == "kmb" && bbiGmbKmb["gmb"].hasOwnProperty(key)) {
                            let kmbGmbList = bbiGmbKmb["gmb"][key];
                            if (kmbGmbList.filter(e => e["route"] == lastRouteNumber && e["bound"] == lastBound)) {
                                hasBbi = true;
                                let timeLimit = 150;
                                let maxChanges = 8;

                                if (rowsData[i - 1][2] != interchangeName1) {
                                    rowsData[i - 1][2] = interchangeName1;
                                    let newEndingStopIndex = rowsData[i - 1][9].indexOf(interchangeName1);
                                    rowsData[i - 1][13] = newEndingStopIndex;
                                    
                                    let fare0 = 0;
                                    let note0 = "-";
                                    fare0 = Number(rowsData[i - 1][8]["fares"][rowsData[i - 1][12]]);
                                    lastFare = fare0;
                                    lastStopDetails = stopDetails.slice(rowsData[i - 1][10] + 1, newEndingStopIndex + 1);

                                    if (lastCo == "nlb") {
                                        if (note0 != "-") {
                                            note0 += " / ";
                                        } else {
                                            note0 = "";
                                        }
                                        note0 += (language == "en" ? "NLB Two-way Section Fares & Holiday Fares Not Taken Into Account (If Any)" : "未有計算嶼巴雙向分段收費及假日收費(如有)");
                                    } else if (lastCo == "gmb") {
                                        if (note != "-") {
                                            note += " / ";
                                        } else {
                                            note = "";
                                        }
                                        note += (language == "en" ? "GMB Two-way Section Fares Not Taken Into Account (If Any)" : "未有計算專線小巴雙向分段收費(如有)");
                                    }

                                    rowsData[i - 1][6] = note0;
                                    rowsData[i - 1][7] = fare0;
                                }

                                let discount = 1;
                                let discount_message = "減 $" + roundTo1Decimal(discount);
                                fare -= discount;
                                fare = roundTo1Decimal(fare);

                                if (language == "en") {
                                    discount_message = discount_message
                                            .replace("減", "Discount")
                                            .replace("兩程合共", "Combined Fare")
                                            .replace("免費", "Free")
                                            .replace("付", "Pay")
                                            .replace("回贈", "Rebate");

                                }

                                startingStopIndex = stops.indexOf(interchangeStopId2);

                                rowsData.push([routeNumber, interchangeName2, endingName, discount_message, maxChanges, timeLimit, note, fare, route, stopNames, stopDetails, stops, startingStopIndex, endingStopIndex, displayStopNames]);
                            }
                        }
                    }

                    if (!hasBbi) {
                        if (rowsData[i - 1][2] != interchangeName1) {
                            rowsData[i - 1][2] = interchangeName1;

                            let newEndingStopIndex = rowsData[i - 1][9].indexOf(interchangeName1);
                            rowsData[i - 1][13] = newEndingStopIndex;
                            let twoWaySectionFare0 = co == "kmb" ? checkTwoWaySectionFare(rowsData[i - 1][0], rowsData[i - 1][9], rowsData[i - 1][1], interchangeName1) : null;
                            let fare0 = 0;
                            let note0 = "-";
                            if (twoWaySectionFare0 == null) {
                                fare0 = Number(rowsData[i - 1][8]["fares"][rowsData[i - 1][12]]);
                            } else {
                                fare0 = twoWaySectionFare0[2];
                                if (language == "en") {
                                    note = "Octopus Two-way Section Fare -&nbsp;" + rowsData[i - 1][14][twoWaySectionFare[0]] + " to " + rowsData[i - 1][14][twoWaySectionFare[1]];
                                } else {
                                    note0 = "八達通雙向分段收費 -&nbsp;" + rowsData[i - 1][14][twoWaySectionFare0[0]] + " 至 " + rowsData[i - 1][14][twoWaySectionFare0[1]];
                                }
                            }
                            if (lastCo == "nlb") {
                                if (note0 != "-") {
                                    note0 += " / ";
                                } else {
                                    note0 = "";
                                }
                                note0 += (language == "en" ? "NLB Two-way Section Fares & Holiday Fares Not Taken Into Account (If Any)" : "未有計算嶼巴雙向分段收費及假日收費(如有)");
                            } else if (lastCo == "gmb") {
                                if (note != "-") {
                                    note += " / ";
                                } else {
                                    note = "";
                                }
                                note += (language == "en" ? "GMB Two-way Section Fares Not Taken Into Account (If Any)" : "未有計算專線小巴雙向分段收費(如有)");
                            }
                            lastFare = fare0;
                            lastStopDetails = stopDetails.slice(rowsData[i - 1][10] + 1, newEndingStopIndex + 1);

                            rowsData[i - 1][6] = note0;
                            rowsData[i - 1][7] = fare0;
                        }

                        startingStopIndex = stops.indexOf(interchangeStopId2);

                        rowsData.push([routeNumber, interchangeName2, endingName, null, null, null, note, fare, route, stopNames, stopDetails, stops, startingStopIndex, endingStopIndex, displayStopNames]);
                        consecutiveInterchanges = 1;
                    }
                    lastRouteNumber = routeNumber;
                    lastFare = fare;
                    lastBound = co == "nlb" ? route["nlbId"] : route["bound"][co];
                    lastStopDetails = stopDetails.slice(startingStopIndex + 1, endingStopIndex + 1);
                    lastCo = co;
                    lastGtfsId = route["gtfsId"];
                }
                shareParameters.push("r" + leg + "=" + co + "," + routeNumber + "," + (co == "nlb" ? route["nlbId"] : route["bound"][co]) + "," + route["serviceType"] + "," + stops[startingStopIndex] + "," + stops[endingStopIndex]);
            }

            currentShareParameters = "?" + shareParameters.join("&");

            markers.clearLayers();
            lines.clearLayers();
            activeRouteMarker.clearLayers();
            currentStopMarkersByStopId.clear();
            currentStopMarkersByPin.clear();
            document.getElementById('special-announcements').innerHTML = "";
            document.getElementById('special-announcements').style.display = "none";

            document.getElementById('time-table').innerHTML = "";
            document.getElementById('time-table').style.display = "none";

            document.getElementById('eta-table').innerHTML = "";
            document.getElementById('eta-table').style.display = "none";

            document.getElementById('fare-table-mobile').innerHTML = "";
            document.getElementById('fare-table-mobile').style.display = "none";
            document.getElementById('fare-table').style.display = "none";

            deleteRows(document.getElementById('fare-table'), 1);

            let stopMarkerData = new Map();
            let getJSONTasksQueue = [];

            let totalFare = 0;
            let nanInFare = false;
            for (let i = 0; i < rowsData.length; i++) {
                let entry = rowsData[i];
                let co = entry[8]["bound"].hasOwnProperty("kmb") ? "kmb" : (entry[8]["bound"].hasOwnProperty("ctb") ? "ctb" : (entry[8]["bound"].hasOwnProperty("nlb") ? "nlb" : (entry[8]["bound"].hasOwnProperty("mtr-bus") ? "mtr-bus" : "gmb")));
                let routeText = getRouteNumberDisplay(co, entry[0], {emoji: true});
                if (co == "ctb") {
                    routeText += " - " + (language == "en" ? "CTB" : "城巴");
                } else if (co == "nlb") {
                    routeText += " - " + (language == "en" ? "NLB" : "嶼巴");
                } else if (co == "mtr-bus") {
                    routeText += " - " + (language == "en" ? "MTR-Bus" : "港鐵巴士");
                } else if (co == "gmb") {
                    routeText += " - " + (language == "en" ? "GMB" : "專線小巴");
                }

                let routeNumberDisplay = getRouteNumberDisplay(co, entry[0]);

                let remark = entry[6];
                if (entry[8].hasOwnProperty("jointOp")) {
                    if (remark != "") {
                        remark += " / ";
                    }
                    if (language == "en") {
                        remark = "KMB/CTB Joint Operated Route - Fare discount might be inaccurate";
                    } else {
                        remark = "九巴城巴聯營路線 - 轉乘優惠未必準確";
                    }
                }

                addRows(document.getElementById('fare-table'), 
                    routeText, 
                    applyBbiStopHref(entry[14][entry[12]]), 
                    applyBbiStopHref(entry[14][entry[13]]), 
                    entry[3] == null ? "-" : entry[3], 
                    entry[4] == null ? "-" : entry[4], 
                    entry[5] == null ? "-" : entry[5] + (language == "en" ? " Min." : "分鐘"), 
                    applyBbiStopHref(remark), 
                    isNaN(entry[7]) ? ("<span style=\"font-style: italic;\">" + (language == "en" ? "*Not Available" : "*未能提供") + "</span>") : ("<span style=\"text-align: right; display: block;\">$" + entry[7].toFixed(1)) + "</span>");

                let mobileText = 
                "<table class=\"table\" style=\"width: 100%;\">" +
                    "<tbody>" +
                        "<tr>" +
                            "<th>" + (language == "en" ? "Route" : "路線") + "</th>" +
                            "<th style=\"text-align: right; font-weight: normal;\">" + routeText + "</th>" +
                        "</tr>" +
                        "<tr>" +
                            "<th>" + (language == "en" ? "Suggested Boarding Stop" : "建議上車巴士站") + "</th>" +
                            "<th style=\"text-align: right; font-weight: normal;\">" + applyBbiStopHref(entry[14][entry[12]]) + "</th>" +
                        "</tr>" +
                        "<tr>" +
                            "<th>" + (language == "en" ? "Suggested Alighting Stop" : "建議落車巴士站") + "</th>" +
                            "<th style=\"text-align: right; font-weight: normal;\">" + applyBbiStopHref(entry[14][entry[13]]) + "</th>" +
                        "</tr>" +
                        "<tr>" +
                            "<th>" + (language == "en" ? "Discount" : "優惠") + "</th>" +
                            "<th style=\"text-align: right; font-weight: normal;\">" + (entry[3] == null ? "-" : entry[3]) + "</th>" +
                        "</tr>" +
                        "<tr>" +
                            "<th>" + (language == "en" ? "Max. Successive Discount" : "最高連續轉乘") + "</th>" +
                            "<th style=\"text-align: right; font-weight: normal;\">" + (entry[4] == null ? "-" : entry[4]) + "</th>" +
                        "</tr>" +
                        "<tr>" +
                            "<th>" + (language == "en" ? "Time Limit" : "時限") + "</th>" +
                            "<th style=\"text-align: right; font-weight: normal;\">" + (entry[5] == null ? "-" : entry[5] + (language == "en" ? " Min." : "分鐘")) + "</th>" +
                        "</tr>" +
                        "<tr>" +
                            "<th>" + (language == "en" ? "Remarks" : "備註") + "</th>" +
                            "<th style=\"text-align: right; font-weight: normal;\">" + applyBbiStopHref(remark) + "</th>" +
                        "</tr>" +
                        "<tr>" +
                            "<th>" + (language == "en" ? "Fare" : "車費") + "</th>" +
                            "<th style=\"text-align: right; font-weight: normal;\">" + (isNaN(entry[7]) ? ("<span style=\"font-style: italic;\">" + (language == "en" ? "*Not Available" : "*未能提供") + "</span>") : ("<span style=\"text-align: right; display: block;\">$" + entry[7].toFixed(1)) + "</span>") + "</th>" +
                        "</tr>" +
                    "</tbody>" +
                "</table>";
                document.getElementById('fare-table-mobile').innerHTML += mobileText;

                if (isNaN(entry[7])) {
                    nanInFare = true;
                } else {
                    totalFare += entry[7];
                }

                let route = entry[8];

                if (co == "kmb") {
                    let resolvedSpecialUrl = kmbSpecialAnnouncementsUrl.replace("{route}", route["route"]).replace("{bound}", route["bound"]["kmb"] == "O" ? 1 : 2);
                    let task0Id = makeId(10);
                    calculateTasks.push(task0Id);
                    getJSONTasksQueue.push([resolvedSpecialUrl, (err, data) => {
                        if (err == null) {
                            let entries = data["data"];
                            let messages = [];
                            for (let i = 0; i < entries.length; i++) {
                                let entry = entries[i];
                                let title = entry[language == "en" ? "kpi_title" : "kpi_title_chi"];
                                let resolvedAnnouncementPictureUrl = kmbAnnouncementPictureUrl + entry["kpi_noticeimageurl"];
                                messages.push("<a class=\"special-annoucement-href\" href=\"" + resolvedAnnouncementPictureUrl + "\" target=\"_blank\">" + title + "</a>");
                            }
                            if (messages.length > 0) {
                                let html;
                                if (language == "en") {
                                    html = "[Route " + routeNumberDisplay + " Announcements]<br> " + messages.join("<br>");
                                } else {
                                    html = "[路線" + routeNumberDisplay + "特別公告]<br> " + messages.join("<br>");
                                }
                                if (document.getElementById('special-announcements').innerHTML == "") {
                                    document.getElementById('special-announcements').style.display = "";
                                    document.getElementById('special-announcements').innerHTML = html;
                                } else {
                                    document.getElementById('special-announcements').innerHTML += "<br><br>" + html
                                }
                            }
                        } else {
                            printConnectionError("Unable to get response from " + resolvedSpecialUrl + ". (Is it down?)");
                        }
                        calculateTasks.splice(calculateTasks.indexOf(task0Id), 1);
                    }]);

                    let boundNumber = route["bound"]["kmb"] == "O" ? 1 : 2;
                    let resolvedTimeTableUrl = kmbTimeTableUrl.replace("{route}", route["route"]).replace("{bound}", boundNumber);
                    let task1Id = makeId(10);
                    calculateTasks.push(task1Id);
                    getJSONTasksQueue.push([resolvedTimeTableUrl, (err, data) => {
                        if (err == null) {
                            let timeTableData = data["data"];
                            let times = {};
                            for (let key in timeTableData) {
                                let serviceType = Number(key.trim());
                                let list = timeTableData[key];
                                if (serviceType == route["serviceType"]) {
                                    for (let u = 0; u < list.length; u++) {
                                        let entry = list[u];
                                        let dayType = entry["DayType"].trim();

                                        let time = entry["BoundText" + boundNumber].trim();
                                        let frequency = entry["BoundTime" + boundNumber].trim();
                                        if (time == "") {
                                            continue;
                                        }
                                        if (frequency == "") {
                                            frequency = "-";
                                        }

                                        let dayTypeName;
                                        let daysOfWeek;
                                        if (dayType == "MF") {
                                            dayTypeName = language == "en" ? "Monday to Friday" : "星期一至五";
                                            daysOfWeek = [1, 2, 3, 4, 5];
                                        } else if (dayType == "MS") {
                                            dayTypeName = language == "en" ? "Monday to Saturday" : "星期一至六";
                                            daysOfWeek = [1, 2, 3, 4, 5, 6];
                                        } else if (dayType == "S") {
                                            dayTypeName = language == "en" ? "Saturday" : "星期六";
                                            daysOfWeek = [6];
                                        } else if (dayType == "H") {
                                            dayTypeName = language == "en" ? "Sunday & Public Holidays" : "星期日及公眾假期";
                                            daysOfWeek = [7]; 
                                        } else if (dayType == "D") {
                                            dayTypeName = language == "en" ? "Daily" : "每天";
                                            if (time == "於指定日期服務" || time == "On specific day only") {
                                                daysOfWeek = [];
                                            } else {
                                                daysOfWeek = [1, 2, 3, 4, 5, 6, 7];
                                            }
                                        }

                                        let now = new Date();
                                        let nowHour = (now.getUTCHours() + 8) % 24;
                                        let nowMinute = now.getUTCMinutes();
                                        let weekday = weekdayNames.indexOf(new Date().toLocaleDateString("en-US", {
                                            timeZone: "Asia/Hong_Kong",
                                            weekday: "long"
                                        })) + 1;

                                        let isNow = false;
                                        let timeMatch = time;
                                        if (timeMatch.includes(",")) {
                                            let timeSections = time.split(",");
                                            timeMatch = timeSections[0].trim() + "-" + timeSections[timeSections.length - 1].trim();
                                        }

                                        let timeRangeStartHour = null;
                                        let timeRangeStartMinute = null;
                                        let timeRangeEndHour = null;
                                        let timeRangeEndMinute = null;
                                        let matcher = /\*?([0-9]{2}):([0-9]{2})(?: *- *([0-9]{2}):([0-9]{2}))?/g.exec(timeMatch);
                                        if (matcher != null) {
                                            timeRangeStartHour = Number(matcher[1]);
                                            timeRangeStartMinute = Number(matcher[2]);

                                            if (matcher[3] != undefined) {
                                                timeRangeEndHour = Number(matcher[3]);
                                                timeRangeEndMinute = Number(matcher[4]);
                                            } else {
                                                timeRangeEndHour = timeRangeStartHour;
                                                timeRangeEndMinute = timeRangeStartMinute + 1;
                                                if (timeRangeEndMinute >= 60) {
                                                    timeRangeEndHour = timeRangeEndHour + 1;
                                                    timeRangeEndMinute = timeRangeEndMinute % 60;
                                                    if (timeRangeEndHour >= 24) {
                                                        timeRangeEndHour = timeRangeEndHour % 24;
                                                    }
                                                }
                                            }
                                        }

                                        if (daysOfWeek.indexOf(weekday) >= 0) {
                                            if (timeRangeStartHour > timeRangeEndHour) {
                                                if (nowHour == timeRangeStartHour && nowMinute >= timeRangeStartMinute) {
                                                    isNow = true;
                                                } else if (nowHour == timeRangeEndHour && nowMinute < timeRangeEndMinute) {
                                                    isNow = true;
                                                } else if (nowHour > timeRangeStartHour || nowHour < timeRangeEndHour) {
                                                    isNow = true;
                                                }
                                            } else {
                                                if (nowHour > timeRangeStartHour || (nowHour == timeRangeStartHour && nowMinute >= timeRangeStartMinute)) {
                                                    isNow = nowHour < timeRangeEndHour || (nowHour == timeRangeEndHour && nowMinute < timeRangeEndMinute);
                                                }
                                            }
                                        }

                                        if (!times.hasOwnProperty(dayTypeName)) {
                                            times[dayTypeName] = [];
                                        }
                                        times[dayTypeName].push([time, frequency, daysOfWeek, isNow]);
                                    }
                                }
                            }

                            let tables = [];
                            for (let dayTypeName in times) {
                                let entries = times[dayTypeName];
                                let rows = [];
                                for (let u = 0; u < entries.length; u++) {
                                    let entry = entries[u];
                                    let daysOfWeek = entry[2];
                                    let isNow = entry[3];

                                    let fontWeight = isNow ? "bold" : "normal";
                                    if (daysOfWeek.length == 0) {
                                        rows.push(
                                            "<tr>" +
                                                "<th style=\"font-weight: " + fontWeight + "; white-space: nowrap;\">" + entry[0] + "</th>" +
                                                "<th style=\"font-weight: " + fontWeight + "; white-space: nowrap; text-align: right;\">-</th>" +
                                            "</tr>"
                                        );
                                    } else {
                                        rows.push(
                                            "<tr>" +
                                                "<th style=\"font-weight: " + fontWeight + "; white-space: nowrap;\">" + entry[0] + "</th>" +
                                                "<th style=\"font-weight: " + fontWeight + "; white-space: nowrap; text-align: right;\">" + entry[1] + "</th>" +
                                            "</tr>"
                                        );
                                    }
                                }
                                let table = 
                                    "<table class=\"table\" style=\"word-break: keep-all;\">" +
                                        "<tbody>" +
                                            "<tr>" +
                                                "<th>" + dayTypeName + "</th>" +
                                                "<th style=\"text-align: right;\">" + (language == "en" ? "Frequency (Min.)" : "班次(分鐘)") + "</th>" +
                                            "</tr>" + 
                                            rows.join("") +
                                        "</tbody>" +
                                    "</table>";

                                tables.push(table);
                            }

                            if (tables.length == 0) {
                                tables.push(language == "en" ? "On specific day only" : "於指定日期服務");
                            }

                            let tableTableTitle = language == "en" ? ("Route " + routeNumberDisplay + " Timetable") : ("路線" + routeNumberDisplay + "時間表");
                            let append = 
                                "<h5 class=\"title is-5 has-text-black\" style=\"min-width: 100px; width: 100%;\">" + tableTableTitle + "</h5>" + 
                                "<div class=\"columns\">" +
                                    "<div class=\"column\">" +
                                        tables.join("</div><div class=\"column\">") +
                                    "</div>" +
                                "</div>";

                            let toggleParameter = localStorage.getItem("toggle-options");
                            if ((Number(toggleParameter) & 0x02) == 0 && document.getElementById('time-table').innerHTML == "") {
                                document.getElementById('time-table').style.display = "";
                                document.getElementById("time-table").innerHTML = append;
                            } else {
                                document.getElementById("time-table").innerHTML += "<hr style=\"border-top: 1px solid #eee;\">" + append;
                            }
                        } else {
                            printConnectionError("Unable to get response from " + resolvedTimeTableUrl + ". (Is it down?)");
                        }
                        calculateTasks.splice(calculateTasks.indexOf(task1Id), 1);
                    }]);
                } else if (co == "ctb") {
                    let resolvedSpecialUrl = ctbSpecialAnnouncementsUrl.replace("{route}", route["route"]);
                    let task0Id = makeId(10);
                    calculateTasks.push(task0Id);
                    getJSONTasksQueue.push(["./dummy.txt", (err, data) => {
                        if (err == null) {
                            let messages = ["<a class=\"special-annoucement-href\" href=\"" + resolvedSpecialUrl + "\" target=\"_blank\">" + (language == "en" ? "Click to view" : "點擊查看") + "</a>"];
                            if (messages.length > 0) {
                                let html;
                                if (language == "en") {
                                    html = "[Route " + routeNumberDisplay + " Announcements (CTB)]<br> " + messages.join("<br>");
                                } else {
                                    html = "[路線" + routeNumberDisplay + "特別公告(城巴)]<br> " + messages.join("<br>");
                                }
                                if (document.getElementById('special-announcements').innerHTML == "") {
                                    document.getElementById('special-announcements').style.display = "";
                                    document.getElementById('special-announcements').innerHTML = html;
                                } else {
                                    document.getElementById('special-announcements').innerHTML += "<br><br>" + html
                                }
                            }
                        } else {
                            printConnectionError("Unable to get response from ./dummy.txt. (Is it down?)");
                        }
                        calculateTasks.splice(calculateTasks.indexOf(task0Id), 1);
                    }]);

                    let id = ctbId[route["route"]][route["bound"]["ctb"]]["id"];
                    let resolvedTimeTableUrl = ctbTimeTableUrl.replace("{id}", id).replace("{bound}", route["bound"]["ctb"]).replace("{lang}", language == "en" ? 1 : 0);
                    let task1Id = makeId(10);
                    calculateTasks.push(task1Id);
                    getJSONTasksQueue.push(["./dummy.txt", (err, data) => {
                        if (err == null) {
                            let tableTableTitle = language == "en" ? ("Route " + routeNumberDisplay + " Timetable (CTB)") : ("路線" + routeNumberDisplay + "時間表(城巴)");
                            let append = 
                                "<h5 class=\"title is-5 has-text-black\" style=\"min-width: 100px; width: 100%;\">" + tableTableTitle + "</h5>" + 
                                "<div class=\"columns\">" +
                                    "<div class=\"column\">" +
                                        "<iframe src=\"" + resolvedTimeTableUrl + "\" width=\"100%\" height=\"350px\"></iframe>" +
                                    "</div>" +
                                "</div>";

                            let toggleParameter = localStorage.getItem("toggle-options");
                            if ((Number(toggleParameter) & 0x02) == 0 && document.getElementById('time-table').innerHTML == "") {
                                document.getElementById('time-table').style.display = "";
                                document.getElementById("time-table").innerHTML = append;
                            } else {
                                document.getElementById("time-table").innerHTML += "<hr style=\"border-top: 1px solid #eee;\">" + append;
                            }
                        } else {
                            printConnectionError("Unable to get response from ./dummy.txt. (Is it down?)");
                        }
                        calculateTasks.splice(calculateTasks.indexOf(task1Id), 1);
                    }]);
                } else if (co == "gmb") {
                    let resolvedSpecialUrl = "https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/route_data_gmb/" + route["gtfsId"] + ".json";
                    let task0Id = makeId(10);
                    calculateTasks.push(task0Id);
                    getJSONTasksQueue.push([resolvedSpecialUrl, (err, data) => {
                        if (err == null) {
                            let region = data["region"][0].toLowerCase();
                            let url = gmbInfoUrl.replace("{route}", route["route"].toLowerCase()).replace("{region}", region).replace("{lang}", language == "en" ? "eng" : "chi");
                            let messages = ["<a class=\"special-annoucement-href\" href=\"" + url + "\" target=\"_blank\">" + (language == "en" ? "Click to view" : "點擊查看") + "</a>"];
                            if (messages.length > 0) {
                                let html;
                                if (language == "en") {
                                    html = "[Route " + routeNumberDisplay + " Additional Info (GMB)]<br> " + messages.join("<br>");
                                } else {
                                    html = "[路線" + routeNumberDisplay + "詳細資料(專線小巴)]<br> " + messages.join("<br>");
                                }
                                if (document.getElementById('special-announcements').innerHTML == "") {
                                    document.getElementById('special-announcements').style.display = "";
                                    document.getElementById('special-announcements').innerHTML = html;
                                } else {
                                    document.getElementById('special-announcements').innerHTML += "<br><br>" + html
                                }
                            }
                        } else {
                            printConnectionError("Unable to get response from " + resolvedTimeTableUrl + ". (Is it down?)");
                        }
                        calculateTasks.splice(calculateTasks.indexOf(task0Id), 1);
                    }]);

                    let resolvedTimeTableUrl = "https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/route_data_gmb/" + route["gtfsId"] + ".json";
                    let task1Id = makeId(10);
                    calculateTasks.push(task1Id);
                    getJSONTasksQueue.push([resolvedTimeTableUrl, (err, data) => {
                        if (err == null) {
                            let timeTableData = data["bound"][route["bound"]["gmb"]]["timetable"];
                            let times = {};
                            for (let k = 0; k < timeTableData.length; k++) {
                                let timeEntry = timeTableData[k];
                                let dayType = timeEntry["weekday"];
                                let entry = timeEntry["times"];
                                let dayTypeName = timeEntry["weekday_" + language];
                                for (let j = 0; j < entry.length; j++) {
                                    let periodEntry = entry[j];
                                    let time = periodEntry["period"];
                                    let frequency = periodEntry["frequency"];
                                    if (frequency == "") {
                                        frequency = "-";
                                    }

                                    let daysOfWeek = dayType.split("").map(Number);

                                    let now = new Date();
                                    let nowHour = (now.getUTCHours() + 8) % 24;
                                    let nowMinute = now.getUTCMinutes();
                                    let weekday = weekdayNames.indexOf(new Date().toLocaleDateString("en-US", {
                                        timeZone: "Asia/Hong_Kong",
                                        weekday: "long"
                                    })) + 1;

                                    let isNow = false;
                                    let timeMatch = time;
                                    if (timeMatch.includes(",")) {
                                        let timeSections = time.split(",");
                                        timeMatch = timeSections[0].trim() + "-" + timeSections[timeSections.length - 1].trim();
                                    }

                                    let timeRangeStartHour = null;
                                    let timeRangeStartMinute = null;
                                    let timeRangeEndHour = null;
                                    let timeRangeEndMinute = null;
                                    let matcher = /\*?([0-9]{2}):([0-9]{2})(?: *- *([0-9]{2}):([0-9]{2}))?/g.exec(timeMatch);
                                    if (matcher != null) {
                                        timeRangeStartHour = Number(matcher[1]);
                                        timeRangeStartMinute = Number(matcher[2]);

                                        if (matcher[3] != undefined) {
                                            timeRangeEndHour = Number(matcher[3]);
                                            timeRangeEndMinute = Number(matcher[4]);
                                        } else {
                                            timeRangeEndHour = timeRangeStartHour;
                                            timeRangeEndMinute = timeRangeStartMinute + 1;
                                            if (timeRangeEndMinute >= 60) {
                                                timeRangeEndHour = timeRangeEndHour + 1;
                                                timeRangeEndMinute = timeRangeEndMinute % 60;
                                                if (timeRangeEndHour >= 24) {
                                                    timeRangeEndHour = timeRangeEndHour % 24;
                                                }
                                            }
                                        }
                                    }

                                    if (daysOfWeek.indexOf(weekday) >= 0) {
                                        if (timeRangeStartHour > timeRangeEndHour) {
                                            if (nowHour == timeRangeStartHour && nowMinute >= timeRangeStartMinute) {
                                                isNow = true;
                                            } else if (nowHour == timeRangeEndHour && nowMinute < timeRangeEndMinute) {
                                                isNow = true;
                                            } else if (nowHour > timeRangeStartHour || nowHour < timeRangeEndHour) {
                                                isNow = true;
                                            }
                                        } else {
                                            if (nowHour > timeRangeStartHour || (nowHour == timeRangeStartHour && nowMinute >= timeRangeStartMinute)) {
                                                isNow = nowHour < timeRangeEndHour || (nowHour == timeRangeEndHour && nowMinute < timeRangeEndMinute);
                                            }
                                        }
                                    }

                                    if (!times.hasOwnProperty(dayTypeName)) {
                                        times[dayTypeName] = [];
                                    }
                                    times[dayTypeName].push([time, frequency, daysOfWeek, isNow]);
                                }
                            }

                            let tables = [];
                            for (let dayTypeName in times) {
                                let entries = times[dayTypeName];
                                let rows = [];
                                for (let u = 0; u < entries.length; u++) {
                                    let entry = entries[u];
                                    let daysOfWeek = entry[2];
                                    let isNow = entry[3];

                                    let fontWeight = isNow ? "bold" : "normal";
                                    if (daysOfWeek.length == 0) {
                                        rows.push(
                                            "<tr>" +
                                                "<th style=\"font-weight: " + fontWeight + "; white-space: nowrap;\">" + entry[0] + "</th>" +
                                                "<th style=\"font-weight: " + fontWeight + "; white-space: nowrap; text-align: right;\">-</th>" +
                                            "</tr>"
                                        );
                                    } else {
                                        rows.push(
                                            "<tr>" +
                                                "<th style=\"font-weight: " + fontWeight + "; white-space: nowrap;\">" + entry[0] + "</th>" +
                                                "<th style=\"font-weight: " + fontWeight + "; white-space: nowrap; text-align: right;\">" + entry[1] + "</th>" +
                                            "</tr>"
                                        );
                                    }
                                }
                                let table = 
                                    "<table class=\"table\" style=\"word-break: keep-all;\">" +
                                        "<tbody>" +
                                            "<tr>" +
                                                "<th>" + dayTypeName + "</th>" +
                                                "<th style=\"text-align: right;\">" + (language == "en" ? "Frequency (Min.)" : "班次(分鐘)") + "</th>" +
                                            "</tr>" + 
                                            rows.join("") +
                                        "</tbody>" +
                                    "</table>";

                                tables.push(table);
                            }

                            if (tables.length == 0) {
                                tables.push(language == "en" ? "On specific day only" : "於指定日期服務");
                            }

                            let tableTableTitle = language == "en" ? ("Route " + routeNumberDisplay + " Timetable (GMB)") : ("路線" + routeNumberDisplay + "時間表(專線小巴)");
                            let append = 
                                "<h5 class=\"title is-5 has-text-black\" style=\"min-width: 100px; width: 100%;\">" + tableTableTitle + "</h5>" + 
                                "<div class=\"columns\">" +
                                    "<div class=\"column\">" +
                                        tables.join("</div><div class=\"column\">") +
                                    "</div>" +
                                "</div>";

                            let toggleParameter = localStorage.getItem("toggle-options");
                            if ((Number(toggleParameter) & 0x02) == 0 && document.getElementById('time-table').innerHTML == "") {
                                document.getElementById('time-table').style.display = "";
                                document.getElementById("time-table").innerHTML = append;
                            } else {
                                document.getElementById("time-table").innerHTML += "<hr style=\"border-top: 1px solid #eee;\">" + append;
                            }
                        } else {
                            printConnectionError("Unable to get response from " + resolvedTimeTableUrl + ". (Is it down?)");
                        }
                        calculateTasks.splice(calculateTasks.indexOf(task1Id), 1);
                    }]);
                } else if (co == "nlb") {
                    let resolvedSpecialUrl = nlbInfoUrl.replace("{id}", route["nlbId"]);
                    let task0Id = makeId(10);
                    calculateTasks.push(task0Id);
                    getJSONTasksQueue.push(["./dummy.txt", (err, data) => {
                        if (err == null) {
                            let messages = ["<a class=\"special-annoucement-href\" href=\"" + resolvedSpecialUrl + "\" target=\"_blank\">" + (language == "en" ? "Click to view" : "點擊查看") + "</a>"];
                            if (messages.length > 0) {
                                let html;
                                if (language == "en") {
                                    html = "[Route " + routeNumberDisplay + " Additional Info (NLB)]<br> " + messages.join("<br>");
                                } else {
                                    html = "[路線" + routeNumberDisplay + "詳細資料(嶼巴)]<br> " + messages.join("<br>");
                                }
                                if (document.getElementById('special-announcements').innerHTML == "") {
                                    document.getElementById('special-announcements').style.display = "";
                                    document.getElementById('special-announcements').innerHTML = html;
                                } else {
                                    document.getElementById('special-announcements').innerHTML += "<br><br>" + html
                                }
                            }
                        } else {
                            printConnectionError("Unable to get response from ./dummy.txt. (Is it down?)");
                        }
                        calculateTasks.splice(calculateTasks.indexOf(task0Id), 1);
                    }]);

                    let resolvedTimeTableUrl = "https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/route_data_nlb/" + route["nlbId"] + ".json";
                    let task1Id = makeId(10);
                    calculateTasks.push(task1Id);
                    getJSONTasksQueue.push([resolvedTimeTableUrl, (err, data) => {
                        if (err == null) {
                            let timeTableData = data["timetable"];
                            let times = {};
                            for (let k = 0; k < timeTableData.length; k++) {
                                let timeEntry = timeTableData[k];
                                let dayType = timeEntry["weekday"];
                                let entry = timeEntry["times"];
                                let dayTypeName = timeEntry["weekday_" + language];
                                for (let j = 0; j < entry.length; j++) {
                                    let periodEntry = entry[j];
                                    let time = periodEntry["period"];
                                    let frequency = periodEntry["frequency"];
                                    if (frequency == "") {
                                        frequency = "-";
                                    }

                                    let daysOfWeek = dayType.split("").map(Number);

                                    let now = new Date();
                                    let nowHour = (now.getUTCHours() + 8) % 24;
                                    let nowMinute = now.getUTCMinutes();
                                    let weekday = weekdayNames.indexOf(new Date().toLocaleDateString("en-US", {
                                        timeZone: "Asia/Hong_Kong",
                                        weekday: "long"
                                    })) + 1;

                                    let isNow = false;
                                    let timeMatch = time;
                                    if (timeMatch.includes(",")) {
                                        let timeSections = time.split(",");
                                        timeMatch = timeSections[0].trim() + "-" + timeSections[timeSections.length - 1].trim();
                                    }

                                    let timeRangeStartHour = null;
                                    let timeRangeStartMinute = null;
                                    let timeRangeEndHour = null;
                                    let timeRangeEndMinute = null;
                                    let matcher = /\*?([0-9]{2}):([0-9]{2})(?: *- *([0-9]{2}):([0-9]{2}))?/g.exec(timeMatch);
                                    if (matcher != null) {
                                        timeRangeStartHour = Number(matcher[1]);
                                        timeRangeStartMinute = Number(matcher[2]);

                                        if (matcher[3] != undefined) {
                                            timeRangeEndHour = Number(matcher[3]);
                                            timeRangeEndMinute = Number(matcher[4]);
                                        } else {
                                            timeRangeEndHour = timeRangeStartHour;
                                            timeRangeEndMinute = timeRangeStartMinute + 1;
                                            if (timeRangeEndMinute >= 60) {
                                                timeRangeEndHour = timeRangeEndHour + 1;
                                                timeRangeEndMinute = timeRangeEndMinute % 60;
                                                if (timeRangeEndHour >= 24) {
                                                    timeRangeEndHour = timeRangeEndHour % 24;
                                                }
                                            }
                                        }
                                    }

                                    if (daysOfWeek.indexOf(weekday) >= 0) {
                                        if (timeRangeStartHour > timeRangeEndHour) {
                                            if (nowHour == timeRangeStartHour && nowMinute >= timeRangeStartMinute) {
                                                isNow = true;
                                            } else if (nowHour == timeRangeEndHour && nowMinute < timeRangeEndMinute) {
                                                isNow = true;
                                            } else if (nowHour > timeRangeStartHour || nowHour < timeRangeEndHour) {
                                                isNow = true;
                                            }
                                        } else {
                                            if (nowHour > timeRangeStartHour || (nowHour == timeRangeStartHour && nowMinute >= timeRangeStartMinute)) {
                                                isNow = nowHour < timeRangeEndHour || (nowHour == timeRangeEndHour && nowMinute < timeRangeEndMinute);
                                            }
                                        }
                                    }

                                    if (!times.hasOwnProperty(dayTypeName)) {
                                        times[dayTypeName] = [];
                                    }
                                    times[dayTypeName].push([time, frequency, daysOfWeek, isNow]);
                                }
                            }

                            let tables = [];
                            for (let dayTypeName in times) {
                                let entries = times[dayTypeName];
                                let rows = [];
                                for (let u = 0; u < entries.length; u++) {
                                    let entry = entries[u];
                                    let daysOfWeek = entry[2];
                                    let isNow = entry[3];

                                    let fontWeight = isNow ? "bold" : "normal";
                                    if (daysOfWeek.length == 0) {
                                        rows.push(
                                            "<tr>" +
                                                "<th style=\"font-weight: " + fontWeight + "; white-space: nowrap;\">" + entry[0] + "</th>" +
                                                "<th style=\"font-weight: " + fontWeight + "; white-space: nowrap; text-align: right;\">-</th>" +
                                            "</tr>"
                                        );
                                    } else {
                                        rows.push(
                                            "<tr>" +
                                                "<th style=\"font-weight: " + fontWeight + "; white-space: nowrap;\">" + entry[0] + "</th>" +
                                                "<th style=\"font-weight: " + fontWeight + "; white-space: nowrap; text-align: right;\">" + entry[1] + "</th>" +
                                            "</tr>"
                                        );
                                    }
                                }
                                let table = 
                                    "<table class=\"table\" style=\"word-break: keep-all;\">" +
                                        "<tbody>" +
                                            "<tr>" +
                                                "<th>" + dayTypeName + "</th>" +
                                                "<th style=\"text-align: right;\">" + (language == "en" ? "Frequency (Min.)" : "班次(分鐘)") + "</th>" +
                                            "</tr>" + 
                                            rows.join("") +
                                        "</tbody>" +
                                    "</table>";

                                tables.push(table);
                            }

                            if (tables.length == 0) {
                                tables.push(language == "en" ? "On specific day only" : "於指定日期服務");
                            }

                            let tableTableTitle = language == "en" ? ("Route " + routeNumberDisplay + " Timetable (NLB)") : ("路線" + routeNumberDisplay + "時間表(嶼巴)");
                            let append = 
                                "<h5 class=\"title is-5 has-text-black\" style=\"min-width: 100px; width: 100%;\">" + tableTableTitle + "</h5>" + 
                                "<div class=\"columns\">" +
                                    "<div class=\"column\">" +
                                        tables.join("</div><div class=\"column\">") +
                                    "</div>" +
                                "</div>";

                            let toggleParameter = localStorage.getItem("toggle-options");
                            if ((Number(toggleParameter) & 0x02) == 0 && document.getElementById('time-table').innerHTML == "") {
                                document.getElementById('time-table').style.display = "";
                                document.getElementById("time-table").innerHTML = append;
                            } else {
                                document.getElementById("time-table").innerHTML += "<hr style=\"border-top: 1px solid #eee;\">" + append;
                            }
                        } else {
                            printConnectionError("Unable to get response from " + resolvedTimeTableUrl + ". (Is it down?)");
                        }
                        calculateTasks.splice(calculateTasks.indexOf(task1Id), 1);
                    }]);
                } else if (co == "mtr-bus") {
                    let resolvedSpecialUrl = mtrBusInfoUrl.replace("{route}", route["route"]).replace("{lang}", language == "en" ? "en" : "ch");
                    let task0Id = makeId(10);
                    calculateTasks.push(task0Id);
                    getJSONTasksQueue.push(["./dummy.txt", (err, data) => {
                        if (err == null) {
                            let messages = ["<a class=\"special-annoucement-href\" href=\"" + resolvedSpecialUrl + "\" target=\"_blank\">" + (language == "en" ? "Click to view" : "點擊查看") + "</a>"];
                            if (messages.length > 0) {
                                let html;
                                if (language == "en") {
                                    html = "[Route " + routeNumberDisplay + " Additional Info (MTR-Bus)]<br> " + messages.join("<br>");
                                } else {
                                    html = "[路線" + routeNumberDisplay + "詳細資料(港鐵巴士)]<br> " + messages.join("<br>");
                                }
                                if (document.getElementById('special-announcements').innerHTML == "") {
                                    document.getElementById('special-announcements').style.display = "";
                                    document.getElementById('special-announcements').innerHTML = html;
                                } else {
                                    document.getElementById('special-announcements').innerHTML += "<br><br>" + html
                                }
                            }
                        } else {
                            printConnectionError("Unable to get response from ./dummy.txt. (Is it down?)");
                        }
                        calculateTasks.splice(calculateTasks.indexOf(task0Id), 1);
                    }]);

                    let resolvedTimeTableUrl = "https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/route_data_mtr_bus/" + route["route"] + ".json";
                    let task1Id = makeId(10);
                    calculateTasks.push(task1Id);
                    getJSONTasksQueue.push([resolvedTimeTableUrl, (err, data) => {
                        if (err == null) {
                            let timeTableData = data["bound"][route["bound"]["mtr-bus"]]["timetable"];
                            let times = {};
                            for (let k = 0; k < timeTableData.length; k++) {
                                let timeEntry = timeTableData[k];
                                let dayType = timeEntry["weekday"];
                                let entry = timeEntry["times"];
                                let dayTypeName = timeEntry["weekday_" + language];
                                for (let j = 0; j < entry.length; j++) {
                                    let periodEntry = entry[j];
                                    let time = periodEntry["period"];
                                    let frequency = periodEntry["frequency"];
                                    if (frequency == "") {
                                        frequency = "-";
                                    }

                                    let daysOfWeek = dayType.split("").map(Number);

                                    let now = new Date();
                                    let nowHour = (now.getUTCHours() + 8) % 24;
                                    let nowMinute = now.getUTCMinutes();
                                    let weekday = weekdayNames.indexOf(new Date().toLocaleDateString("en-US", {
                                        timeZone: "Asia/Hong_Kong",
                                        weekday: "long"
                                    })) + 1;

                                    let isNow = false;
                                    let timeSections = time.split(",");

                                    for (let i = 0; i < timeSections.length && !isNow; i++) {
                                        let timeRangeStartHour = null;
                                        let timeRangeStartMinute = null;
                                        let timeRangeEndHour = null;
                                        let timeRangeEndMinute = null;
                                        let matcher = /\*?([0-9]{2}):([0-9]{2})(?: *- *([0-9]{2}):([0-9]{2}))?/g.exec(timeSections[i]);
                                        if (matcher != null) {
                                            timeRangeStartHour = Number(matcher[1]);
                                            timeRangeStartMinute = Number(matcher[2]);

                                            if (matcher[3] != undefined) {
                                                timeRangeEndHour = Number(matcher[3]);
                                                timeRangeEndMinute = Number(matcher[4]);
                                            } else {
                                                timeRangeEndHour = timeRangeStartHour;
                                                timeRangeEndMinute = timeRangeStartMinute + 1;
                                                if (timeRangeEndMinute >= 60) {
                                                    timeRangeEndHour = timeRangeEndHour + 1;
                                                    timeRangeEndMinute = timeRangeEndMinute % 60;
                                                    if (timeRangeEndHour >= 24) {
                                                        timeRangeEndHour = timeRangeEndHour % 24;
                                                    }
                                                }
                                            }
                                        }

                                        if (daysOfWeek.indexOf(weekday) >= 0) {
                                            if (timeRangeStartHour > timeRangeEndHour) {
                                                if (nowHour == timeRangeStartHour && nowMinute >= timeRangeStartMinute) {
                                                    isNow = true;
                                                } else if (nowHour == timeRangeEndHour && nowMinute < timeRangeEndMinute) {
                                                    isNow = true;
                                                } else if (nowHour > timeRangeStartHour || nowHour < timeRangeEndHour) {
                                                    isNow = true;
                                                }
                                            } else {
                                                if (nowHour > timeRangeStartHour || (nowHour == timeRangeStartHour && nowMinute >= timeRangeStartMinute)) {
                                                    isNow = nowHour < timeRangeEndHour || (nowHour == timeRangeEndHour && nowMinute < timeRangeEndMinute);
                                                }
                                            }
                                        }
                                    }

                                    if (!times.hasOwnProperty(dayTypeName)) {
                                        times[dayTypeName] = [];
                                    }
                                    times[dayTypeName].push([time, frequency, daysOfWeek, isNow]);
                                }
                            }

                            let tables = [];
                            for (let dayTypeName in times) {
                                let entries = times[dayTypeName];
                                let rows = [];
                                for (let u = 0; u < entries.length; u++) {
                                    let entry = entries[u];
                                    let daysOfWeek = entry[2];
                                    let isNow = entry[3];

                                    let fontWeight = isNow ? "bold" : "normal";
                                    if (daysOfWeek.length == 0) {
                                        rows.push(
                                            "<tr>" +
                                                "<th style=\"font-weight: " + fontWeight + "; white-space: nowrap;\">" + entry[0] + "</th>" +
                                                "<th style=\"font-weight: " + fontWeight + "; white-space: nowrap; text-align: right;\">-</th>" +
                                            "</tr>"
                                        );
                                    } else {
                                        rows.push(
                                            "<tr>" +
                                                "<th style=\"font-weight: " + fontWeight + "; white-space: nowrap;\">" + entry[0] + "</th>" +
                                                "<th style=\"font-weight: " + fontWeight + "; white-space: nowrap; text-align: right;\">" + entry[1] + "</th>" +
                                            "</tr>"
                                        );
                                    }
                                }
                                let table = 
                                    "<table class=\"table\" style=\"word-break: keep-all;\">" +
                                        "<tbody>" +
                                            "<tr>" +
                                                "<th>" + dayTypeName + "</th>" +
                                                "<th style=\"text-align: right;\">" + (language == "en" ? "Frequency (Min.)" : "班次(分鐘)") + "</th>" +
                                            "</tr>" + 
                                            rows.join("") +
                                        "</tbody>" +
                                    "</table>";

                                tables.push(table);
                            }

                            if (tables.length == 0) {
                                tables.push(language == "en" ? "On specific day only" : "於指定日期服務");
                            }

                            let tableTableTitle = language == "en" ? ("Route " + routeNumberDisplay + " Timetable (MTR-Bus)") : ("路線" + routeNumberDisplay + "時間表(港鐵巴士)");
                            let append = 
                                "<h5 class=\"title is-5 has-text-black\" style=\"min-width: 100px; width: 100%;\">" + tableTableTitle + "</h5>" + 
                                "<div class=\"columns\">" +
                                    "<div class=\"column\">" +
                                        tables.join("</div><div class=\"column\">") +
                                    "</div>" +
                                "</div>";

                            let toggleParameter = localStorage.getItem("toggle-options");
                            if ((Number(toggleParameter) & 0x02) == 0 && document.getElementById('time-table').innerHTML == "") {
                                document.getElementById('time-table').style.display = "";
                                document.getElementById("time-table").innerHTML = append;
                            } else {
                                document.getElementById("time-table").innerHTML += "<hr style=\"border-top: 1px solid #eee;\">" + append;
                            }
                        } else {
                            printConnectionError("Unable to get response from " + resolvedTimeTableUrl + ". (Is it down?)");
                        }
                        calculateTasks.splice(calculateTasks.indexOf(task1Id), 1);
                    }]);
                }

                let stopNames = entry[9];
                let stopDetails = entry[10];
                for (let u = 0; u < stopNames.length; u++) {
                    let stopName = stopNames[u];
                    let stopPosition = stopDetails[u][1]["location"];
                    let routeNumber = route["route"];
                    let desc = (u + 1) + ". " + applyBbiStopHref(entry[14][u]);
                    let positionArray = [stopPosition["lat"], stopPosition["lng"]];
                    let stopId = stopDetails[u][0];
                    let stopIds = {"current": stopId};
                    if ((u + 1) < stopNames.length) {
                        stopIds["next"] = stopDetails[u + 1][0];
                    }
                    if (u > 0) {
                        stopIds["previous"] = stopDetails[u - 1][0];
                    }
                    let stopMarker;
                    if (u < entry[12] || u > entry[13]) {
                        stopMarker = [[routeNumber], 4, desc, positionArray, i, u, co, routeNumberDisplay, new Map()];
                    } else if (u == entry[12]) {
                        stopMarker = [[routeNumber], 0, desc, positionArray, i, u, co, routeNumberDisplay, new Map()];
                    } else if (u == entry[13]) {
                        stopMarker = [[routeNumber], i + 1 == rowsData.length ? 1 : 2, desc, positionArray, i, u, co, routeNumberDisplay, new Map()];
                    } else {
                        stopMarker = [[routeNumber], 3, desc, positionArray, i, u, co, routeNumberDisplay, new Map()];
                    }
                    let stopType = stopMarker[1];
                    if (stopType == 0) {
                        if (stopIds.hasOwnProperty("previous")) {
                            stopIds["previous_end"] = stopIds["previous"];
                            delete stopIds["previous"];
                        }
                    } else if (stopType == 1 || stopType == 2) {
                        if (stopIds.hasOwnProperty("next")) {
                            stopIds["next_end"] = stopIds["next"];
                            delete stopIds["next"];
                        }
                    } else if (stopType == 4) {
                        if (stopIds.hasOwnProperty("previous")) {
                            stopIds["previous_alt"] = stopIds["previous"];
                            delete stopIds["previous"];
                        }
                        if (stopIds.hasOwnProperty("next")) {
                            stopIds["next_alt"] = stopIds["next"];
                            delete stopIds["next"];
                        }
                    }
                    if (stopMarkerData.has(stopDetails[u][0])) {
                        stopMarkerData.get(stopDetails[u][0])[0].push(stopMarker[0][0]);
                        if (stopMarkerData.get(stopDetails[u][0])[0].indexOf(route["route"]) >= 0) {
                            if (stopMarkerData.get(stopDetails[u][0])[1] == 0) {
                                if (stopMarker[1] == 1) {
                                    stopMarkerData.get(stopDetails[u][0])[1] = 5;
                                }
                            } else {
                                if (stopMarkerData.get(stopDetails[u][0])[1] == 4 && stopMarker[1] == 1) {
                                    stopMarkerData.get(stopDetails[u][0])[1] = 1;
                                }
                                stopMarkerData.get(stopDetails[u][0])[2] = stopMarker[2];
                            }
                        } else {
                            stopMarkerData.get(stopDetails[u][0])[2] = stopMarker[2];
                        }
                        if (stopMarkerData.get(stopDetails[u][0])[1] == 4) {
                            stopMarkerData.get(stopDetails[u][0])[1] = stopMarker[1];
                        }
                    } else {
                        stopMarkerData.set(stopDetails[u][0], stopMarker);
                    }
                    let map = stopMarkerData.get(stopDetails[u][0])[8];
                    if (map.has(routeNumber)) {
                        map.set(routeNumber, {...map.get(routeNumber), ...stopIds});
                    } else {
                        map.set(routeNumber, stopIds);
                    }
                }

                if (co == "kmb") {
                    let task2Id = makeId(10);
                    calculateTasks.push(task2Id);
                    getJSON("https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/route_paths/" + route["route"] + ".json", (err, data) => {
                        try {
                            if (err == null) {                
                                let sections = data[route["bound"]["kmb"]][route["serviceType"]];
                                if (sections == undefined) {
                                    return;
                                }
                                for (let i = 0; i < sections.length; i++) {
                                    let path = sections[i];
                                    let pointListBefore = [];
                                    let pointListRoute = [];
                                    let pointListAfter = [];
                                    for (let u = 0; u < path.length; u++) {
                                        let position = path[u];
                                        if (i < entry[12]) {
                                            pointListBefore.push(new L.LatLng(position[0], position[1]));
                                        } else if (i > entry[13] - 1) {
                                            pointListAfter.push(new L.LatLng(position[0], position[1]));
                                        } else {
                                            pointListRoute.push(new L.LatLng(position[0], position[1]));
                                        }
                                    }
                                    let desc;
                                    if (language == "en") {
                                        desc = "<b style=\"font-size: 17px\">" + routeNumberDisplay + " <span style=\"font-size: 12px\">To </span><span style=\"font-size: 15px\">" + capitalize(route["dest"]["en"]) + "</span></b>";
                                    } else {
                                        desc = "<b style=\"font-size: 17px\">" + routeNumberDisplay + " <span style=\"font-size: 12px\">往</span><span style=\"font-size: 15px\">" + route["dest"]["zh"] + "</span></b>";
                                    }
                                    if (pointListBefore.length > 0) {
                                        new L.Polyline(pointListBefore, {
                                            color: '#141414',
                                            weight: 3,
                                            opacity: 0.5,
                                            smoothFactor: 1
                                        }).addTo(lines).bindPopup(desc).on("mouseover", e => {if (!isPopupMobile() && !isClicked) {e.target.openPopup(e.latlng)};}).on("mouseout", e => {if (!isClicked) {e.target.closePopup()};}).on("click", e => {isClicked = true; e.target.openPopup();});
                                    }
                                    new L.Polyline(pointListRoute, {
                                        color: 'red',
                                        weight: 4,
                                        opacity: 1,
                                        smoothFactor: 1
                                    }).addTo(lines).addTo(activeRouteMarker).bindPopup(desc).on("mouseover", e => {if (!isPopupMobile() && !isClicked) {e.target.openPopup(e.latlng)};}).on("mouseout", e => {if (!isClicked) {e.target.closePopup()};}).on("click", e => {isClicked = true; e.target.openPopup();});
                                    if (pointListAfter.length > 0) {
                                        new L.Polyline(pointListAfter, {
                                            color: '#141414',
                                            weight: 3,
                                            opacity: 0.5,
                                            smoothFactor: 1
                                        }).addTo(lines).bindPopup(desc).on("mouseover", e => {if (!isPopupMobile() && !isClicked) {e.target.openPopup(e.latlng)};}).on("mouseout", e => {if (!isClicked) {e.target.closePopup()};}).on("click", e => {isClicked = true; e.target.openPopup();});
                                    }
                                }
                                map.flyToBounds(activeRouteMarker.getBounds(), {"duration": 1, "paddingTopLeft": [17, 17], "paddingBottomRight": [17, 17]});
                            } else {
                                printConnectionError("Unable to get response from https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/route_paths/" + route["route"] + ".json. (Is it down?)");
                            }
                        } finally {
                            calculateTasks.splice(calculateTasks.indexOf(task2Id), 1);
                        }
                    });
                } else if (false && co == "ctb") {
                    let task2Id = makeId(10);
                    calculateTasks.push(task2Id);
                    getJSON("https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/route_paths_ctb/" + route["route"] + ".json", (err, data) => {
                        try {
                            if (err == null) {                
                                let sections;
                                if (route["bound"]["ctb"].length > 1) {
                                    sections = {...data[route["bound"]["ctb"]]["O"], ...data[route["bound"]["ctb"]]["I"]};
                                } else {
                                    sections = data[route["bound"]["ctb"]];
                                }
                                let stops = route["stops"]["ctb"];
                                for (let i = 0; i < stops.length - 1; i++) {
                                    let key = stops[i] + "+" + stops[i + 1];
                                    let path = sections[key];
                                    if (path == undefined || path == null) {
                                        let stop1 = dataSheet["stopList"][stops[i]]["location"];
                                        let stop2 = dataSheet["stopList"][stops[i + 1]]["location"];
                                        path = [[stop1["lat"], stop1["lng"]], [stop2["lat"], stop2["lng"]]];
                                    }
                                    let pointListBefore = [];
                                    let pointListRoute = [];
                                    let pointListAfter = [];
                                    for (let u = 0; u < path.length; u++) {
                                        let position = path[u];
                                        if (i < entry[12]) {
                                            pointListBefore.push(new L.LatLng(position[0], position[1]));
                                        } else if (i > entry[13] - 1) {
                                            pointListAfter.push(new L.LatLng(position[0], position[1]));
                                        } else {
                                            pointListRoute.push(new L.LatLng(position[0], position[1]));
                                        }
                                    }
                                    let coStr = language == "en" ? " - CTB" : " - 城巴";
                                    let desc;
                                    if (language == "en") {
                                        desc = "<b style=\"font-size: 17px\">" + routeNumberDisplay + " <span style=\"font-size: 12px\">To </span><span style=\"font-size: 15px\">" + capitalize(route["dest"]["en"]) + coStr + "</span></b>";
                                    } else {
                                        desc = "<b style=\"font-size: 17px\">" + routeNumberDisplay + " <span style=\"font-size: 12px\">往</span><span style=\"font-size: 15px\">" + route["dest"]["zh"] + coStr + "</span></b>";
                                    }
                                    if (pointListBefore.length > 0) {
                                        new L.Polyline(pointListBefore, {
                                            color: '#141414',
                                            weight: 3,
                                            opacity: 0.5,
                                            smoothFactor: 1
                                        }).addTo(lines).bindPopup(desc).on("mouseover", e => {if (!isPopupMobile() && !isClicked) {e.target.openPopup(e.latlng)};}).on("mouseout", e => {if (!isClicked) {e.target.closePopup()};}).on("click", e => {isClicked = true; e.target.openPopup();});
                                    }
                                    new L.Polyline(pointListRoute, {
                                        color: 'gold',
                                        weight: 4,
                                        opacity: 1,
                                        smoothFactor: 1
                                    }).addTo(lines).addTo(activeRouteMarker).bindPopup(desc).on("mouseover", e => {if (!isPopupMobile() && !isClicked) {e.target.openPopup(e.latlng)};}).on("mouseout", e => {if (!isClicked) {e.target.closePopup()};}).on("click", e => {isClicked = true; e.target.openPopup();});
                                    if (pointListAfter.length > 0) {
                                        new L.Polyline(pointListAfter, {
                                            color: '#141414',
                                            weight: 3,
                                            opacity: 0.5,
                                            smoothFactor: 1
                                        }).addTo(lines).bindPopup(desc).on("mouseover", e => {if (!isPopupMobile() && !isClicked) {e.target.openPopup(e.latlng)};}).on("mouseout", e => {if (!isClicked) {e.target.closePopup()};}).on("click", e => {isClicked = true; e.target.openPopup();});
                                    }
                                }
                                map.flyToBounds(activeRouteMarker.getBounds(), {"duration": 1, "paddingTopLeft": [17, 17], "paddingBottomRight": [17, 17]});
                            } else {
                                printConnectionError("Unable to get response from https://raw.githubusercontent.com/LOOHP/HK-KMB-Calculator/data/data/route_paths/" + route["route"] + ".json. (Is it down?)");
                            }
                        } finally {
                            calculateTasks.splice(calculateTasks.indexOf(task2Id), 1);
                        }
                    });
                } else if (co == "ctb" || co == "nlb" || co == "mtr-bus" || co == "gmb") {
                    let pointListBefore = [];
                    let pointListRoute = [];
                    let pointListAfter = [];
                    for (let i = 0; i < entry[10].length; i++) {
                        let position = entry[10][i][1]["location"];
                        if (i < entry[12]) {
                            pointListBefore.push(new L.LatLng(position["lat"], position["lng"]));
                        } else if (i > entry[13] - 1) {
                            pointListAfter.push(new L.LatLng(position["lat"], position["lng"]));
                            if (i == entry[13]) {
                                pointListRoute.push(new L.LatLng(position["lat"], position["lng"]));
                            }
                        } else {
                            pointListRoute.push(new L.LatLng(position["lat"], position["lng"]));
                            if (i == entry[12]) {
                                pointListBefore.push(new L.LatLng(position["lat"], position["lng"]));
                            }
                        }
                    }
                    let coStr = "";
                    if (co == "ctb") {
                        coStr = language == "en" ? " - CTB" : " - 城巴";
                    } else if (co == "nlb") {
                        coStr = language == "en" ? " - NLB" : " - 嶼巴";
                    } else if (co == "mtr-bus") {
                        coStr = language == "en" ? " - MTR-Bus" : " - 港鐵巴士";
                    } else if (co == "gmb") {
                        coStr = language == "en" ? " - GMB" : " - 專線小巴";
                    }
                    let desc;
                    if (language == "en") {
                        desc = "<b style=\"font-size: 17px\">" + routeNumberDisplay + " <span style=\"font-size: 12px\">To </span><span style=\"font-size: 15px\">" + capitalize(route["dest"]["en"]) + coStr + "</span></b>";
                    } else {
                        desc = "<b style=\"font-size: 17px\">" + routeNumberDisplay + " <span style=\"font-size: 12px\">往</span><span style=\"font-size: 15px\">" + route["dest"]["zh"] + coStr + "</span></b>";
                    }
                    let color = co == "ctb" ? "gold" : (co == "nlb" ? "#4A8765" : (co == "mtr-bus" ? "#003972" : "#00BC0C"));
                    if (pointListBefore.length > 0) {
                        new L.Polyline(pointListBefore, {
                            color: '#141414',
                            weight: 3,
                            opacity: 0.5,
                            smoothFactor: 1
                        }).addTo(lines).bindPopup(desc).on("mouseover", e => {if (!isPopupMobile() && !isClicked) {e.target.openPopup(e.latlng)};}).on("mouseout", e => {if (!isClicked) {e.target.closePopup()};}).on("click", e => {isClicked = true; e.target.openPopup();});
                    }
                    new L.Polyline(pointListRoute, {
                        color: color,
                        weight: 4,
                        opacity: 1,
                        smoothFactor: 1
                    }).addTo(lines).addTo(activeRouteMarker).bindPopup(desc).on("mouseover", e => {if (!isPopupMobile() && !isClicked) {e.target.openPopup(e.latlng)};}).on("mouseout", e => {if (!isClicked) {e.target.closePopup()};}).on("click", e => {isClicked = true; e.target.openPopup();});
                    if (pointListAfter.length > 0) {
                        new L.Polyline(pointListAfter, {
                            color: '#141414',
                            weight: 3,
                            opacity: 0.5,
                            smoothFactor: 1
                        }).addTo(lines).bindPopup(desc).on("mouseover", e => {if (!isPopupMobile() && !isClicked) {e.target.openPopup(e.latlng)};}).on("mouseout", e => {if (!isClicked) {e.target.closePopup()};}).on("click", e => {isClicked = true; e.target.openPopup();});
                    }
                    map.flyToBounds(activeRouteMarker.getBounds(), {"duration": 1, "paddingTopLeft": [17, 17], "paddingBottomRight": [17, 17]});
                }
            }

            executeGetGSONTasks(getJSONTasksQueue);

            let etaTables = [];
            let tableKeys = [];
            let pinsPosition = new Set();
            for (let key of stopMarkerData.keys()) {
                let stopMarker = stopMarkerData.get(key);
                let routes = stopMarker[0];
                let stopType = stopMarker[1];
                let desc = stopMarker[2];
                let co = stopMarker[6];
                let routeNumberDisplay = stopMarker[7];
                let stopIds = stopMarker[8];
                if (rowsData.length > 1) {
                    desc = "[" + routes.filter((value, index, array) => array.indexOf(value) === index).join("/") + "] " + desc;
                }
                let coStr = "";
                if (co == "ctb") {
                    coStr = language == "en" ? " - CTB" : " - 城巴";
                } else if (co == "nlb") {
                    coStr = language == "en" ? " - NLB" : " - 嶼巴";
                } else if (co == "mtr-bus") {
                    coStr = language == "en" ? " - MTR-Bus" : " - 港鐵巴士";
                } else if (co == "gmb") {
                    coStr = language == "en" ? " - GMB" : " - 專線小巴";
                }
                desc = "<p style=\"text-align: center;\">" + desc + coStr + "</p>"
                let icon;
                if (stopType == 0 || stopType == 5) {
                    if (stopType == 5) {
                        desc += "<p style=\"text-align: center; font-size: 20px;\">" + (language == "en" ? "Please board/alight at this stop" : "請在此站上車/落車") + "</p>";
                    } else {
                        desc += "<p style=\"text-align: center; font-size: 20px;\">" + (language == "en" ? "Please board at this stop" : "請在此站上車") + "</p>";
                    }
                    icon = redIcon;
                    let tableKey = rowsData[stopMarker[4]][8]["route"] + "_" + (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : rowsData[stopMarker[4]][8]["bound"][co]);
                    if (tableKeys.indexOf(tableKey) < 0) {
                        let table = 
                            "<h5 class=\"title is-5 has-text-black\" style=\"min-width: 100px; width: 100%;\">" + (language == "en" ? "Route " : "路線") + routeNumberDisplay + (language == "en" ? " ETA" : "預計到達時間") + (co == "ctb" ? (language == "en" ? "(CTB)" : "(城巴)") : "") + (co == "nlb" ? (language == "en" ? "(NLB)" : "(嶼巴)") : "") + (co == "mtr-bus" ? (language == "en" ? "(MTR-Bus)" : "(港鐵巴士)") : "") + (co == "gmb" ? (language == "en" ? "(GMB)" : "(專線小巴)") : "") + "</h5>" + 
                            "<table class=\"table\" style=\"word-break: keep-all;\">" +
                                "<tbody>" +
                                    "<tr>" +
                                        "<th style=\"text-align: center;\"><b style=\"font-size: 25px;\"></b><b class=\"eta-table-stop-title\" style=\"white-space: nowrap;\">" + applyBbiStopHref(rowsData[stopMarker[4]][14][rowsData[stopMarker[4]][12]]) + "</b></th>" +
                                    "</tr>" + 
                                    "<tr>" +
                                        "<th style=\"font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"eta_" + co + "," + rowsData[stopMarker[4]][11][rowsData[stopMarker[4]][12]] + "," + routes[0] + "," + (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : rowsData[stopMarker[4]][8]["bound"][co])) + ",1,25,0\"></th>" +
                                    "</tr>" + 
                                    "<tr>" +
                                        "<th style=\"font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"eta_" + co + "," + rowsData[stopMarker[4]][11][rowsData[stopMarker[4]][12]] + "," + routes[0] + "," + (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : rowsData[stopMarker[4]][8]["bound"][co])) + ",2,25,0\"></th>" +
                                    "</tr>" + 
                                    "<tr>" +
                                        "<th style=\"font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"eta_" + co + "," + rowsData[stopMarker[4]][11][rowsData[stopMarker[4]][12]] + "," + routes[0] + "," + (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : rowsData[stopMarker[4]][8]["bound"][co])) + ",3,25,0\"></th>" +
                                    "</tr>" + 
                                "</tbody>" +
                            "</table>";

                        etaTables.push(table);
                        tableKeys.push(tableKey);
                    }
                } else if (stopType == 1) {
                    desc += "<p style=\"text-align: center; font-size: 20px;\">" + (language == "en" ? "Please alight at this stop" : "請在此站落車") + "</p>"
                    icon = redIcon;
                } else if (stopType == 2) {
                    if (routes.length == 1) {
                        let nextEntry = rowsData[stopMarker[4] + 1];
                        let changeTo = nextEntry[0];
                        desc += "<p style=\"text-align: center; font-size: 20px;\">" + (language == "en" ? "Please interchange at this stop " : "請在此站轉車 ") + routes[0] + " 🡒 " + changeTo + "</p><p style=\"text-align: center; font-size: 15px;\">(" + (language == "en" ? "Walk to " : "步行至 ") + nextEntry[14][nextEntry[12]] + ")";
                    } else {
                        let changeTo;
                        if (Array.from(stopMarkerData.values()).some(e => e[0].indexOf(routes[1]) >= 0 && e[1] == 0)) {
                            let nextEntry = rowsData[stopMarker[4] + 1];
                            changeTo = nextEntry[0];
                            desc += "<p style=\"text-align: center; font-size: 20px;\">" + (language == "en" ? "Please interchange at this stop " : "請在此站轉車 ") + routes[0] + " 🡒 " + changeTo + "</p><p style=\"text-align: center; font-size: 15px;\">(" + (language == "en" ? "Walk to " : "步行至 ") + nextEntry[14][nextEntry[12]] + ")";
                        } else {
                            changeTo = routes[1];
                            desc += "<p style=\"text-align: center; font-size: 20px;\">" + (language == "en" ? "Please interchange at this stop " : "請在此站轉車 ") + routes[0] + " 🡒 " + changeTo;
                        }

                        let tableKey = rowsData[stopMarker[4] + 1][8]["route"] + "_" + (co == "nlb" ? rowsData[stopMarker[4] + 1][8]["nlbId"] : rowsData[stopMarker[4] + 1][8]["bound"][co]);
                        if (tableKeys.indexOf(tableKey) < 0) {
                            let table = 
                                "<h5 class=\"title is-5 has-text-black\" style=\"min-width: 100px; width: 100%;\">" + (language == "en" ? "Route " : "路線") + changeTo + (language == "en" ? " ETA" : "預計到達時間") + (co == "ctb" ? (language == "en" ? "(CTB)" : "(城巴)") : "") + (co == "nlb" ? (language == "en" ? "(NLB)" : "(嶼巴)") : "") + (co == "mtr-bus" ? (language == "en" ? "(MTR-Bus)" : "(港鐵巴士)") : "") + (co == "gmb" ? (language == "en" ? "(GMB)" : "(專線小巴)") : "") + "</h5>" + 
                                "<table class=\"table\" style=\"word-break: keep-all;\">" +
                                    "<tbody>" +
                                        "<tr>" +
                                            "<th style=\"text-align: center;\"><b style=\"font-size: 25px;\"></b><b class=\"eta-table-stop-title\" style=\"white-space: nowrap;\">" + applyBbiStopHref(rowsData[stopMarker[4] + 1][14][rowsData[stopMarker[4] + 1][12]]) + "</b></th>" +
                                        "</tr>" + 
                                        "<tr>" +
                                            "<th style=\"font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"eta_" + co + "," + rowsData[stopMarker[4] + 1][11][rowsData[stopMarker[4] + 1][12]] + "," + changeTo + "," + rowsData[stopMarker[4] + 1][8]["bound"][co] + ",1,25,0\"></th>" +
                                        "</tr>" + 
                                        "<tr>" +
                                            "<th style=\"font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"eta_" + co + "," + rowsData[stopMarker[4] + 1][11][rowsData[stopMarker[4] + 1][12]] + "," + changeTo + "," + rowsData[stopMarker[4] + 1][8]["bound"][co] + ",2,25,0\"></th>" +
                                        "</tr>" + 
                                        "<tr>" +
                                            "<th style=\"font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"eta_" + co + "," + rowsData[stopMarker[4] + 1][11][rowsData[stopMarker[4] + 1][12]] + "," + changeTo + "," + rowsData[stopMarker[4] + 1][8]["bound"][co] + ",3,25,0\"></th>" +
                                        "</tr>" + 
                                    "</tbody>" +
                                "</table>";

                            etaTables.push(table);
                            tableKeys.push(tableKey);
                        }
                    }
                    desc += "</p>";
                    icon = redIcon;
                } else if (stopType == 3) {
                    icon = goldIcon;
                } else {
                    icon = greyIcon;
                }

                desc = "<b style=\"font-size: 15px\">" + desc + "</b>";
                if (stopType == 2 && routes.length > 1) {
                    let nextEntry = rowsData[stopMarker[4] + 1];
                    desc += 
                          "<b style=\"font-size: 15px\">" + (language == "en" ? "Route " : "路線") + routes[0] + "</b><br>"
                        + "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + co + "," + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[0] + "," + (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : rowsData[stopMarker[4]][8]["bound"][co])) + ",1,15,0\"></span><br>"
                        + "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + co + "," + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[0] + "," + (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : rowsData[stopMarker[4]][8]["bound"][co])) + ",2,15,0\"></span><br>"
                        + "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + co + "," + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[0] + "," + (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : rowsData[stopMarker[4]][8]["bound"][co])) + ",3,15,0\"></span><br><br>"

                        + "<b style=\"font-size: 15px\">" + (language == "en" ? "Route " : "路線") + routes[1] + "</b><br>"
                        + "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + co + "," + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[1] + "," + nextEntry[8]["bound"][co] + ",1,15,0\"></span><br>"
                        + "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + co + "," + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[1] + "," + nextEntry[8]["bound"][co] + ",2,15,0\"></span><br>"
                        + "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + co + "," + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[1] + "," + nextEntry[8]["bound"][co] + ",3,15,0\"></span><br>"
                } else {
                    desc += 
                          "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + co + "," + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[0] + "," + (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : rowsData[stopMarker[4]][8]["bound"][co])) + ",1,15,0\"></span><br>"
                        + "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + co + "," + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[0] + "," + (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : rowsData[stopMarker[4]][8]["bound"][co])) + ",2,15,0\"></span><br>"
                        + "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + co + "," + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[0] + "," + (co == "nlb" ? rowsData[stopMarker[4]][8]["nlbId"] : rowsData[stopMarker[4]][8]["bound"][co]) + ",3,15,0\"></span><br>";
                }

                let stopPin = L.marker(stopMarker[3], {icon: icon}).addTo(markers).bindPopup(desc, {minWidth: 170, maxWidth: 800})
                .on("mouseover", e => {
                    if (!isPopupMobile() && !isClicked) {
                        e.target.openPopup();
                    }
                }).on("mouseout", e => {
                    if (!isClicked) {
                        e.target.closePopup();
                    }
                }).on("click", e => {
                    isClicked = true; 
                    e.target.openPopup();
                    let offset = (0.001 * (e.target.getPopup().getElement().offsetHeight / 200) - (isPopupMobile() ? 0.001 : 0)) * Math.pow(Math.max(1, map.getZoom() - 17), -2);
                    map.flyTo([e.latlng.lat + offset, e.latlng.lng], Math.max(17, map.getZoom()), {"duration": 1});
                    updateEta();
                }).on('popupopen', (e) => {
                    updateEta();
                });
                if (stopType >= 0 && stopType <= 3) {
                    stopPin.addTo(activeRouteMarker);
                }
                currentStopMarkersByStopId.set(stopIds.values().next().value["current"], stopPin);
                currentStopMarkersByPin.set(stopPin, stopIds);
            }

            let append = 
                "<div class=\"columns is-multiline is-centered\">" +
                    "<div class=\"column\" style=\"min-width: min(350px, 75vw);\">" +
                        etaTables.join("</div><div class=\"column\" style=\"min-width: min(350px, 75vw);\">") +
                    "</div>" +
                "</div>";

            document.getElementById("eta-table").innerHTML += append;

            document.getElementById("fare-table-mobile").style.display = "";

            map.flyToBounds(activeRouteMarker.getBounds(), {"duration": 1, "paddingTopLeft": [17, 17], "paddingBottomRight": [17, 17]});

            document.getElementById('total-fare').innerHTML = "$" + totalFare.toFixed(1) + (nanInFare ? "*" : "") + " (" + (language == "en" ? "Half Fare" : "半價") + " $" + roundTo1Decimal(totalFare / 2).toFixed(1) + (nanInFare ? "*" : "") + ")";

            updateEta();

            let toggleParameter = localStorage.getItem("toggle-options");
            if ((Number(toggleParameter) & 0x01) == 0) {
                document.getElementById('eta-table').style.display = "";
            }
            document.getElementById('fare-table').style.display = "";

            let shareLink = getShareLink();
            window.history.replaceState(null, null, shareLink);
            document.getElementById('language').href = getShareLink(true);
        } finally {
            calculateTasks.splice(calculateTasks.indexOf(taskId), 1);
        }
    };

    let routeInputHtml = 
        "<div class=\"box has-background-grey-lighter route-input-element\" id=\"route-%s-element\" style=\"position: relative; z-index: {ZIndex};\">" + 
            "<div class=\"columns\">" + 
                "<div class=\"column is-one-quarter\">" + 
                    "<h5 class=\"title is-5 has-text-black\" style=\"min-width: 100px; width: 100%;\" id=\"route-%s-title\">第%c程路線</h5>" + 
                    "<input {list} class=\"input bus-route-input\" inputmode=\"none\" type=\"text\" autocomplete=\"off\" id=\"route-%s\" placeholder=\"請輸入巴士路線\" onKeyUp=\"updateRoutes(); calculate();\">" + 
                    "<datalist id=\"bus-routes\">{BusRouteOptions}</datalist>" +
                "</div>" + 
                "<div class=\"column is-one-quarter\">" + 
                    "<h5 class=\"title is-5 has-text-black\">路線類型</h5>" + 
                    "<div class=\"select\" style=\"width: 100%;\">" + 
                        "<select id=\"route-%s-type\" onChange=\"updateStartingStops(); calculate();\" style=\"width: 100%;\">" + 
                            "<option id=\"route-%s-type-n\" value=\"-1\">請選擇路線類型</option>" + 
                        "</select>" + 
                    "</div>" + 
                "</div>" + 
                "<div class=\"column is-one-quarter\">" + 
                    "<h5 class=\"title is-5 has-text-black\">上車巴士站</h5>" + 
                    "<div class=\"select\" style=\"width: 100%;\">" + 
                        "<select id=\"route-%s-start\" onChange=\"updateDestinationStops(); calculate();\" style=\"width: 100%;\">" + 
                            "<option id=\"route-%s-start-n\" value=\"-1\">請選擇上車巴士站</option>" + 
                        "</select>" + 
                    "</div>" + 
                "</div>" + 
                "<div class=\"column is-one-quarter\">" + 
                    "<h5 class=\"title is-5 has-text-black\">落車巴士站</h5>" + 
                    "<div class=\"select\" style=\"width: 100%;\">" + 
                        "<select id=\"route-%s-end\" onChange=\"calculate();\" style=\"width: 100%;\">" + 
                            "<option id=\"route-%s-end-n\" value=\"-1\">請選擇落車巴士站</option>" + 
                        "</select>" + 
                    "</div>" + 
                "</div>" + 
            "</div>" + 
            "<button class=\"button remove-button-style\" id=\"route-%s-remove\" title=\"清除路線\" onClick=\"let index = %s; routeRemove(index);\" style=\"position: absolute; top: 10px; right: 10px;\"><i class=\"material-icons\" style=\"color: red;\">close</i></button>" +
            "<button class=\"button\" id=\"route-%s-up\" title=\"向上移動\" onClick=\"let index = %s; moveUp(index);\" style=\"margin-right: 10px;\"><i class=\"material-icons\">move_up</i></button>" +
            "<button class=\"button\" id=\"route-%s-down\" title=\"向下移動\" onClick=\"let index = %s; moveDown(index);\"><i class=\"material-icons\">move_down</i></button>" +
        "</div>";
    if (language == "en") {
        routeInputHtml = routeInputHtml
                .replace("第%c程路線", "Route %s")
                .replace("請輸入巴士路線", "Please Enter Bus Route")
                .replace("路線類型", "Route Variant")
                .replace("請選擇路線類型", "Please Select Route Variant")
                .replace("上車巴士站", "Boarding Stop")
                .replace("請選擇上車巴士站", "Please Select Boarding Stop")
                .replace("落車巴士站", "Alighting Stop")
                .replace("請選擇落車巴士站", "Please Select Alighting Stop")
                .replace("清除路線", "Remove Route")
                .replace("向上移動", "Move Upwards")
                .replace("向下移動", "Move Downwards");
    }
    if (isPopupMobile()) {
        routeInputHtml = routeInputHtml.replace("{list}", "");
    } else {
        routeInputHtml = routeInputHtml.replace("{list}", "list=\"bus-routes\"");
    }

    let moveLock = false;
    const moveUp = (leg) => {
        if (moveLock) {
            return;
        }
        let collection = document.getElementsByClassName("route-input-element");
        if (collection.length == 1) {
            return;
        }
        if (leg <= 1) {
            return;
        }
        moveLock = true;

        let legHigher = leg - 1;
        let legLower = leg;

        document.getElementById("route-" + legHigher + "-element").classList.add("route-input-animation-down");
        document.getElementById("route-" + legLower + "-element").classList.add("route-input-animation-up");

        setTimeout(() => {
            document.getElementById("route-" + legHigher + "-element").classList.remove("route-input-animation-down");
            document.getElementById("route-" + legLower + "-element").classList.remove("route-input-animation-up");

            let routeNumberHigher = document.getElementById("route-" + legHigher).value;
            let routeKeyHigher = document.getElementById("route-" + legHigher + "-type").value;
            let startHigher = document.getElementById("route-" + legHigher + "-start").value;
            let endHigher = document.getElementById("route-" + legHigher + "-end").value;

            let routeNumberLower = document.getElementById("route-" + legLower).value;
            let routeKeyLower = document.getElementById("route-" + legLower + "-type").value;
            let startLower = document.getElementById("route-" + legLower + "-start").value;
            let endLower = document.getElementById("route-" + legLower + "-end").value;

            document.getElementById("route-" + legHigher).value = routeNumberLower;
            updateRoutes();
            document.getElementById("route-" + legHigher + "-type").value = routeKeyLower;
            updateStartingStops();
            document.getElementById("route-" + legHigher + "-start").value = startLower;
            updateDestinationStops();
            document.getElementById("route-" + legHigher + "-end").value = endLower;

            document.getElementById("route-" + legLower).value = routeNumberHigher;
            updateRoutes();
            document.getElementById("route-" + legLower + "-type").value = routeKeyHigher;
            updateStartingStops();
            document.getElementById("route-" + legLower + "-start").value = startHigher;
            updateDestinationStops();
            document.getElementById("route-" + legLower + "-end").value = endHigher;

            calculate();

            moveLock = false;
        }, 300);
    };
    const moveDown = (leg) => {
        if (moveLock) {
            return;
        }
        let collection = document.getElementsByClassName("route-input-element");
        if (collection.length == 1) {
            return;
        }
        if (leg >= collection.length) {
            return;
        }
        moveLock = true;

        let legHigher = leg;
        let legLower = leg + 1;

        document.getElementById("route-" + legHigher + "-element").classList.add("route-input-animation-down");
        document.getElementById("route-" + legLower + "-element").classList.add("route-input-animation-up");

        setTimeout(() => {
            document.getElementById("route-" + legHigher + "-element").classList.remove("route-input-animation-down");
            document.getElementById("route-" + legLower + "-element").classList.remove("route-input-animation-up");

            let routeNumberHigher = document.getElementById("route-" + legHigher).value;
            let routeKeyHigher = document.getElementById("route-" + legHigher + "-type").value;
            let startHigher = document.getElementById("route-" + legHigher + "-start").value;
            let endHigher = document.getElementById("route-" + legHigher + "-end").value;

            let routeNumberLower = document.getElementById("route-" + legLower).value;
            let routeKeyLower = document.getElementById("route-" + legLower + "-type").value;
            let startLower = document.getElementById("route-" + legLower + "-start").value;
            let endLower = document.getElementById("route-" + legLower + "-end").value;

            document.getElementById("route-" + legHigher).value = routeNumberLower;
            updateRoutes();
            document.getElementById("route-" + legHigher + "-type").value = routeKeyLower;
            updateStartingStops();
            document.getElementById("route-" + legHigher + "-start").value = startLower;
            updateDestinationStops();
            document.getElementById("route-" + legHigher + "-end").value = endLower;

            document.getElementById("route-" + legLower).value = routeNumberHigher;
            updateRoutes();
            document.getElementById("route-" + legLower + "-type").value = routeKeyHigher;
            updateStartingStops();
            document.getElementById("route-" + legLower + "-start").value = startHigher;
            updateDestinationStops();
            document.getElementById("route-" + legLower + "-end").value = endHigher;

            calculate();

            moveLock = false;
        }, 300);
    };
    const openVirtualKeyboard = (event) => {
        let element = event.target;
        createBusRouteKeyboard(busRouteList, element, text => {
            if (text == "") {
                return language == "en" ? "Please Enter Bus Route" : "請輸入巴士路線";
            }
            let routes = new Map();
            for (let key in dataSheet["routeList"]) {
                let data = dataSheet["routeList"][key];
                if (data["route"] == text && (!data["bound"].hasOwnProperty("kmb") || kmbRouteExists(data))) {
                    let co = data["bound"].hasOwnProperty("kmb") ? "kmb" : (data["bound"].hasOwnProperty("ctb") ? "ctb" : (data["bound"].hasOwnProperty("nlb") ? "nlb" : (data["bound"].hasOwnProperty("mtr-bus") ? "mtr-bus" : "gmb")));
                    let routeKey = co + "_" + (co == "nlb" ? data["nlbId"] : data["bound"][co]);
                    let dest = data["dest"][language].trim();
                    if (language == "en") {
                        dest = capitalize(dest);
                    }
                    if (routes.has(routeKey)) {
                        if (routes.get(routeKey)["route"]["serviceType"] > data["serviceType"]) {
                            routes.set(routeKey, {"dest": dest, "route": data});
                        }
                    } else {
                        routes.set(routeKey, {"dest": dest, "route": data});
                    }
                }
            }
            if (routes.size == 0) {
                return "<b>" + text + "</b>&nbsp;-&nbsp;<span style=\"color: #adadad;\">" + (language == "en" ? "Please Enter Bus Route" : "請輸入巴士路線") + "</span>";
            }
            let array = [...routes.values()].sort((a, b) => {
                let coAStr = a["route"]["bound"].hasOwnProperty("kmb") ? "kmb" : (a["route"]["bound"].hasOwnProperty("ctb") ? "ctb" : (a["route"]["bound"].hasOwnProperty("nlb") ? "nlb" : (a["route"]["bound"].hasOwnProperty("mtr-bus") ? "mtr-bus" : "gmb")));
                let coBStr = b["route"]["bound"].hasOwnProperty("kmb") ? "kmb" : (b["route"]["bound"].hasOwnProperty("ctb") ? "ctb" : (b["route"]["bound"].hasOwnProperty("nlb") ? "nlb" : (b["route"]["bound"].hasOwnProperty("mtr-bus") ? "mtr-bus" : "gmb")));
                let coA = coAStr == "kmb" ? 0 : (coAStr == "ctb" ? 1 : (coAStr == "nlb" ? 2 : (coAStr == "mtr-bus" ? 3 : 4)));
                let coB = coBStr == "kmb" ? 0 : (coBStr == "ctb" ? 1 : (coBStr == "nlb" ? 2 : (coBStr == "mtr-bus" ? 3 : 4)));
                if (coA != coB) {
                    return coA - coB;
                }
                if (coA == 2) {
                    return Number(a["route"]["nlbId"]) - Number(b["route"]["nlbId"]);
                } else {
                    if (coA == 4) {
                        let gtfsDiff = Number(a["route"]["gtfsId"]) - Number(b["route"]["gtfsId"]);
                        if (gtfsDiff != 0) {
                            return gtfsDiff;
                        }
                    }
                    let typeDiff = Number(a["route"]["serviceType"]) - Number(b["route"]["serviceType"]);
                    if (typeDiff == 0) {
                        if (coA == 1) {
                            return a["route"].hasOwnProperty("ctbSpecial") - b["route"].hasOwnProperty("ctbSpecial");
                        }
                        return -a["route"]["bound"][coAStr].localeCompare(b["route"]["bound"][coBStr]);
                    } else {
                        return typeDiff;
                    }
                }
            });

            let firstCo = array[0]["route"]["bound"].hasOwnProperty("kmb") ? "kmb" : (array[0]["route"]["bound"].hasOwnProperty("ctb") ? "ctb" : (array[0]["route"]["bound"].hasOwnProperty("nlb") ? "nlb" : (array[0]["route"]["bound"].hasOwnProperty("mtr-bus") ? "mtr-bus" : "gmb")));
            return "<b>" + getRouteNumberDisplay(firstCo, text, {emoji: true}) + "</b>&nbsp;-&nbsp;" + array.map(a => {
                let color;
                if (a["route"]["bound"].hasOwnProperty("kmb")) {
                    color = "#C60000";
                } else if (a["route"]["bound"].hasOwnProperty("ctb")) {
                    color = "#E5BF00";
                } else if (a["route"]["bound"].hasOwnProperty("nlb")) {
                    color = "#4A8765";
                } else if (a["route"]["bound"].hasOwnProperty("mtr-bus")) {
                    color = "#003972";
                } else {
                    color = "#00BC0C";
                }
                return "<span style=\"color: " + color + ";\">" + a["dest"].replaceAll("／", " ") + "</span>";
            }).join(" / ");
        }, document.getElementById("bottom-mobile-div"));
    };
    const routeAdd = (animated = false) => {
        let div = document.getElementById('route-input');
        let collection = document.getElementsByClassName("route-input-element");
        let index = collection.length + 1;
        let append = routeInputHtml.replaceAll("%s", "" + index).replaceAll("%c", toChineseNumber(index)).replaceAll("{BusRouteOptions}", busRouteListOptions).replaceAll("{ZIndex}", (1000 - index));
        if (index == 1) {
            div.innerHTML = append;
        } else {
            div.insertAdjacentHTML('beforeend', append);
        }
        if (index <= 1) {
            document.getElementById('route-' + index + '-up').disabled = true;
            document.getElementById('route-' + index + '-remove').disabled = true;
        } else {
            document.getElementById('route-' + (index - 1) + '-down').disabled = false;
            for (let i = 1; i <= collection.length; i++) {
                document.getElementById('route-' + i + '-remove').disabled = false;
            }
        }
        document.getElementById('route-' + index + '-down').disabled = true;

        document.querySelectorAll(".bus-route-input").forEach(element => {
            element.addEventListener('focus', openVirtualKeyboard);
        });

        if (animated) {
            let element = document.getElementById('route-' + index + '-element');
            element.classList.add("route-input-animation-add");
            setTimeout(() => element.classList.remove("route-input-animation-add"), 600);
        }

        calculate();
    };
    const routeRemove = (leg) => {
        let collection = document.getElementsByClassName("route-input-element");
        if (collection.length == 1) {
            return;
        }
        let index;
        let lastIndex = collection.length - 1;
        if (leg == undefined) {
            index = lastIndex;
        } else {
            index = leg - 1;
        }
        if (index > lastIndex) {
            return;
        }
        if (index == lastIndex) {
            collection[index].remove();
            document.getElementById('route-' + index + '-down').disabled = true;
            calculate();
        } else {
            collection[index].remove();
            for (let i = index; i < collection.length; i++) {
                let newLeg = i + 1;
                let oldLeg = newLeg + 1;
                let routeNumber = document.getElementById("route-" + oldLeg).value;
                let routeKey = document.getElementById("route-" + oldLeg + "-type").value;
                let start = document.getElementById("route-" + oldLeg + "-start").value;
                let end = document.getElementById("route-" + oldLeg + "-end").value;
                collection[i].outerHTML = collection[i].outerHTML.replaceAll("route-" + oldLeg, "route-" + newLeg).replaceAll("let index = " + oldLeg, "let index = " + newLeg);
                document.getElementById("route-" + newLeg + "-title").innerHTML = language == "en" ? ("Route " + oldLeg) : ("第" + toChineseNumber(newLeg) + "程路線");
                document.getElementById("route-" + newLeg).value = routeNumber;
                document.getElementById("route-" + newLeg + "-type").value = routeKey;
                document.getElementById("route-" + newLeg + "-start").value = start;
                document.getElementById("route-" + newLeg + "-end").value = end;
                if (index == 0) {
                    document.getElementById('route-' + newLeg + '-up').disabled = true;
                }
                if (index >= collection.length - 1) {
                    document.getElementById('route-' + newLeg + '-down').disabled = true;
                }
            }
            calculate();
        }
        if (collection.length == 1) {
            document.getElementById('route-1-remove').disabled = true;
        }
    };
    const routeClear = () => {
        let collection = [...document.getElementsByClassName("route-input-element")];
        for (let i = 0; i < collection.length; i++) {
            collection[i].remove();
        }
        routeAdd();
        currentShareParameters = "";
        let shareLink = getShareLink();
        window.history.replaceState(null, null, shareLink);
    };
    const toggleMap = () => {
        let mapElement = document.getElementById('map');
        let toggleParameter = localStorage.getItem("toggle-options");
        document.getElementById('toggle-map').classList.remove("is-info");
        document.getElementById('toggle-map').classList.remove("is-dark");
        if ((Number(toggleParameter) & 0x04) != 0) {
            document.getElementById('toggle-map').classList.add("is-info");
            mapElement.style.display = "";
            localStorage.setItem("toggle-options", (toggleParameter == undefined ? 0 : Number(toggleParameter)) & ~0x04);
        } else {
            document.getElementById('toggle-map').classList.add("is-dark");
            mapElement.style.display = "none";
            localStorage.setItem("toggle-options", (toggleParameter == undefined ? 0 : Number(toggleParameter)) | 0x04);
        }
    };
    const toggleTimetable = () => {
        let timetableElement = document.getElementById('time-table');
        let toggleParameter = localStorage.getItem("toggle-options");
        document.getElementById('toggle-timetable').classList.remove("is-info");
        document.getElementById('toggle-timetable').classList.remove("is-dark");
        if ((Number(toggleParameter) & 0x02) != 0) {
            document.getElementById('toggle-timetable').classList.add("is-info");
            if (timetableElement.innerHTML.length > 0) {
                timetableElement.style.display = "";
            }
            localStorage.setItem("toggle-options", (toggleParameter == undefined ? 0 : Number(toggleParameter)) & ~0x02);
        } else {
            document.getElementById('toggle-timetable').classList.add("is-dark");
            timetableElement.style.display = "none";
            localStorage.setItem("toggle-options", (toggleParameter == undefined ? 0 : Number(toggleParameter)) | 0x02);
        }
    };
    const toggleEta = () => {
        let etaElement = document.getElementById('eta-table');
        let toggleParameter = localStorage.getItem("toggle-options");
        document.getElementById('toggle-eta').classList.remove("is-info");
        document.getElementById('toggle-eta').classList.remove("is-dark");
        if ((Number(toggleParameter) & 0x01) != 0) {
            document.getElementById('toggle-eta').classList.add("is-info");
            if (etaElement.innerHTML.length > 0) {
                etaElement.style.display = "";
            }
            localStorage.setItem("toggle-options", (toggleParameter == undefined ? 0 : Number(toggleParameter)) & ~0x01);
        } else {
            document.getElementById('toggle-eta').classList.add("is-dark");
            etaElement.style.display = "none";
            localStorage.setItem("toggle-options", (toggleParameter == undefined ? 0 : Number(toggleParameter)) | 0x01);
        }
    };
    const toggleGps = () => {
        document.getElementById('toggle-gps').classList.remove("is-info");
        document.getElementById('toggle-gps').classList.remove("is-dark");
        if (gpsWatchID == null) {
            document.getElementById('toggle-gps').classList.add("is-info");
            getLocation();
        } else {
            document.getElementById('toggle-gps').classList.add("is-dark");
            navigator.geolocation.clearWatch(gpsWatchID);
            gpsWatchID = null;
            gpsMarker = null;
            gps.clearLayers();
            document.getElementById("nearby-routes-content").style.display = "none";
            document.getElementById("nearby-routes-prompt").style.display = "";
            document.getElementById("nearby-routes-prompt").innerHTML = language == "en" ? "Click on map to drop location pin or turn on GPS" : "點擊地圖以放置位置圖釘或打開定位位置";

            let shareLink = getShareLink();
            window.history.replaceState(null, null, shareLink);
            document.getElementById('language').href = getShareLink(true);
        }
    };
    const pinRemove = () => {
        if (droppedPin != null) {
            pin.clearLayers();
            droppedPin = null;
            nearbyLines.clearLayers();
            nearbyStopsMarker.clearLayers();
            document.getElementById("pin-remove").disabled = true;
            document.getElementById("nearby-routes-content").style.display = "none";
            document.getElementById("nearby-routes-prompt").style.display = "";
            document.getElementById("nearby-routes-prompt").innerHTML = language == "en" ? "Click on map to drop location pin or turn on GPS" : "點擊地圖以放置位置圖釘或打開定位位置";
            let shareLink = getShareLink();
            window.history.replaceState(null, null, shareLink);
            document.getElementById('language').href = getShareLink(true);
        }
    };

    const isNumber = (n) => { 
        return !isNaN(parseFloat(n)) && !isNaN(n - 0);
    };

    const loadUrlParameters = () => {
        let flag = false;

        let pinParameter = getUrlParameter("pin");
        if (pinParameter != null) {
            let parts = pinParameter.split(",");
            let lat = Number(parts[0]);
            let lng = Number(parts[1]);
            if (isNumber(lat) && isNumber(lng)) {
                let latlng = new L.LatLng(lat, lng);
                if (droppedPin == null) {
                    document.getElementById("pin-remove").disabled = false;
                    droppedPin = new L.marker(latlng, {draggable:'true', bounceOnAdd: true, bounceOnAddOptions: {duration: 500, height: 50}}).on('click', (e) => {
                        map.panTo(e.latlng, {"duration": 1})
                    });
                    pin.addLayer(droppedPin);
                    droppedPin.on('dragend', (event) => {
                        droppedPin = event.target;
                        let position = droppedPin.getLatLng();
                        droppedPin.setLatLng(new L.LatLng(position.lat, position.lng), {draggable:'true'});
                        map.panTo(new L.LatLng(position.lat, position.lng), {"duration": 1});
                        updateNearestRoutes(position.lat, position.lng);

                        let shareLink = getShareLink();
                        window.history.replaceState(null, null, shareLink);
                        document.getElementById('language').href = getShareLink(true);
                    });
                } else {
                    droppedPin.setLatLng(latlng, {draggable:'true'});
                    droppedPin.bounce({duration: 500, height: 50});
                    let position = droppedPin.getLatLng();
                    map.panTo(new L.LatLng(position.lat, position.lng), {"duration": 1});
                }
                updateNearestRoutes(lat, lng);
            }
        } else {
            let gpsParameter = getUrlParameter("gps");
            if (gpsParameter == "true") {
                toggleGps();
            }
        }

        let toggleParameter = localStorage.getItem("toggle-options");
        if (toggleParameter != undefined) {
            let value = Number(toggleParameter);
            localStorage.setItem("toggle-options", 0);
            if ((value & 0x01) != 0) {
                toggleEta();
            }
            if ((value & 0x02) != 0) {
                toggleTimetable();
            }
            if ((value & 0x04) != 0) {
                toggleMap();
            }
        }

        let parameters = [null];
        for (let i = 1; true; i++) {
            let parameter = getUrlParameter("r" + i);
            if (parameter == null) {
                break;
            }
            parameters.push(parameter);
        }

        for (let i = 1; i < parameters.length; i++) {
            let parameter = parameters[i];
            let parts = parameter.split(",");
            let co = parts[0];
            let s = 0;
            if (co != "kmb" && co != "ctb" && co != "nlb" && co != "mtr-bus" && co != "gmb") {
                s = 1;
                co = "kmb";
            }
            let routeNumber = parts[1 - s];
            let bound = parts[2 - s];
            let type = parts[3 - s];
            let startingStop = parts[4 - s];
            let endingStop = parts[5 - s];

            let routeKey = null;
            let route = null;
            let startingStopIndex;
            let endingStopIndex;
            for (let key in dataSheet["routeList"]) {
                let data = dataSheet["routeList"][key];
                if (data["bound"].hasOwnProperty(co) && (co != "kmb" || kmbRouteExists(data)) && data["route"] == routeNumber && (co == "nlb" ? data["nlbId"] == bound : (data["bound"][co] == bound)) && data["serviceType"] == type) {
                    startingStopIndex = data["stops"][co].indexOf(startingStop);
                    endingStopIndex = data["stops"][co].lastIndexOf(endingStop);
                    if (startingStopIndex < 0 || endingStopIndex < 0 || startingStopIndex > endingStopIndex) {
                        continue;
                    }
                    if (startingStopIndex == endingStopIndex) {
                        if ((startingStopIndex + 1) == data["stops"][co].length) {
                            startingStopIndex--;
                        } else {
                            endingStopIndex++;
                        }
                    }
                    routeKey = key + "_" + type;
                    route = data;
                    break;
                }
            }
            if (route == null) {
                break;
            }

            routeAdd();

            document.getElementById("route-" + i).value = routeNumber;
            updateRoutes();
            document.getElementById("route-" + i + "-type").value = routeKey;
            updateStartingStops();
            document.getElementById("route-" + i + "-start").value = startingStopIndex;
            updateDestinationStops();
            document.getElementById("route-" + i + "-end").value = endingStopIndex;

            flag = true;
        }
        if (flag) {
            calculate();
        }
        return flag;
    };
    const getCurrentLinkWithoutParameters = () => {
        return location.protocol + '//' + location.host + location.pathname;
    }
    const getShareLinkWith = (shareParameters, languageFlipped = false) => {
        let link = getCurrentLinkWithoutParameters() + shareParameters;
        if (droppedPin != null) {
            let pin = "pin=" + droppedPin.getLatLng().lat + "," + droppedPin.getLatLng().lng;
            link += (shareParameters.startsWith("?") ? "&" : "?") + pin + "&";
        } else if (gpsMarker != null) {
            link += (shareParameters.startsWith("?") ? "&" : "?") + "gps=true" + "&";
        } else {
            link += shareParameters.startsWith("?") ? "&" : "?";
        }
        if (languageFlipped) {
            link += "language=" + (language == "en" ? "zh" : "en");
        } else {
            link += "language=" + language;
        }
        return link;
    };
    const getShareLink = (languageFlipped = false) => {
        return getShareLinkWith(currentShareParameters, languageFlipped);
    };
    const copyShareLink = () => {
        let link = getShareLink();
        navigator.clipboard.writeText(link);
        prompt(language == "en" ? "Copied share link to clipboard!" : "分享鏈接已複製到剪貼板", link);
    };

    document.getElementById('route-add').addEventListener("click", () => routeAdd(true), false);
    document.getElementById('route-clear').addEventListener("click", routeClear, false);

    document.getElementById('toggle-timetable').addEventListener("click", toggleTimetable, false);
    document.getElementById('toggle-eta').addEventListener("click", toggleEta, false);
    document.getElementById('toggle-map').addEventListener("click", toggleMap, false);
    document.getElementById('toggle-gps').addEventListener("click", toggleGps, false);
    document.getElementById('share-link').addEventListener("click", copyShareLink, false);

    document.querySelector('.leaflet-control-zoom-fullscreen').addEventListener("click", () => setTimeout(() => jumpToAnchor('#anchor-map', 'instant'), 200), false);
</script>

</html>
