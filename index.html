<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" type="image/x-icon" href="https://play-lh.googleusercontent.com/M8q3UWGb7LhaCViShhXX9BZus7BSdVMEJfNFDdnpwWL7a4XCYPp7V_we4eXg9Yb5do0=w240-h480-rw">
    <title id="title">‰πùÂ∑¥ËΩâ‰πòËªäË≤ªË®àÁÆóÊ©ü KMB BBI Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>

<body>
    <style>
        .table {
            margin-left: auto;
            margin-right: auto;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 240px;
            background-color: #555;
            color: #fff;
            text-align: center;
            padding: 5px 0;
            border-radius: 6px;

            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -120px;

            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .tab-disabled {
            pointer-events: none;
            cursor: default;
            color: #C1C1C1;
        }
        .desk {
        }
        .div-only-mobile {
        }
        @media screen and (max-width : 1920px) {
            .div-only-mobile {
                display: none;
            }
        }
        @media screen and (max-width : 906px) {
            .desk {
                display: none;
            }
            .div-only-mobile {
                display: inline-block;
            }
        }
        .leaflet-control-layers {
            text-align: left;
        }
    </style>

    <section class="hero is-link is-fullheight has-background-danger">
        <nav class="navbar">
            <div class="container">
                <div class="navbar-brand">
                    <a class="navbar-item" href="https://loohpjames.com">
                        <img src="https://loohpjames.com/assets/images/profile_rounded.png" width="28" height="28" alt="LoohpJames">
                    </a>
                    <a class="navbar-item" href="https://www.kmb.hk/">
                        <img src="https://www.kmb.hk/images/inc/kmb_r.png" width="28" height="28" alt="KMB">
                    </a>
                    <a id="burger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" onclick="toggleBurger()">
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                    </a>
                </div>
                <div id="navbarMenuHeroA" class="navbar-menu">
                    <div class="navbar-end">
                        <a href="./?language=en" class="navbar-item" id="language">English</a>
                        <a href="https://github.com/LOOHP/" target="_blank" class="navbar-item">GitHub</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="hero-body" style="padding: 0px;">
            <div class="container has-text-centered" style="width: 100%;">
               <div class="column is-12">
                    <h3 class="title" id="title-label">‰πùÂ∑¥ËΩâ‰πòËªäË≤ªË®àÁÆóÊ©ü</h3>
                    <div class="box has-background-white-ter" style="width: 100%;">
                        <div id="route-input"></div><br>
                        <div class="box">
                            <button class="button is-success" id="route-add" disabled>‚ûï</button>
                            <button class="button is-danger" id="route-remove">‚ûñ</button>
                            <button class="button" id="route-clear" style="background-color: #ad0e0e;">üóëÔ∏è</button>
                            <br><br>
                            <button class="button is-info" id="toggle-eta">‚è≥</button>
                            <button class="button is-info" id="toggle-timetable">üïí</button>
                            <button class="button is-info" id="toggle-map">üó∫Ô∏è</button>
                            <button class="button is-dark" id="toggle-gps" disabled>üß≠</button>
                            <button class="button is-link" id="share-link">üîó</button>
                        </div>
                        <div style="overflow: auto; width: 100%;" class="desk">
                            <table class="table" id="fare-table" style="word-break: keep-all; display: none;">
                                <tbody>
                                    <tr>
                                        <th id="route-label">Ë∑ØÁ∑ö</th>
                                        <th style="text-align: center;" id="board-label">Âª∫Ë≠∞‰∏äËªäÂ∑¥Â£´Á´ô</th>
                                        <th style="text-align: center;" id="alight-label">Âª∫Ë≠∞ËêΩËªäÂ∑¥Â£´Á´ô</th>
                                        <th style="text-align: center;" id="discount-label">ÂÑ™ÊÉ†</th>
                                        <th style="text-align: center;" id="interchange-label">ÊúÄÈ´òÈÄ£Á∫åËΩâ‰πò</th>
                                        <th style="text-align: center;" id="timelimit-label">ÊôÇÈôê</th>
                                        <th style="text-align: center;" id="note-label">ÂÇôË®ª</th>
                                        <th style="text-align: right;" id="fare-label">ËªäË≤ª</th>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div style="overflow: auto; width: 100%;" class="div-only-mobile" id="fare-table-mobile"></div>
                        <br>
                        <table class="table" id="fare-final-table">
                            <tbody>
                                <tr>
                                    <th id="total-fare-label" style="font-size: 20px;">ÂêàË®àËªäË≤ª</th>
                                    <th style="text-align: right; font-size: 20px;" id="total-fare">$0.0 (ÂçäÂÉπ $0.0)</th>
                                </tr>
                            </tbody>
                        </table>
                        <div class="box" id="eta-table" style="display: none;"></div>
                        <div class="box" id="time-table" style="display: none;"></div>
                        <div class="box has-background-grey-lighter" id="special-announcements" style="display: none; color: red; font-weight: bold;"></div>
                        <div id="map" style="color: black; height: 50%; aspect-ratio: 7/6;"></div>
                        <br>
                        <div class="box has-background-grey-lighter" id="nearby-routes" style="font-weight: bold;">
                            <h5 class="title is-5" style="color: black;" id="nearby-routes-label">ÈÑ∞ËøëË∑ØÁ∑ö</h5>
                            <p id="nearby-routes-prompt">ÈªûÊìäÂú∞Âúñ‰ª•ÊîæÁΩÆ‰ΩçÁΩÆÂúñÈáòÊàñÊâìÈñãÂÆö‰Ωç‰ΩçÁΩÆ</p>
                            <div id="nearby-routes-content" style="display: none; max-height: 400px; overflow: auto;"></div>
                        </div>
                        <h5 class="title is-5" style="color: #111770; font-size: 15px;"><span id="data-label">Êï∏Êìö‰æÜÊ∫ê</span>: <a href="https://data.gov.hk" target="_blank">data.gov.hk</a>, <a href="https://kmb.hk" target="_blank">kmb.hk</a>, <a href="https://github.com/hkbus/hk-bus-crawling" target="_blank">HK Bus Crawling@2021</a></h5>
                    </div>
                </div>
            </div>
        </div>
    </section>
</body>

<script>
    const getUrlParameter = (sParam) => {
        let sPageURL = window.location.search.substring(1);
        let sURLVariables = sPageURL.split('&');
        let sParameterName;
        for (let i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
            }
        }
        return null;
    };

    const getJSON = (url, callback, retry = true) => {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.responseType = 'json';
        xhr.overrideMimeType("application/json");
        xhr.onload = () => {
            let status = xhr.status;
            if (status === 200) {
                callback(null, xhr.response);
            } else {
                if (retry) {
                    setTimeout(() => getJSON(url, callback, false), 1000);
                } else {
                    callback(status, xhr.response);
                }
            }
        };
        xhr.send();
    };

    let language = getUrlParameter("language");
    if (language == null) {
        language = "zh"
    }
    if (language == "en") {
        document.getElementById('language').href = "./?language=zh";

        document.getElementById('language').innerHTML = "‰∏≠Êñá";
        document.getElementById('title-label').innerHTML = "KMB Bus Interchange (BBI) Fare Calculator";

        document.getElementById('route-label').innerHTML = "Route";
        document.getElementById('board-label').innerHTML = "Suggested Boarding Stop";
        document.getElementById('alight-label').innerHTML = "Suggested Alighting Stop";
        document.getElementById('discount-label').innerHTML = "Discount";
        document.getElementById('interchange-label').innerHTML = "Max. Successive Discount";
        document.getElementById('timelimit-label').innerHTML = "Time Limit";
        document.getElementById('note-label').innerHTML = "Remarks";
        document.getElementById('fare-label').innerHTML = "Fare";

        document.getElementById('total-fare-label').innerHTML = "Total Fare";
        document.getElementById('total-fare').innerHTML = "$0.0 (Half Fare $0.0)";
        document.getElementById('data-label').innerHTML = "Data Sources";

        document.getElementById('nearby-routes-label').innerHTML = "Nearby Routes";
        document.getElementById('nearby-routes-prompt').innerHTML = "Click on map to drop location pin or turn on GPS";
    }

    let lines = new L.FeatureGroup();
    let markers = new L.FeatureGroup();
    let gps = new L.FeatureGroup();
    let pin = new L.FeatureGroup();
    let nearbyLines = new L.FeatureGroup();
    let nearbyStopsMarker = new L.FeatureGroup();

    let map = L.map('map', {layers: [lines, markers, nearbyStopsMarker]}).setView([22.3622764, 114.1508789], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    map.addLayer(gps);
    map.addLayer(pin);

    let linesName = language == "en" ? "Routes" : "Ë∑ØÁ∑ö";
    let markersName = language == "en" ? "Bus Stops" : "Â∑¥Â£´Á´ô";
    let nearbyLinesName = language == "en" ? "Nearby Routes" : "ÈÑ∞ËøëË∑ØÁ∑ö";
    let nearbyStopsMarkerName = language == "en" ? "Nearby Bus Stops" : "ÈÑ∞ËøëÂ∑¥Â£´Á´ô";

    let layerControl = L.control.layers({}, {}).addTo(map);

    layerControl.addOverlay(lines, linesName);
    layerControl.addOverlay(markers, markersName);
    layerControl.addOverlay(nearbyLines, nearbyLinesName);
    layerControl.addOverlay(nearbyStopsMarker, nearbyStopsMarkerName);

    let redIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    let blueIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [13, 20],
        iconAnchor: [6, 20],
        popupAnchor: [1, -17],
        shadowSize: [20, 20]
    });

    let greyIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [13, 20],
        iconAnchor: [6, 20],
        popupAnchor: [1, -17],
        shadowSize: [20, 20]
    });
    let goldIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-gold.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [13, 20],
        iconAnchor: [6, 20],
        popupAnchor: [1, -17],
        shadowSize: [20, 20]
    });
    let orangeIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [13, 20],
        iconAnchor: [6, 20],
        popupAnchor: [1, -17],
        shadowSize: [20, 20]
    });
    let blackIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [13, 20],
        iconAnchor: [6, 20],
        popupAnchor: [1, -17],
        shadowSize: [20, 20]
    });

    let gpsMarker = null;
    let gpsWatchID = null;
    const getLocation = () => {
        if (navigator.geolocation) {
            gpsWatchID = navigator.geolocation.watchPosition(updatePosition);
        }
    };
    const updatePosition = (position) => {
        if (gpsMarker == null) {
            gpsMarker = L.marker([position.coords.latitude, position.coords.longitude], {icon: blueIcon}).addTo(gps).bindPopup(language == "en" ? "Your Location" : "‰Ω†ÁöÑ‰ΩçÁΩÆ");
            droppedPin = null;
            pin.clearLayers();
            map.flyTo(new L.LatLng(position.coords.latitude, position.coords.longitude), 17, {"duration": 1});
            updateNearestRoutes(position.coords.latitude, position.coords.longitude);

            let shareLink = getShareLink();
            window.history.replaceState(null, null, shareLink);
            document.getElementById('language').href = getShareLink(true);
        }
        gpsMarker.setLatLng(L.latLng(position.coords.latitude, position.coords.longitude));
    };
    setInterval(() => {
        if (gpsMarker != null) {
            let position = gpsMarker.getLatLng();
            updateNearestRoutes(position.lat, position.lng);
        }
    }, 15000);

    const capitalize = (str, lower = true) => {
        return (lower ? str.toLowerCase() : str).replace(/(?:^|\s|["'([{])+\S/g, match => match.toUpperCase());
    };
    const toChineseNumber = (n, isQuantity) => {
        const digits = ['Èõ∂', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠', '‰∏É', 'ÂÖ´', '‰πù'];
        const positions = ['', 'ÂçÅ', 'Áôæ', 'ÂçÉ', 'Ëê¨', 'ÂçÅËê¨', 'ÁôæËê¨', 'ÂçÉËê¨', 'ÂÑÑ', 'ÂçÅÂÑÑ', 'ÁôæÂÑÑ', 'ÂçÉÂÑÑ'];
        const charArray = String(n).split('');
        let result = '';
        let prevIsZero = false;
        for (let i = 0; i < charArray.length; i++) {
            const ch = charArray[i];
            if (ch !== '0' && !prevIsZero) {
                result += digits[parseInt(ch)] + positions[charArray.length - i - 1];
            } else if (ch === '0') {
                prevIsZero = true;
            } else if (ch !== '0' && prevIsZero) {
                result += 'Èõ∂' + digits[parseInt(ch)] + positions[charArray.length - i - 1];
            }
        }
        if (n < 100) {
            result = result.replace('‰∏ÄÂçÅ', 'ÂçÅ');
        }
        if (isQuantity && result === '‰∫å') {
            result = 'ÂÖ©';
        }
        return result;
    };
    const toggleBurger = () => {
        let burgerIcon = document.getElementById('burger');
        let dropMenu = document.getElementById('navbarMenuHeroA');
        burgerIcon.classList.toggle('is-active');
        dropMenu.classList.toggle('is-active');
    };
    const rangeCheck = (a, min, max) => {
        return a >= min && a <= max;
    };
    const roundTo2Decimal = (a) => {
        return Math.round((a + Number.EPSILON) * 100) / 100;
    };
    const roundTo1Decimal = (a) => {
        return Math.round((a + Number.EPSILON) * 10) / 10;
    };
    const toPrecision = (number, precision, direction) => {
        precision -= Math.floor(number).toString().length;
        let order = Math.pow(10, precision);
        number *= order;
        let option = (direction === 'down' ? 'floor' : 'ceil');
        return Math[option].call(null, number) / order;
    };
    const removeOptions = (selectElement) => {
        let i, L = selectElement.options.length - 1;
        for (i = L; i >= 1; i--) {
            selectElement.remove(i);
        }
    };
    const addOptions = (selectElement, text, id, value) => {
        let option = document.createElement("option");
        option.text = text;
        option.id = id;
        option.value = value;
        selectElement.add(option);
        sortOptions(selectElement);
    };
    const sortOptions = (selectElement) => {
        let options = selectElement.options;
        let optionsArray = [];
        for (let i = 0; i < options.length; i++) {
            optionsArray.push(options[i]);
        }
        optionsArray = optionsArray.sort((a, b) => {           
            return a.value - b.value;    
        });
        for (let i = 0; i <= options.length; i++) {            
            options[i] = optionsArray[i];
        }
        options[0].selected = true;
    };
    const deleteRows = (table, from) => {
        while (table.rows.length > from) {
            table.deleteRow(from);
        }
    };
    function addRows(table, ...text) {
        let row = table.insertRow(table.rows.length);

        for (let i = 0; i < text.length; i++) {
            let cell = row.insertCell(i);
            cell.innerHTML = text[i];
        }
    }
    const stopNamesIndexOf = (toMatch, stopNames) => {
        for (let i = 0; i < stopNames.length; i++) {
            let stopName = stopNames[i];
            if (toMatch.trim() == stopName.trim()) {
                return i;
            } else if (toMatch.replaceAll(/\(.*\)/ig, "").trim() == stopName.replaceAll(/\(.*\)/ig, "").trim()) {
                return i;
            }
        }
        return -1;
    };

    let kmbRouteList = null;
    const kmbRouteListUrl = "https://data.etabus.gov.hk/v1/transport/kmb/route/";
    getJSON(kmbRouteListUrl, (err, data) => {
        if (err == null) {
            kmbRouteList = data["data"];
        } else {
            alert("Unable to get response from " + kmbRouteListUrl + ". (Is it down?)");
        }
    });

    let busRouteList = [];
    let busRouteListOptions = "";
    let dataSheet = null;
    const dataSheetUrl = "https://raw.githubusercontent.com/hkbus/hk-bus-crawling/gh-pages/routeFareList.json";
    getJSON(dataSheetUrl, (err, data) => {
        if (err == null) {
            dataSheet = data;
            for (let key in dataSheet["routeList"]) {
                let data = dataSheet["routeList"][key];
                if (busRouteList.indexOf(data["route"]) < 0) {
                    busRouteList.push(data["route"]);
                }
                if (data["fares"] == null && data["bound"].hasOwnProperty("kmb")) {
                    for (let key0 in dataSheet["routeList"]) {
                        let data0 = dataSheet["routeList"][key0];
                        if (data0 != data && data0["fares"] != null && data0["route"] == data["route"] && data0["seq"] == data["seq"]) {
                            data["fares"] = data0["fares"].slice(0, data["stops"]["kmb"].length);
                        }
                    }
                }
            }
            busRouteListOptions = "<option value=" + busRouteList.join("><option value=") + ">";
        } else {
            alert("Unable to get response from " + dataSheetUrl + ". (Is it down?)");
        }
    });

    let bbiF1 = null;
    const bbiF1Url = "./bbi_f1.json";
    getJSON(bbiF1Url, (err, data) => {
        if (err == null) {
            bbiF1 = data;
        } else {
            alert("Unable to get response from " + bbiF1Url + ". (Is it down?)");
        }
    });

    let bbiB1 = null;
    const bbiB1Url = "./bbi_b1.json";
    getJSON(bbiB1Url, (err, data) => {
        if (err == null) {
            bbiB1 = data;
        } else {
            alert("Unable to get response from " + bbiB1Url + ". (Is it down?)");
        }
    });

    let regionalTwoWaySectionFare = null;
    const regionalTwoWaySectionFareUrl = "./regional_two_way_section_fare.json";
    getJSON(regionalTwoWaySectionFareUrl, (err, data) => {
        if (err == null) {
            regionalTwoWaySectionFare = data;
        } else {
            alert("Unable to get response from " + regionalTwoWaySectionFareUrl + ". (Is it down?)");
        }
    });

    let ready = false;
    const waitLoadParameters = (condition) => {
        if (condition() === false) {
            window.setTimeout(() => waitLoadParameters(condition), 100);
        } else {
            if (!loadUrlParameters()) {
                routeAdd();
            }
            document.getElementById("toggle-gps").disabled = false;
            document.getElementById("route-add").disabled = false;
            ready = true;
        }
    }
    waitLoadParameters(() => dataSheet != null && kmbRouteList != null && bbiF1 != null && bbiB1 != null && regionalTwoWaySectionFare != null);

    let kmbSpecialAnnouncementsUrl = "https://search.kmb.hk/KMBWebSite/Function/FunctionRequest.ashx?action=getAnnounce&route={route}&bound={bound}";
    let kmbAnnouncementPictureUrl = "https://search.kmb.hk/KMBWebSite/AnnouncementPicture.ashx?url=";
    let kmbTimeTableUrl = "https://search.kmb.hk/KMBWebSite/Function/FunctionRequest.ashx?action=getschedule&route={route}&bound={bound}";
    let kmbRouteDataUrl = "https://search.kmb.hk/KMBWebSite/Function/FunctionRequest.ashx?action=getstops&route={route}&bound={bound}&serviceType={type}";
    let kmbStopEtaUrl = "https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/{stop}";
    let kmbStopRouteEtaUrl = "https://data.etabus.gov.hk/v1/transport/kmb/eta/{stop}/{route}/{type}";

    let updatingRouteTasks = [];

    const updateNearestRoutes = (lat, lng) => {
        if (calculateTasks.length > 0) {
            checkFlag(() => updatingRouteTasks.length == 0 && ready, updateNearestRoutes);
            return;
        }

        let taskId = makeId(10);
        updatingRouteTasks.push(taskId);

        try {
            let stops = dataSheet["stopList"];
            let nearbyStops = [];
            let gpsLocation = {"lat": lat, "lng": lng};
            for (let stopId in stops) {
                let entry = stops[stopId];
                let distance = findDistance(gpsLocation, entry["location"]);
                if (/^[0-9A-Z]{16}$/.test(stopId) && distance <= 0.3) {
                    nearbyStops.push({"stopId": stopId, "data": entry, "distance": distance});
                }
            }
            let nearbyRoutes = {};
            for (let i = 0; i < nearbyStops.length; i++) {
                let nearbyStop = nearbyStops[i];
                for (let key in dataSheet["routeList"]) {
                    let data = dataSheet["routeList"][key];
                    if (data["bound"].hasOwnProperty("kmb") && data["stops"]["kmb"].indexOf(nearbyStop["stopId"]) >= 0) {
                        let key = data["route"] + "," + data["bound"]["kmb"];
                        if (nearbyRoutes.hasOwnProperty(key)) {
                            if (nearbyRoutes[key]["stop"]["distance"] > nearbyStop["distance"]) {
                                nearbyRoutes[key] = {"stop": nearbyStop, "route": data};
                            }
                        } else {
                            nearbyRoutes[key] = {"stop": nearbyStop, "route": data};
                        }
                    }
                }
            }

            nearbyLines.clearLayers();
            nearbyStopsMarker.clearLayers();

            if (Object.keys(nearbyRoutes).length == 0) {
                document.getElementById("nearby-routes-content").style.display = "none";
                document.getElementById("nearby-routes-prompt").style.display = "";
                document.getElementById("nearby-routes-prompt").innerHTML = language == "en" ? "There are no nearby KMB/LWB bus stops" : "ÈôÑËøëÊ≤íÊúâ‰πùÂ∑¥ÊàñÈæçÈÅãÂ∑¥Â£´Á´ô";
                return;
            }
            document.getElementById("nearby-routes-prompt").style.display = "none";
            document.getElementById("nearby-routes-prompt").innerHTML = "";

            let table = 
                "<table class=\"table has-background-grey-lighter is-hoverable\" id=\"fare-table\" style=\"height: 100px;\">" +
                "<tbody>" +
                    "<colgroup class=\"div-only-mobile\">" +
                        "<col span=\"1\" style=\"width: 62%;\">" +
                        "<col span=\"1\" style=\"width: 38%;\">" +
                    "</colgroup>" +
                    "<tr>" +
                        "<th>" + (language == "en" ? "Route" : "Ë∑ØÁ∑ö") + "</th>" +
                        "<th style=\"text-align: right;\">" + (language == "en" ? "Min." : "ÂàÜÈêò") + "</th>" +
                    "</tr>";

            let routes = [];
            for (let key in nearbyRoutes) {
                routes.push(nearbyRoutes[key]);
            }
            let hour = (new Date().getUTCHours() + 8) % 24;
            let isNight = hour >= 1 && hour < 5;
            let weekday = new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong", weekday: 'long'});
            let date = new Date().toLocaleString("en-ZA", {timeZone: "Asia/Hong_Kong", year: 'numeric', month: 'numeric', day: 'numeric'}).replaceAll("/", "");
            let isHoliday = weekday == "Saturday" || weekday == "Sunday" || dataSheet["holidays"].indexOf(date) >= 0;

            routes.sort((a, b) => {
                let pa = a["route"]["route"][0];
                let pb = b["route"]["route"][0];
                let sa = a["route"]["route"][a["route"]["route"].length - 1];
                let sb = b["route"]["route"][b["route"]["route"].length - 1];
                let na = Number(a["route"]["route"].match(/[0-9]+/g));
                let nb = Number(b["route"]["route"].match(/[0-9]+/g));
                if (isNight) {
                    if (pa == "N") {
                        na -= 10000;
                    }
                    if (sa == "S") {
                        na -= 8000;
                    }
                    if (pb == "N") {
                        nb -= 10000;
                    }
                    if (sb == "S") {
                        nb -= 8000;
                    }
                }
                if (!isHoliday) {
                    if (sa == "R") {
                        na -= 100000;
                    }
                    if (sb == "R") {
                        nb -= 100000;
                    }
                }
                if (!/[0-9]/.test(pa)) {
                    na += 1000;
                }
                if (!/[0-9]/.test(pb)) {
                    nb += 1000;
                }
                let diff = na - nb;
                if (diff == 0) {
                    diff = a["route"]["route"].localeCompare(b["route"]["route"]);
                }
                if (diff == 0) {
                    diff = Number(a["route"]["serviceType"]) - Number(b["route"]["serviceType"]);
                }
                if (diff == 0) {
                    diff = Number(a["route"]["bound"]["kmb"]) - Number(b["route"]["bound"]["kmb"]);
                }
                return diff;
            });

            let allNearbyStops = {};
            let allOtherStops = {};
            for (let i = 0; i < routes.length; i++) {
                let entry = routes[i];
                let route = entry["route"];
                let stop = entry["stop"];

                let stopId = stop["stopId"];
                let bound = route["bound"]["kmb"];

                if (allNearbyStops.hasOwnProperty(stopId)) {
                    allNearbyStops[stopId].push(route);
                } else {
                    allNearbyStops[stopId] = [route];
                }
                if (allOtherStops.hasOwnProperty(stopId)) {
                    let list = allOtherStops[stopId];
                    for (let u = 0; u < list.length; u++) {
                        allNearbyStops[stopId].push(list[u]);
                    }
                    delete allOtherStops[stopId];
                }

                let routeNumber = route["route"];
                let stopName = stop["data"]["name"][language == "en" ? "en" : "zh"];
                let destName = route["dest"][language == "en" ? "en" : "zh"];

                if (language == "en") {
                    stopName = capitalize(stopName);
                    destName = capitalize(destName);
                }
                destName = destName.replaceAll("(", "‚Äã(").replace(/([^‚Äã]{5})/g,"$1‚Äã");

                let allStops = route["stops"]["kmb"];

                for (let u = allStops.indexOf(stopId); u < allStops.length; u++) {
                    let routeStopId = allStops[u];
                    if (allNearbyStops.hasOwnProperty(routeStopId)) {
                        allNearbyStops[routeStopId].push(route);
                    } else {
                        if (allOtherStops.hasOwnProperty(routeStopId)) {
                            allOtherStops[routeStopId].push(route);
                        } else {
                            allOtherStops[routeStopId] = [route];
                        } 
                    }
                }

                let index = 1;
                let shareLink = getShareLink();
                for (let i = 1; true; i++) {
                    if (shareLink.indexOf("r" + i + "=") >= 0) {
                        index = i + 1;
                    } else {
                        break;
                    }
                }

                let params = "'" + routeNumber + "','" + bound + "','" + route["serviceType"] + "','" + stopId + "','" + allStops[allStops.length - 1] + "'";

                table += 
                    "<tr style=\"cursor: pointer;\" onclick=\"handleNearbyRouteClick(" + params + ");\">" +
                        "<th style=\"font-size: 20px;\"><span style=\"font-size: 30px;\">" + routeNumber + "</span> <br class=\"div-only-mobile\"><span style=\"font-size: 15px;\">" + (language == "en" ? "To " : "ÂæÄ") + "</span>‚Äã<span style=\"word-break: keep-all; white-space: break-spaces;\">" + destName + "</span><br><span style=\"font-size: 15px;\">" + stopName + "</span></th>" +
                        "<th style=\"text-align: right;\"><span style=\"font-size: 25px;\">‚Äã</span><span class=\"eta-update\" id=\"nearby_" + stopId + "," + routeNumber + "," + bound + ",1,25,true\"></span></th>" +
                    "</tr>";

                let task0Id = makeId(10);
                updatingRouteTasks.push(task0Id);
                getJSON("./route_paths/" + routeNumber + ".json", (err, data) => {
                    try {
                        if (err == null) {                
                            let sections = data[bound][route["serviceType"]];
                            if (sections == undefined) {
                                return;
                            }

                            for (let i = allStops.indexOf(stopId); i < sections.length; i++) {
                                let path = sections[i];
                                let pointListRoute = [];
                                for (let u = 0; u < path.length; u++) {
                                    let position = path[u];
                                    pointListRoute.push(new L.LatLng(position[0], position[1]));
                                }
                                let desc;
                                if (language == "en") {
                                    desc = "<b style=\"font-size: 17px\">" + routeNumber + " <span style=\"font-size: 12px\">To</span><span style=\"font-size: 15px\">" + capitalize(route["dest"]["en"]) + "</span></b>";
                                } else {
                                    desc = "<b style=\"font-size: 17px\">" + routeNumber + " <span style=\"font-size: 12px\">ÂæÄ</span><span style=\"font-size: 15px\">" + route["dest"]["zh"] + "</span></b>";
                                }
                                new L.Polyline(pointListRoute, {
                                    color: 'black',
                                    weight: 2,
                                    opacity: 0.7,
                                    smoothFactor: 0.00001
                                }).addTo(nearbyLines).bindPopup(desc);
                            }
                        } else {
                            alert("Unable to get response from ./route_paths/" + routeNumber + ".json. (Is it down?)");
                        }
                    } finally {
                        updatingRouteTasks.splice(updatingRouteTasks.indexOf(task0Id), 1);
                    }
                });
            }

            for (let stopId in allNearbyStops) {
                let routes = allNearbyStops[stopId].filter((value, index, array) => array.indexOf(value) === index);
                let stop = dataSheet["stopList"][stopId];
                let stopName = stop["name"][language == "en" ? "en" : "zh"];
                if (language == "en") {
                    stopName = capitalize(stopName);
                }

                let info = "<div style=\"text-align: center;\"><b style=\"font-size: 15px;\">" + (language == "en" ? "[Nearby]" : "[ÈÑ∞Ëøë]") + " " + stopName + "</b></div><br>";

                let routesInfo = [];
                for (let i = 0; i < routes.length; i++) {
                    let route = routes[i];
                    let routeNumber = route["route"];
                    let destName = route["dest"][language == "en" ? "en" : "zh"];
                    if (language == "en") {
                        destName = capitalize(destName);
                    }

                    let table = 
                        "<tr>" +
                            "<th><b style=\"font-size: 15px; text-align: center;\">" + routeNumber + "</b></th>" +
                            "<th style=\"padding:0 0 0 5px;\"><b style=\"font-size: 15px\"><span style=\"font-size: 10px\">ÂæÄ</span><span style=\"font-size: 15px\">" + destName + "</span></b></th>" +
                        "</tr>";

                    routesInfo.push(table);
                }

                let table =
                    "<table>" +
                        "<tbody>" +
                            routesInfo.join("") +
                        "</tbody>" +
                    "</table>";

                let location = stop["location"];
                L.marker([location["lat"], location["lng"]], {icon: orangeIcon}).addTo(nearbyStopsMarker).bindPopup(info + table).on('click', (e) => {
                    map.flyTo([e.latlng.lat + 0.0012, e.latlng.lng], 17, {"duration": 1});
                });
            }

            for (let stopId in allOtherStops) {
                let routes = allOtherStops[stopId].filter((value, index, array) => array.indexOf(value) === index);
                let stop = dataSheet["stopList"][stopId];
                let stopName = stop["name"][language == "en" ? "en" : "zh"];
                if (language == "en") {
                    stopName = capitalize(stopName);
                }

                let info = "<div style=\"text-align: center;\"><b style=\"font-size: 15px;\">" + (language == "en" ? "[Nearby Route]" : "[ÈÑ∞ËøëË∑ØÁ∑ö]") + " " + stopName + "</b></div><br>";

                let routesInfo = [];
                for (let i = 0; i < routes.length; i++) {
                    let route = routes[i];
                    let routeNumber = route["route"];
                    let destName = route["dest"][language == "en" ? "en" : "zh"];
                    if (language == "en") {
                        destName = capitalize(destName);
                    }

                    let table = 
                        "<tr>" +
                            "<th><b style=\"font-size: 15px\">" + routeNumber + "</b></th>" +
                            "<th style=\"padding:0 0 0 5px;\"><b style=\"font-size: 15px\"><span style=\"font-size: 10px\">ÂæÄ</span><span style=\"font-size: 15px\">" + destName + "</span></b></th>" +
                        "</tr>";

                    routesInfo.push(table);
                }

                let table =
                    "<table>" +
                        "<tbody>" +
                            routesInfo.join("") +
                        "</tbody>" +
                    "</table>";

                let location = stop["location"];
                L.marker([location["lat"], location["lng"]], {icon: blackIcon}).addTo(nearbyLines).bindPopup(info + table).on('click', (e) => {
                    map.flyTo([e.latlng.lat + 0.0012, e.latlng.lng], 17, {"duration": 1});
                });
            }

            table += "</tbody></table>";

            document.getElementById("nearby-routes-content").innerHTML = table;
            document.getElementById("nearby-routes-content").style.display = "";

            updateEta();
        } finally {
            updatingRouteTasks.splice(updatingRouteTasks.indexOf(taskId), 1);
        }
    };
    const handleNearbyRouteClick = (routeNumber, bound, type, startingStop, endingStop) => {
        let index = 1;
        let shareLink = getShareLink();
        for (let i = 1; true; i++) {
            if (shareLink.indexOf("r" + i + "=") >= 0) {
                index = i + 1;
            } else {
                break;
            }
        }

        let link = shareLink + "&r" + index + "=" + routeNumber + "," + bound + "," + type + "," + startingStop + "," + endingStop;
        window.location.href = link;
    };

    let droppedPin = null;
    const onMapClick = (e) => {
        if (dataSheet == null) {
            return;
        }
        if (gpsMarker != null) {
            return;
        }
        if (droppedPin == null) {
            droppedPin = new L.marker(e.latlng, {draggable:'true'});
            pin.addLayer(droppedPin);
            droppedPin.on('dragend', (event) => {
                droppedPin = event.target;
                let position = droppedPin.getLatLng();
                droppedPin.setLatLng(new L.LatLng(position.lat, position.lng), {draggable:'true'});
                map.panTo(new L.LatLng(position.lat, position.lng), {"duration": 1});
                updateNearestRoutes(position.lat, position.lng);

                let shareLink = getShareLink();
                window.history.replaceState(null, null, shareLink);
                document.getElementById('language').href = getShareLink(true);
            });
        } else {
            droppedPin.setLatLng(e.latlng, {draggable:'true'});
            let position = droppedPin.getLatLng();
            map.panTo(new L.LatLng(position.lat, position.lng), {"duration": 1});
        }
        updateNearestRoutes(e.latlng.lat, e.latlng.lng);

        let shareLink = getShareLink();
        window.history.replaceState(null, null, shareLink);
        document.getElementById('language').href = getShareLink(true);
    };
    map.on('click', onMapClick);

    const updateEta = () => {
        let collection = document.getElementsByClassName("eta-update");
        
        let stops = {};
        for (let i = 0; i < collection.length; i++) {
            let element = collection[i];
            let tag = element.id.substring(element.id.lastIndexOf("_") + 1);
            let matches = tag.split(",");
            let stopId = matches[0];
            let routeNumber = matches[1];
            let bound = matches[2];
            let seq = matches[3];
            let fontSize = matches[4];
            let noScheduledType = matches[5] == "true";
            if (stops.hasOwnProperty(stopId)) {
                stops[stopId].push([element, stopId, routeNumber, bound, seq, fontSize, noScheduledType]);
            } else {
                stops[stopId] = [[element, stopId, routeNumber, bound, seq, fontSize, noScheduledType]];
            }
        }

        for (let stopId in stops) {
            let list = stops[stopId];
            let resolvedStopEtaUrl = kmbStopEtaUrl.replace("{stop}", stopId);
            getJSON(resolvedStopEtaUrl, (err, data) => {
                if (err == null) {
                    let buses = data["data"];
                    for (let u = 0; u < buses.length; u++) {
                        let bus = buses[u];
                        if (bus["co"] == "KMB") {
                            let routeNumber = bus["route"];
                            let bound = bus["dir"];
                            let type = bus["service_type"];
                            let seq = bus["eta_seq"];
                            let eta = bus["eta"];

                            let mins = eta == null ? -999 : Math.round((new Date(eta) - new Date()) / 1000 / 60);
                            
                            for (let m = 0; m < list.length; m++) {
                                let entry = list[m];
                                let elementRouteNumber = entry[2];
                                let elementBound = entry[3];
                                let elementSeq = entry[4];
                                let elementFontSize = entry[5];
                                let elementScheduledType = entry[6];

                                if (elementRouteNumber == routeNumber && elementBound == bound) {
                                    let message = "";
                                    if (language == "en") {
                                        if (mins > 0) {
                                            message = "<b style=\"font-size: " + elementFontSize + "px;\">" + mins + "</b>" + (elementScheduledType ? "<br class=\"div-only-mobile\">" : "") + " Min.";
                                        } else if (mins > -60) {
                                            message = "<b style=\"font-size: " + elementFontSize + "px;\">-</b>" + (elementScheduledType ? "<br class=\"div-only-mobile\">" : "") + " Min.";
                                        }
                                        if (bus["rmk_en"] != "") {
                                            if (elementScheduledType) {
                                                message += (message == "" ? bus["rmk_en"] : " <br class=\"div-only-mobile\"><span class=\"div-only-mobile\" style=\"font-size: 12px\">(" + bus["rmk_en"] + ")</span><span class=\"desk\">(" + bus["rmk_en"] + ")</span>");
                                            } else {
                                                message += (message == "" ? bus["rmk_en"] : " (" + bus["rmk_en"] + ")");
                                            }
                                        }
                                    } else {
                                        if (mins > 0) {
                                            message = "<span style=\"white-space: nowrap;\"><b style=\"font-size: " + elementFontSize + "px;\">" + mins + "</b>" + (elementScheduledType ? "<br class=\"div-only-mobile\">" : "") + " <span style=\"word-break: keep-all;\">ÂàÜÈêò</span></span>";
                                        } else if (mins > -60) {
                                            message = "<span style=\"white-space: nowrap;\"><b style=\"font-size: " + elementFontSize + "px;\">-</b>" + (elementScheduledType ? "<br class=\"div-only-mobile\">" : "") + " <span style=\"word-break: keep-all;\">ÂàÜÈêò</span></span>";
                                        }
                                        if (bus["rmk_tc"] != "") {
                                            if (elementScheduledType) {
                                                message += (message == "" ? bus["rmk_tc"] : " <br class=\"div-only-mobile\"><span class=\"div-only-mobile\" style=\"font-size: 12px\">(" + bus["rmk_tc"] + ")</span><span class=\"desk\">(" + bus["rmk_tc"] + ")</span>");
                                            } else {
                                                message += (message == "" ? bus["rmk_tc"] : " (" + bus["rmk_tc"] + ")");
                                            }
                                        }
                                    }
                                    message = message
                                        .replaceAll("ÂéüÂÆö", "È†êÂÆö")
                                        .replaceAll("ÊúÄÂæåÁè≠Ê¨°", "Â∞æÁè≠Ëªä")
                                        .replaceAll("Â∞æÁè≠ËªäÂ∑≤ÈÅé", "Â∞æÁè≠ËªäÂ∑≤ÈÅéÊú¨Á´ô");

                                    if (message == "") {
                                        if (elementSeq == 1) {
                                            if (language == "en") {
                                                entry[0].innerHTML = elementScheduledType ? "üïí" : "No scheduled departures at this moment";
                                            } else {
                                                entry[0].innerHTML = elementScheduledType ? "üïí" : "Êö´ÊôÇÊ≤íÊúâÈ†êÂÆöÁè≠Ê¨°";
                                            }
                                        } else {
                                            entry[0].innerHTML = "-";
                                        }
                                    } else if (elementSeq == seq) {
                                        entry[0].innerHTML = message;
                                    } else if (elementSeq > seq) {
                                        entry[0].innerHTML = "-";
                                    }
                                }
                            }
                        }
                    }
                } else {
                    alert("Unable to get response from " + resolvedStopEtaUrl + ". (Is it down?)");
                }
            });
        }
    };

    setInterval(updateEta, 15000);

    const kmbRouteExists = (route) => {
        for (let i = 0; i < kmbRouteList.length; i++) {
            let kmbRoute = kmbRouteList[i];
            if (route["route"] == kmbRoute["route"] && route["bound"]["kmb"] == kmbRoute["bound"] && route["serviceType"] == kmbRoute["service_type"] && route["orig"]["zh"] == kmbRoute["orig_tc"] && route["dest"]["zh"] == kmbRoute["dest_tc"]) {
                return true;
            }
        }
        return false;
    };
    const matchTwoWaySectionFareStop = (stops, name, invert) => {
        let task = (i) => {
            let stop = stops[i];
            if (stop.toUpperCase() === name.toUpperCase()) {
                return i;
            } else if (stop.toUpperCase().includes(name.toUpperCase())) {
                return i;
            } else {
                let normalizedStop = stop.toUpperCase().replaceAll("ËΩâËªäÁ´ô", "").replaceAll(/\(.*\)/ig, "");
                let normalizedName = name.toUpperCase().replaceAll("ËºïÈêµ", "").replaceAll("ÈÇ®", "").replaceAll("ËêΩÈ¶¨Ê¥≤", "Êñ∞Áî∞ÈÅãËº∏‰∫§ÂåØËôï").replaceAll(/\(.*\)/ig, "");
                let area = regionalTwoWaySectionFare["area"];
                for (let u = 0; u < area.length; u++) {
                    normalizedName = normalizedName.replaceAll(area[u], "");
                }
                if (normalizedStop.includes(normalizedName)) {
                    return i;
                }
            }
            return -1;
        };

        let finalResult = -1;
        if (invert) {
            for (let i = stops.length - 1; i >= 0; i--) {
                let result = task(i);
                if (result >= 0) {
                    finalResult = result;
                }
            }
        } else {
            for (let i = 0; i < stops.length; i++) {
                let result = task(i);
                if (result >= 0) {
                    finalResult = result;
                }
            }
        }
        return finalResult;
    };
    const checkTwoWaySectionFare = (routeNumber, stops, startingName, endingName) => {
        let routes = regionalTwoWaySectionFare["routes"];
        for (let i = 0; i < routes.length; i++) {
            let data = routes[i];
            if (data["route_number"] == routeNumber) {
                let sectionStartIndex = matchTwoWaySectionFareStop(stops, data["start"]);
                let sectionEndIndex = matchTwoWaySectionFareStop(stops, data["end"]);
                if (sectionStartIndex < sectionEndIndex && stops.indexOf(startingName) >= sectionStartIndex && stops.indexOf(endingName) <= sectionEndIndex) {
                    return [sectionStartIndex, sectionEndIndex, data["fare"]];
                }
            }
        }
        return null;
    };
    const stopIdsToNames = (stops, lang = "zh") => {
        let names = [];
        for (let i = 0; i < stops.length; i++) {
            let stop = dataSheet["stopList"][stops[i]];
            let name = lang == "en" ? capitalize(stop["name"]["en"]) : stop["name"]["zh"];
            names.push(name);
        }
        return names;
    };
    const stopIdsToDetails = (stops) => {
        let stopDetails = [];
        for (let i = 0; i < stops.length; i++) {
            let stop = dataSheet["stopList"][stops[i]];
            stopDetails.push([stops[i], stop]);
        }
        return stopDetails;
    };
    const EARTH_RADIUS = 6371; // KM
    const toRadians = (angle) => {
        return (angle * Math.PI) / 180;
    };
    const findDistance = (location, other) => {
        const lat1 = toRadians(Number(location["lat"]));
        const lat2 = toRadians(Number(other["lat"]));
        const lng1 = toRadians(Number(location["lng"]));
        const lng2 = toRadians(Number(other["lng"]));

        const d_lon = lng2 - lng1;
        const d_lat = lat2 - lat1;
        const a = Math.sin(d_lat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(d_lon / 2) ** 2;

        const c = 2 * Math.asin(Math.sqrt(a));

        return c * EARTH_RADIUS;
    };
    const findInterchangeStop = (stops1, stops2) => {
        let result = null;
        for (let i = 0; i < stops1.length; i++) {
            let stop1Location = stops1[i][1]["location"];
            for (let u = stops2.length - 1; u >= 0; u--) {
                let stop2Location = stops2[u][1]["location"];
                let distance = findDistance(stop1Location, stop2Location);
                //console.log(stops1[i][1]["name"]["zh"] + " " + stops2[u][1]["name"]["zh"] + " " + distance);
                if (result == null || result[2] > distance) {
                    result = [stops1[i][0], stops2[u][0], distance];
                }
            }
        }
        return result;
    };
    const findCloestStop = (cloestTo, stops) => {
        let result = null;
        let stop1Location = cloestTo[1]["location"];
        for (let u = stops.length - 1; u >= 0; u--) {
            let stop2Location = stops[u][1]["location"];
            let distance = findDistance(stop1Location, stop2Location);
            //console.log(cloestTo[1]["name"]["zh"] + " " + stops[u][1]["name"]["zh"] + " " + distance);
            if (result == null || result[1] > distance) {
                result = [stops[u][0], distance];
            }
        }
        return result;
    };
    const valueExists = (value, selectElement) => {
        for (let i = 0; i < selectElement.options.length; i++) {
            if (selectElement.options[i].value == value) {
                return true;
            }
        }
        return false;
    };
    const hasStartWith = (list, str) => {
        for (let u = 0; u < list.length; u++) {
            if (list[u].startsWith(str)) {
                return true;
            }
        }
        return false;
    };

    const updateRoutes = () => {
        let collection = document.getElementsByClassName("route-input-element");
        if (collection.length == 0) {
            return;
        }
        for (let i = 0; i < collection.length; i++) {
            let leg = i + 1;
            let routeNumber = document.getElementById('route-' + leg).value.toUpperCase();
            document.getElementById('route-' + leg).value = routeNumber;
            while (!hasStartWith(busRouteList, routeNumber)) {
                routeNumber = routeNumber.substring(0, routeNumber.length - 1);
                document.getElementById('route-' + leg).value = routeNumber;
            }
            let routes = [];

            for (let key in dataSheet["routeList"]) {
                let data = dataSheet["routeList"][key];
                if (data["route"] == routeNumber && data["bound"].hasOwnProperty("kmb") && kmbRouteExists(data)) {
                    routes.push([key, data]);
                }
            }
            let lastSelected = document.getElementById('route-' + leg + '-type').selectedIndex;
            removeOptions(document.getElementById('route-' + leg + '-type'));

            routes.sort((a, b) => Number(a[1]["serviceType"]) - Number(b[1]["serviceType"]));
            for (let u = 0; u < routes.length; u++) {
                let route = routes[u][1];
                let bound = route["bound"]["kmb"];
                let type = route["serviceType"];
                let name = language == "en" ? "To " + capitalize(route["dest"]["en"]) : "ÂæÄ" + route["dest"]["zh"];
                if (type != 1) {
                    for (let k = 0; k < routes.length; k++) {
                        let data = routes[k][1];
                        if (data["bound"]["kmb"] == bound && data["serviceType"] == 1 && kmbRouteExists(data)) {
                            if (data["dest"]["zh"] != route["dest"]["zh"]) {
                                if (language == "en") {
                                    name += " - Special To " + capitalize(route["dest"]["en"]);
                                } else {
                                    name += " - ÁâπÂà•Áè≠ ÈñãÂæÄ" + route["dest"]["zh"];
                                }
                            } else if (data["orig"]["zh"] != route["orig"]["zh"]) {
                                if (language == "en") {
                                    name += " - Special From " + capitalize(route["orig"]["en"]);
                                } else {
                                    name += " - ÁâπÂà•Áè≠ Âæû" + route["orig"]["zh"] + "ÈñãÂá∫";
                                }
                            } else {
                                if (language == "en") {
                                    name += " - Special";
                                } else {
                                    name += " - ÁâπÂà•Áè≠";
                                }
                            }
                            break;
                        }
                    }
                }

                addOptions(document.getElementById('route-' + leg + '-type'), name, "route-" + leg + "-type-" + bound + type, routes[u][0] + "_" + type);
            }

            document.getElementById('route-' + leg + '-type').selectedIndex = Math.max(lastSelected, 1) < document.getElementById('route-' + leg + '-type').options.length ? lastSelected : 0;
        }

        updateStartingStops();
        updateDestinationStops();
    };
    const updateStartingStops = () => {
        let collection = document.getElementsByClassName("route-input-element");
        if (collection.length == 0) {
            return;
        }
        for (let i = 0; i < collection.length; i++) {
            let leg = i + 1;
            let lastSelected = document.getElementById('route-' + leg + '-start').value;
            removeOptions(document.getElementById('route-' + leg + '-start'));
            let key = document.getElementById('route-' + leg + '-type').value;
            let routeKey = key.substring(0, key.indexOf("_"));
            let route = dataSheet["routeList"][routeKey];
            if (route == undefined) {
                continue;
            }
            let stops = route["stops"]["kmb"];
            for (let k = 0; k < stops.length - 1; k++) {
                let stopId = stops[k];
                let stop = dataSheet["stopList"][stopId];
                let name = language == "en" ? capitalize(stop["name"]["en"]) : stop["name"]["zh"];
                addOptions(document.getElementById('route-' + leg + '-start'), name, "route-" + leg + "-start-" + k, k);
            }

            document.getElementById('route-' + leg + '-start').value = Math.max(lastSelected, 0) < document.getElementById('route-' + leg + '-start').options.length ? lastSelected : -1;
        }

        updateDestinationStops();
    };
    const updateDestinationStops = () => {
        let collection = document.getElementsByClassName("route-input-element");
        if (collection.length == 0) {
            return;
        }
        for (let i = 0; i < collection.length; i++) {
            let leg = i + 1;
            let lastSelected = document.getElementById('route-' + leg + '-end').value;
            removeOptions(document.getElementById('route-' + leg + '-end'));
            let key = document.getElementById('route-' + leg + '-type').value;
            let routeKey = key.substring(0, key.indexOf("_"));
            let route = dataSheet["routeList"][routeKey];
            if (route == undefined) {
                continue;
            }
            let stops = route["stops"]["kmb"];
            let startingStop = Number(document.getElementById('route-' + leg + '-start').value);
            for (let k = startingStop + 1; k < stops.length; k++) {
                let stopId = stops[k];
                let stop = dataSheet["stopList"][stopId];
                let name = language == "en" ? capitalize(stop["name"]["en"]) : stop["name"]["zh"];
                addOptions(document.getElementById('route-' + leg + '-end'), name, "route-" + leg + "-end-" + k, k);
            }
            document.getElementById('route-' + leg + '-end').value = valueExists(lastSelected, document.getElementById('route-' + leg + '-end')) ? lastSelected : -1;
        }
    };

    const checkFlag = (condition, task) => {
        if (condition() === false) {
            window.setTimeout(() => checkFlag(condition, task), 100);
        } else {
            task();
        }
    }
    const makeId = (length) => {
        let result = '';
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        const charactersLength = characters.length;
        let counter = 0;
        while (counter < length) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
            counter += 1;
        }
        return result;
    }

    let currentShareParameters = "";
    let calculateTasks = [];
    const calculate = () => {
        let collection = document.getElementsByClassName("route-input-element");
        if (collection.length == 0) {
            return;
        }
        if (calculateTasks.length > 0) {
            checkFlag(() => calculateTasks.length == 0, calculate);
            return;
        }

        let taskId = makeId(10);
        calculateTasks.push(taskId);
        let shareParameters = [];
        try {
            for (let i = 0; i < collection.length; i++) {
                let leg = i + 1;
                let key = document.getElementById('route-' + leg + '-type').value;
                if (key == "-1" || key == "") {
                    let routeNumber = document.getElementById('route-' + leg).value.toUpperCase();
                    let routeValid = false;

                    for (let key in dataSheet["routeList"]) {
                        let data = dataSheet["routeList"][key];
                        if (data["route"] == routeNumber && data["bound"].hasOwnProperty("kmb")) {
                            routeValid = true;
                            break;
                        }
                    }
                    return;
                }
                let routeKey = key.substring(0, key.indexOf("_"));
                let route = dataSheet["routeList"][routeKey];
                if (route["fares"] == null) {
                    let resolvedRouteDataUrl = kmbRouteDataUrl.replace("{route}", route["route"]).replace("{bound}", route["bound"]["kmb"] == "O" ? 1 : 2).replace("{type}", route["serviceType"])
                    getJSON(resolvedRouteDataUrl, (err, data) => {
                        if (err == null) {
                            let faresArray = [];
                            let routeStops = data["data"]["routeStops"]
                            for (let u = 0; u < routeStops.length; u++) {
                                let routeStop = routeStops[u];
                                faresArray.push(routeStop["AirFare"]);
                            }
                            route["fares"] = faresArray;
                            calculate();
                        } else {
                            alert("Unable to get response from " + resolvedRouteDataUrl + ". (Is it down?)");
                        }
                    });
                    return;
                }
            }

            let rowsData = [];

            let consecutiveInterchanges = 1;
            let lastRouteNumber = -1;
            let lastFare = 0;
            let lastBound = null;
            for (let i = 0; i < collection.length; i++) {
                let leg = i + 1;
                let key = document.getElementById('route-' + leg + '-type').value;
                let routeKey = key.substring(0, key.indexOf("_"));
                let route = dataSheet["routeList"][routeKey];
                let routeNumber = route["route"];
                let stops = route["stops"]["kmb"];
                let displayStopNames = stopIdsToNames(stops, language);
                let stopNames = stopIdsToNames(stops);
                let stopDetails = stopIdsToDetails(stops);
                let startingStopIndex = Number(document.getElementById('route-' + leg + '-start').value);
                let endingStopIndex = Number(document.getElementById('route-' + leg + '-end').value);
                if (startingStopIndex == -1) {
                    return;
                }
                if (endingStopIndex == -1) {
                    return;
                }
                if (i == 0) {
                    let startingStopId = stops[startingStopIndex];
                    let startingStop = dataSheet["stopList"][startingStopId];
                    let startingName = startingStop["name"]["zh"];

                    let endingStopId = stops[endingStopIndex];
                    let endingStop = dataSheet["stopList"][endingStopId];
                    let endingName = endingStop["name"]["zh"];

                    let note = "-";
                    let twoWaySectionFare = checkTwoWaySectionFare(routeNumber, stopNames, startingName, endingName);
                    let fare = 0;
                    if (twoWaySectionFare == null) {
                        fare = Number(route["fares"][startingStopIndex]);
                    } else {
                        fare = twoWaySectionFare[2];
                        if (language == "en") {
                            note = "Octopus Two-way Section Fare - " + displayStopNames[twoWaySectionFare[0]] + " to " + displayStopNames[twoWaySectionFare[1]];
                        } else {
                            note = "ÂÖ´ÈÅîÈÄöÈõôÂêëÂàÜÊÆµÊî∂Ë≤ª - " + displayStopNames[twoWaySectionFare[0]] + " Ëá≥ " + displayStopNames[twoWaySectionFare[1]];
                        }
                    }

                    rowsData.push([routeNumber, startingName, endingName, null, null, null, note, fare, route, stopNames, stopDetails, stops, startingStopIndex, endingStopIndex, displayStopNames]);

                    lastFare = fare;
                    lastRouteNumber = routeNumber;
                    consecutiveInterchanges = 1;
                    lastBound = route["bound"]["kmb"];
                    lastStopDetails = stopDetails.slice(startingStopIndex + 1, endingStopIndex + 1);
                } else {
                    let endingStopId = stops[endingStopIndex];
                    let endingStop = dataSheet["stopList"][endingStopId];
                    let endingName = endingStop["name"]["zh"];

                    let interchangeStopResult = findInterchangeStop(lastStopDetails, stopDetails.slice(startingStopIndex, endingStopIndex + 1));

                    let interchangeStopId1 = interchangeStopResult[0];
                    let interchangeStop1 = dataSheet["stopList"][interchangeStopId1];
                    let interchangeName1 = interchangeStop1["name"]["zh"];

                    let interchangeStopId2 = interchangeStopResult[1];
                    let interchangeStop2 = dataSheet["stopList"][interchangeStopId2];
                    let interchangeName2 = interchangeStop2["name"]["zh"];

                    let note = "-";
                    let twoWaySectionFare = checkTwoWaySectionFare(routeNumber, stopNames, interchangeName2, endingName);
                    let fare = 0;
                    if (twoWaySectionFare == null) {
                        fare = Number(route["fares"][startingStopIndex]);
                    } else {
                        fare = twoWaySectionFare[2];
                        if (language == "en") {
                            note = "Octopus Two-way Section Fare - " + displayStopNames[twoWaySectionFare[0]] + " to " + displayStopNames[twoWaySectionFare[1]];
                        } else {
                            note = "ÂÖ´ÈÅîÈÄöÈõôÂêëÂàÜÊÆµÊî∂Ë≤ª - " + displayStopNames[twoWaySectionFare[0]] + " Ëá≥ " + displayStopNames[twoWaySectionFare[1]];
                        }
                    }

                    let bbiDataSheet = lastBound == "O" ? bbiF1 : bbiB1;
                    if (bbiDataSheet[lastRouteNumber] != undefined) {
                        let bbiData = bbiDataSheet[lastRouteNumber];
                        if (bbiData.length > 0) {
                            if (bbiData[0]["bbi_direction"] != rowsData[i - 1][8]["dest"]["zh"] && rowsData[i - 1][8]["dest"]["zh"].indexOf("Âæ™Áí∞Á∑ö") < 0) {
                                bbiDataSheet = lastBound == "O" ? bbiB1 : bbiF1;
                            }
                        }
                    }
                    let hasBbi = false;
                    if (bbiDataSheet[lastRouteNumber] != undefined) {
                        let bbiData = bbiDataSheet[lastRouteNumber];
                        for (let k = 0; k < bbiData.length; k++) {
                            let bbiRoute = bbiData[k];
                            let routeDest = null;
                            let type = route["stops"]["kmb"];
                            let bound = route["bound"]["kmb"];
                            if (type == 1) {
                                routeDest = route["dest"]["zh"];
                            } else {
                                for (let key in dataSheet["routeList"]) {
                                    let data = dataSheet["routeList"][key];
                                    if (data["route"] == routeNumber && data["bound"].hasOwnProperty("kmb") && data["bound"]["kmb"] == bound && data["serviceType"] == 1) {
                                        routeDest = data["dest"]["zh"];
                                        break;
                                    }
                                }
                            }
                            if (bbiRoute["bbi_route_number"] == routeNumber && (bbiRoute["destination"] == routeDest.replace("(Âæ™Áí∞Á∑ö)", "") || routeDest.indexOf("Âæ™Áí∞Á∑ö") >= 0)) {
                                let maxChanges = bbiRoute["max_change"];
                                if (maxChanges >= consecutiveInterchanges++) {
                                    hasBbi = true;
                                    let timeLimit = bbiRoute["time_limit"];
                                    let recommendedBbi = bbiRoute["recommended_bbi"];

                                    if (recommendedBbi != "‰ªª‰ΩïËÉΩÊé•ÈßÅÁ¨¨‰∫åÁ®ãË∑ØÁ∑öÁöÑÂ∑¥Â£´Á´ô") {
                                        let recommendedBbiIndex = stopNamesIndexOf(recommendedBbi, stopNames);
                                        if (recommendedBbiIndex >= startingStopIndex && recommendedBbiIndex <= endingStopIndex) {
                                            let interchangeStopClosestResult = findCloestStop(stopDetails[recommendedBbiIndex], rowsData[i - 1][10]);
                                            let interchangeStopIndex = rowsData[i - 1][11].indexOf(interchangeStopClosestResult[0]);
                                            if (interchangeStopIndex >= rowsData[i - 1][12] && interchangeStopIndex <= rowsData[i - 1][13]) {
                                                interchangeName2 = bbiRoute["recommended_bbi"];
                                                interchangeStopId2 = stops[recommendedBbiIndex];
                                                startingStopIndex = recommendedBbiIndex;
                                                interchangeStop1 = dataSheet["stopList"][interchangeStopClosestResult[0]];
                                                interchangeName1 = interchangeStop1["name"]["zh"];
                                            }
                                        }
                                    }

                                    if (rowsData[i - 1][2] != interchangeName1) {
                                        rowsData[i - 1][2] = interchangeName1;
                                        let newEndingStopIndex = rowsData[i - 1][9].indexOf(interchangeName1);
                                        rowsData[i - 1][13] = newEndingStopIndex;
                                        let twoWaySectionFare0 = checkTwoWaySectionFare(rowsData[i - 1][0], rowsData[i - 1][9], rowsData[i - 1][1], interchangeName1);
                                        let fare0 = 0;
                                        let note0 = "-";
                                        if (twoWaySectionFare0 == null) {
                                            fare0 = Number(rowsData[i - 1][8]["fares"][rowsData[i - 1][12]]);
                                        } else {
                                            fare0 = twoWaySectionFare0[2];
                                            if (language == "en") {
                                                note = "Octopus Two-way Section Fare - " + rowsData[i - 1][14][twoWaySectionFare[0]] + " to " + rowsData[i - 1][14][twoWaySectionFare[1]];
                                            } else {
                                                note0 = "ÂÖ´ÈÅîÈÄöÈõôÂêëÂàÜÊÆµÊî∂Ë≤ª - " + rowsData[i - 1][14][twoWaySectionFare0[0]] + " Ëá≥ " + rowsData[i - 1][14][twoWaySectionFare0[1]];
                                            }
                                        }
                                        lastFare = fare0;
                                        lastStopDetails = stopDetails.slice(rowsData[i - 1][10] + 1, newEndingStopIndex + 1);

                                        rowsData[i - 1][6] = note0;
                                        rowsData[i - 1][7] = fare0;
                                    }

                                    let discountType = bbiRoute["discount_type"];
                                    let discount = bbiRoute["discount"];
                                    if (discountType == "free") {
                                        fare = 0;
                                    } else if (discountType == "discount") {
                                        fare -= discount;
                                    } else if (discountType == "combined_fare") {
                                        fare = discount - lastFare;
                                    } else if (discountType == "fixed_fare") {
                                        fare = discount;
                                    } else if (discountType == "return") {
                                        fare = -discount;
                                    }
                                    fare = roundTo1Decimal(fare);

                                    let discount_message = bbiRoute["discount_raw"];
                                    if (language == "en") {
                                        discount_message = discount_message
                                                .replace("Ê∏õ", "Discount")
                                                .replace("ÂÖ©Á®ãÂêàÂÖ±", "Combined Fare")
                                                .replace("ÂÖçË≤ª", "Free")
                                                .replace("‰ªò", "Pay")
                                                .replace("ÂõûË¥à", "Rebate");

                                    }

                                    startingStopIndex = stops.indexOf(interchangeStopId2);

                                    rowsData.push([routeNumber, interchangeName2, endingName, discount_message, maxChanges, timeLimit, note, fare, route, stopNames, stopDetails, stops, startingStopIndex, endingStopIndex, displayStopNames]);
                                }
                                break;
                            }
                        }
                    }

                    if (!hasBbi) {
                        if (rowsData[i - 1][2] != interchangeName1) {
                            rowsData[i - 1][2] = interchangeName1;

                            let newEndingStopIndex = rowsData[i - 1][9].indexOf(interchangeName1);
                            rowsData[i - 1][13] = newEndingStopIndex;
                            let twoWaySectionFare0 = checkTwoWaySectionFare(rowsData[i - 1][0], rowsData[i - 1][9], rowsData[i - 1][1], interchangeName1);
                            let fare0 = 0;
                            let note0 = "-";
                            if (twoWaySectionFare0 == null) {
                                fare0 = Number(rowsData[i - 1][8]["fares"][rowsData[i - 1][12]]);
                            } else {
                                fare0 = twoWaySectionFare0[2];
                                if (language == "en") {
                                    note = "Octopus Two-way Section Fare - " + rowsData[i - 1][14][twoWaySectionFare[0]] + " to " + rowsData[i - 1][14][twoWaySectionFare[1]];
                                } else {
                                    note0 = "ÂÖ´ÈÅîÈÄöÈõôÂêëÂàÜÊÆµÊî∂Ë≤ª - " + rowsData[i - 1][14][twoWaySectionFare0[0]] + " Ëá≥ " + rowsData[i - 1][14][twoWaySectionFare0[1]];
                                }
                            }
                            lastFare = fare0;
                            lastStopDetails = stopDetails.slice(rowsData[i - 1][10] + 1, newEndingStopIndex + 1);

                            rowsData[i - 1][6] = note0;
                            rowsData[i - 1][7] = fare0;
                        }

                        startingStopIndex = stops.indexOf(interchangeStopId2);

                        rowsData.push([routeNumber, interchangeName2, endingName, null, null, null, note, fare, route, stopNames, stopDetails, stops, startingStopIndex, endingStopIndex, displayStopNames]);
                        consecutiveInterchanges = 1;
                    }
                    lastRouteNumber = routeNumber;
                    lastFare = fare;
                    lastBound = route["bound"]["kmb"];
                    lastStopDetails = stopDetails.slice(startingStopIndex + 1, endingStopIndex + 1);
                }
                shareParameters.push("r" + leg + "=" + routeNumber + "," + route["bound"]["kmb"] + "," + route["serviceType"] + "," + stops[startingStopIndex] + "," + stops[endingStopIndex]);
            }

            currentShareParameters = "?" + shareParameters.join("&");

            markers.clearLayers();
            lines.clearLayers();
            document.getElementById('special-announcements').innerHTML = "";
            document.getElementById('special-announcements').style.display = "none";

            document.getElementById('time-table').innerHTML = "";
            document.getElementById('time-table').style.display = "none";

            document.getElementById('eta-table').innerHTML = "";
            document.getElementById('eta-table').style.display = "none";

            document.getElementById('fare-table-mobile').innerHTML = "";
            document.getElementById('fare-table').style.display = "none";

            deleteRows(document.getElementById('fare-table'), 1);

            let stopMarkerData = {};

            let totalFare = 0;
            for (let i = 0; i < rowsData.length; i++) {
                let entry = rowsData[i];

                addRows(document.getElementById('fare-table'), 
                    entry[0], 
                    entry[14][entry[12]], 
                    entry[14][entry[13]], 
                    entry[3] == null ? "-" : entry[3], 
                    entry[4] == null ? "-" : entry[4], 
                    entry[5] == null ? "-" : entry[5] + (language == "en" ? " Min." : "ÂàÜÈêò"), 
                    entry[6], 
                    "$" + entry[7].toFixed(1));

                let mobileText = 
                "<table class=\"table\">" +
                    "<tbody>" +
                        "<tr>" +
                            "<th>" + (language == "en" ? "Route" : "Ë∑ØÁ∑ö") + "</th>" +
                            "<th style=\"text-align: right; font-weight: normal;\">" + entry[0] + "</th>" +
                        "</tr>" +
                        "<tr>" +
                            "<th>" + (language == "en" ? "Suggested Boarding Stop" : "Âª∫Ë≠∞‰∏äËªäÂ∑¥Â£´Á´ô") + "</th>" +
                            "<th style=\"text-align: right; font-weight: normal;\">" + entry[14][entry[12]] + "</th>" +
                        "</tr>" +
                        "<tr>" +
                            "<th>" + (language == "en" ? "Suggested Alighting Stop" : "Âª∫Ë≠∞ËêΩËªäÂ∑¥Â£´Á´ô") + "</th>" +
                            "<th style=\"text-align: right; font-weight: normal;\">" + entry[14][entry[13]] + "</th>" +
                        "</tr>" +
                        "<tr>" +
                            "<th>" + (language == "en" ? "Discount" : "ÂÑ™ÊÉ†") + "</th>" +
                            "<th style=\"text-align: right; font-weight: normal;\">" + (entry[3] == null ? "-" : entry[3]) + "</th>" +
                        "</tr>" +
                        "<tr>" +
                            "<th>" + (language == "en" ? "Max. Successive Discount" : "ÊúÄÈ´òÈÄ£Á∫åËΩâ‰πò") + "</th>" +
                            "<th style=\"text-align: right; font-weight: normal;\">" + (entry[4] == null ? "-" : entry[4]) + "</th>" +
                        "</tr>" +
                        "<tr>" +
                            "<th>" + (language == "en" ? "Time Limit" : "ÊôÇÈôê") + "</th>" +
                            "<th style=\"text-align: right; font-weight: normal;\">" + (entry[5] == null ? "-" : entry[5] + (language == "en" ? " Min." : "ÂàÜÈêò")) + "</th>" +
                        "</tr>" +
                        "<tr>" +
                            "<th>" + (language == "en" ? "Remarks" : "ÂÇôË®ª") + "</th>" +
                            "<th style=\"text-align: right; font-weight: normal;\">" + entry[6] + "</th>" +
                        "</tr>" +
                        "<tr>" +
                            "<th>" + (language == "en" ? "Fare" : "ËªäË≤ª") + "</th>" +
                            "<th style=\"text-align: right; font-weight: normal;\">" + "$" + entry[7].toFixed(1) + "</th>" +
                        "</tr>" +
                    "</tbody>" +
                "</table>";
                document.getElementById('fare-table-mobile').innerHTML += mobileText;

                totalFare += entry[7];

                let route = entry[8];

                let resolvedSpecialUrl = kmbSpecialAnnouncementsUrl.replace("{route}", route["route"]).replace("{bound}", route["bound"]["kmb"] == "O" ? 1 : 2);
                let task0Id = makeId(10);
                calculateTasks.push(task0Id);
                getJSON(resolvedSpecialUrl, (err, data) => {
                    if (err == null) {
                        let entries = data["data"];
                        let messages = [];
                        for (let i = 0; i < entries.length; i++) {
                            let entry = entries[i];
                            let title = entry[language == "en" ? "kpi_title" : "kpi_title_chi"];
                            let resolvedAnnouncementPictureUrl = kmbAnnouncementPictureUrl + entry["kpi_noticeimageurl"];
                            messages.push("<a href=\"" + resolvedAnnouncementPictureUrl + "\" target=\"_blank\">" + title + "</a>");
                        }
                        if (messages.length > 0) {
                            let html;
                            if (language == "en") {
                                html = "[Route " + route["route"] + " Announcements]<br> " + messages.join("<br>");
                            } else {
                                html = "[Ë∑ØÁ∑ö" + route["route"] + "ÁâπÂà•ÂÖ¨Âëä]<br> " + messages.join("<br>");
                            }
                            if (document.getElementById('special-announcements').innerHTML == "") {
                                document.getElementById('special-announcements').style.display = "";
                                document.getElementById('special-announcements').innerHTML = html;
                            } else {
                                document.getElementById('special-announcements').innerHTML += "<br><br>" + html
                            }
                        }
                    } else {
                        alert("Unable to get response from " + resolvedSpecialUrl + ". (Is it down?)");
                    }
                    calculateTasks.splice(calculateTasks.indexOf(task0Id), 1);
                });

                let boundNumber = route["bound"]["kmb"] == "O" ? 1 : 2;
                let resolvedTimeTableUrl = kmbTimeTableUrl.replace("{route}", route["route"]).replace("{bound}", boundNumber);
                let task1Id = makeId(10);
                calculateTasks.push(task1Id);
                getJSON(resolvedTimeTableUrl, (err, data) => {
                    if (err == null) {
                        let timeTableData = data["data"];
                        let times = {};
                        for (let key in timeTableData) {
                            let serviceType = Number(key.trim());
                            let list = timeTableData[key];
                            if (serviceType == route["serviceType"]) {
                                for (let u = 0; u < list.length; u++) {
                                    let entry = list[u];
                                    let dayType = entry["DayType"].trim();

                                    let time = entry["BoundText" + boundNumber].trim();
                                    let frequency = entry["BoundTime" + boundNumber].trim();
                                    if (time == "") {
                                        continue;
                                    }

                                    let dayTypeName;
                                    let daysOfWeek;
                                    if (dayType == "MF") {
                                        dayTypeName = language == "en" ? "Monday to Friday" : "ÊòüÊúü‰∏ÄËá≥‰∫î";
                                        daysOfWeek = [1, 2, 3, 4, 5];
                                    } else if (dayType == "MS") {
                                        dayTypeName = language == "en" ? "Monday to Saturday" : "ÊòüÊúü‰∏ÄËá≥ÂÖ≠";
                                        daysOfWeek = [1, 2, 3, 4, 5, 6];
                                    } else if (dayType == "S") {
                                        dayTypeName = language == "en" ? "Saturday" : "ÊòüÊúüÂÖ≠";
                                        daysOfWeek = [6];
                                    } else if (dayType == "H") {
                                        dayTypeName = language == "en" ? "Sunday & Public Holidays" : "ÊòüÊúüÊó•ÂèäÂÖ¨ÁúæÂÅáÊúü";
                                        daysOfWeek = [7]; 
                                    } else if (dayType == "D") {
                                        dayTypeName = language == "en" ? "Daily" : "ÊØèÂ§©";
                                        if (time == "ÊñºÊåáÂÆöÊó•ÊúüÊúçÂãô" || time == "On specific day only") {
                                            daysOfWeek = [];
                                        } else {
                                            daysOfWeek = [1, 2, 3, 4, 5, 6, 7];
                                        }
                                    }

                                    if (!times.hasOwnProperty(dayTypeName)) {
                                        times[dayTypeName] = [];
                                    }
                                    times[dayTypeName].push([time, frequency, daysOfWeek]);
                                }
                            }
                        }

                        let tables = [];
                        for (let dayTypeName in times) {
                            let entries = times[dayTypeName];
                            let rows = [];
                            for (let u = 0; u < entries.length; u++) {
                                let entry = entries[u];
                                let daysOfWeek = entry[2];
                                if (daysOfWeek.length == 0) {
                                    rows.push(
                                        "<tr>" +
                                            "<th style=\"font-weight: normal;\">" + entry[0] + "</th>" +
                                            "<th style=\"font-weight: normal; text-align: right;\">-</th>" +
                                        "</tr>"
                                    );
                                } else {
                                    rows.push(
                                        "<tr>" +
                                            "<th style=\"font-weight: normal;\">" + entry[0] + "</th>" +
                                            "<th style=\"font-weight: normal; text-align: right;\">" + entry[1] + "</th>" +
                                        "</tr>"
                                    );
                                }
                            }
                            let table = 
                                "<table class=\"table\" style=\"word-break: keep-all;\">" +
                                    "<tbody>" +
                                        "<tr>" +
                                            "<th>" + dayTypeName + "</th>" +
                                            "<th style=\"text-align: right;\">" + (language == "en" ? "Frequency (Min.)" : "Áè≠Ê¨°(ÂàÜÈêò)") + "</th>" +
                                        "</tr>" + 
                                        rows.join("") +
                                    "</tbody>" +
                                "</table>";

                            tables.push(table);
                        }

                        if (tables.length == 0) {
                            tables.push(language == "en" ? "On specific day only" : "ÊñºÊåáÂÆöÊó•ÊúüÊúçÂãô");
                        }

                        let tableTableTitle = language == "en" ? ("Route " + route["route"] + " Timetable") : ("Ë∑ØÁ∑ö" + route["route"] + "ÊôÇÈñìË°®");
                        let append = 
                            "<h5 class=\"title is-5 has-text-black\" style=\"min-width: 100px; width: 100%;\">" + tableTableTitle + "</h5>" + 
                            "<div class=\"columns\">" +
                                "<div class=\"column\">" +
                                    tables.join("</div><div class=\"column\">") +
                                "</div>" +
                            "</div>";

                        if (document.getElementById('time-table').innerHTML == "") {
                            document.getElementById('time-table').style.display = "";
                        }
                        document.getElementById("time-table").innerHTML += append;
                    } else {
                        alert("Unable to get response from " + resolvedTimeTableUrl + ". (Is it down?)");
                    }
                    calculateTasks.splice(calculateTasks.indexOf(task1Id), 1);
                });

                let stopNames = entry[9];
                let stopDetails = entry[10];
                for (let u = 0; u < stopNames.length; u++) {
                    let stopName = stopNames[u];
                    let stopPosition = stopDetails[u][1]["location"];
                    let desc = (u + 1) + ". " + entry[14][u];
                    let positionArray = [stopPosition["lat"], stopPosition["lng"]];
                    let stopMarker;
                    if (u < entry[12] || u > entry[13]) {
                        stopMarker = [[route["route"]], 4, desc, positionArray, i, u];
                    } else if (u == entry[12]) {
                        stopMarker = [[route["route"]], 0, desc, positionArray, i, u];
                    } else if (u == entry[13]) {
                        stopMarker = [[route["route"]], i + 1 == rowsData.length ? 1 : 2, desc, positionArray, i, u];
                    } else {
                        stopMarker = [[route["route"]], 3, desc, positionArray, i, u];
                    }
                    if (stopMarkerData.hasOwnProperty(stopDetails[u][0])) {
                        stopMarkerData[stopDetails[u][0]][0].push(stopMarker[0][0]);
                        stopMarkerData[stopDetails[u][0]][2] = stopMarker[2];
                    } else {
                        stopMarkerData[stopDetails[u][0]] = stopMarker;
                    }
                }

                let task2Id = makeId(10);
                calculateTasks.push(task2Id);
                getJSON("./route_paths/" + route["route"] + ".json", (err, data) => {
                    try {
                        if (err == null) {                
                            let sections = data[route["bound"]["kmb"]][route["serviceType"]];
                            if (sections == undefined) {
                                return;
                            }
                            for (let i = 0; i < sections.length; i++) {
                                let path = sections[i];
                                let pointListBefore = [];
                                let pointListRoute = [];
                                let pointListAfter = [];
                                for (let u = 0; u < path.length; u++) {
                                    let position = path[u];
                                    if (i < entry[12]) {
                                        pointListBefore.push(new L.LatLng(position[0], position[1]));
                                    } else if (i > entry[13] - 1) {
                                        pointListAfter.push(new L.LatLng(position[0], position[1]));
                                    } else {
                                        pointListRoute.push(new L.LatLng(position[0], position[1]));
                                    }
                                }
                                let desc;
                                if (language == "en") {
                                    desc = "<b style=\"font-size: 17px\">" + route["route"] + " <span style=\"font-size: 12px\">To</span><span style=\"font-size: 15px\">" + capitalize(route["dest"]["en"]) + "</span></b>";
                                } else {
                                    desc = "<b style=\"font-size: 17px\">" + route["route"] + " <span style=\"font-size: 12px\">ÂæÄ</span><span style=\"font-size: 15px\">" + route["dest"]["zh"] + "</span></b>";
                                }
                                if (pointListBefore.length > 0) {
                                    new L.Polyline(pointListBefore, {
                                        color: '#141414',
                                        weight: 3,
                                        opacity: 0.5,
                                        smoothFactor: 1
                                    }).addTo(lines).bindPopup(desc);
                                }
                                new L.Polyline(pointListRoute, {
                                    color: 'red',
                                    weight: 4,
                                    opacity: 1,
                                    smoothFactor: 1
                                }).addTo(lines).bindPopup(desc);
                                if (pointListAfter.length > 0) {
                                    new L.Polyline(pointListAfter, {
                                        color: '#141414',
                                        weight: 3,
                                        opacity: 0.5,
                                        smoothFactor: 1
                                    }).addTo(lines).bindPopup(desc);
                                }
                            }
                        } else {
                            alert("Unable to get response from ./route_paths/" + route["route"] + ".json. (Is it down?)");
                        }
                    } finally {
                        calculateTasks.splice(calculateTasks.indexOf(task2Id), 1);
                    }
                });
            }

            let etaTables = [];
            for (let key in stopMarkerData) {
                let stopMarker = stopMarkerData[key];
                let routes = stopMarker[0];
                let stopType = stopMarker[1];
                let desc = stopMarker[2];
                if (rowsData.length > 1) {
                    desc = "[" + routes.join("/") + "] " + desc;
                }
                desc = "<p style=\"text-align: center;\">" + desc + "</p>"
                let icon;
                if (stopType == 0) {
                    desc += "<p style=\"text-align: center; font-size: 20px;\">" + (language == "en" ? "Please board at this stop" : "Ë´ãÂú®Ê≠§Á´ô‰∏äËªä") + "</p>"
                    icon = redIcon;
                    let table = 
                        "<h5 class=\"title is-5 has-text-black\" style=\"min-width: 100px; width: 100%;\">" + (language == "en" ? "Route " : "Ë∑ØÁ∑ö") + routes[0] + (language == "en" ? " ETA" : "È†êË®àÂà∞ÈÅîÊôÇÈñì") + "</h5>" + 
                        "<table class=\"table\" style=\"word-break: keep-all;\">" +
                            "<tbody>" +
                                "<tr>" +
                                    "<th style=\"text-align: center;\"><b style=\"font-size: " + (language == "en" ? "20" : "25") + "px;\">" + rowsData[stopMarker[4]][14][rowsData[stopMarker[4]][12]] + "</b></th>" +
                                "</tr>" + 
                                "<tr>" +
                                    "<th style=\"font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"eta_" + rowsData[stopMarker[4]][11][rowsData[stopMarker[4]][12]] + "," + routes[0] + "," + rowsData[stopMarker[4]][8]["bound"]["kmb"] + ",1,25,false\"></th>" +
                                "</tr>" + 
                                "<tr>" +
                                    "<th style=\"font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"eta_" + rowsData[stopMarker[4]][11][rowsData[stopMarker[4]][12]] + "," + routes[0] + "," + rowsData[stopMarker[4]][8]["bound"]["kmb"] + ",2,25,false\"></th>" +
                                "</tr>" + 
                                "<tr>" +
                                    "<th style=\"font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"eta_" + rowsData[stopMarker[4]][11][rowsData[stopMarker[4]][12]] + "," + routes[0] + "," + rowsData[stopMarker[4]][8]["bound"]["kmb"] + ",3,25,false\"></th>" +
                                "</tr>" + 
                            "</tbody>" +
                        "</table>";

                    etaTables.push(table);
                } else if (stopType == 1) {
                    desc += "<p style=\"text-align: center; font-size: 20px;\">" + (language == "en" ? "Please alight at this stop" : "Ë´ãÂú®Ê≠§Á´ôËêΩËªä") + "</p>"
                    icon = redIcon;
                } else if (stopType == 2) {
                    if (routes.length == 1) {
                        let nextEntry = rowsData[stopMarker[4] + 1];
                        let changeTo = nextEntry[0];
                        desc += "<p style=\"text-align: center; font-size: 20px;\">" + (language == "en" ? "Please interchange at this stop " : "Ë´ãÂú®Ê≠§Á´ôËΩâËªä ") + routes[0] + " ü°í " + changeTo + "</p><p style=\"text-align: center; font-size: 15px;\">(" + (language == "en" ? "Walk to " : "Ê≠•Ë°åËá≥ ") + nextEntry[14][nextEntry[12]] + ")";
                    } else {
                        let changeTo = routes[1];
                        desc += "<p style=\"text-align: center; font-size: 20px;\">" + (language == "en" ? "Please interchange at this stop " : "Ë´ãÂú®Ê≠§Á´ôËΩâËªä ") + routes[0] + " ü°í " + changeTo;

                        let table = 
                            "<h5 class=\"title is-5 has-text-black\" style=\"min-width: 100px; width: 100%;\">" + (language == "en" ? "Route " : "Ë∑ØÁ∑ö") + routes[0] + (language == "en" ? " ETA" : "È†êË®àÂà∞ÈÅîÊôÇÈñì") + "</h5>" + 
                            "<table class=\"table\" style=\"word-break: keep-all;\">" +
                                "<tbody>" +
                                    "<tr>" +
                                        "<th style=\"text-align: center;\"><b style=\"font-size: " + (language == "en" ? "20" : "25") + "px;\">" + rowsData[stopMarker[4]][14][rowsData[stopMarker[4]][12]] + "</b></th>" +
                                    "</tr>" + 
                                    "<tr>" +
                                        "<th style=\"font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"eta_" + rowsData[stopMarker[4]][11][rowsData[stopMarker[4]][12]] + "," + routes[0] + "," + rowsData[stopMarker[4]][8]["bound"]["kmb"] + ",1,25,false\"></th>" +
                                    "</tr>" + 
                                    "<tr>" +
                                        "<th style=\"font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"eta_" + rowsData[stopMarker[4]][11][rowsData[stopMarker[4]][12]] + "," + routes[0] + "," + rowsData[stopMarker[4]][8]["bound"]["kmb"] + ",2,25,false\"></th>" +
                                    "</tr>" + 
                                    "<tr>" +
                                        "<th style=\"font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"eta_" + rowsData[stopMarker[4]][11][rowsData[stopMarker[4]][12]] + "," + routes[0] + "," + rowsData[stopMarker[4]][8]["bound"]["kmb"] + ",3,25,false\"></th>" +
                                    "</tr>" + 
                                "</tbody>" +
                            "</table>";

                        etaTables.push(table);
                    }
                    desc += "</p>"
                    icon = redIcon;
                } else if (stopType == 3) {
                    icon = goldIcon;
                } else {
                    icon = greyIcon;
                }

                desc = "<b style=\"font-size: 15px\">" + desc + "</b>";
                if (stopType == 2 && routes.length > 1) {
                    let nextEntry = rowsData[stopMarker[4] + 1];
                    desc += 
                          "<b style=\"font-size: 15px\">" + (language == "en" ? "Route " : "Ë∑ØÁ∑ö") + routes[0] + "</b><br>"
                        + "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[0] + "," + rowsData[stopMarker[4]][8]["bound"]["kmb"] + ",1,15,false\"></span><br>"
                        + "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[0] + "," + rowsData[stopMarker[4]][8]["bound"]["kmb"] + ",2,15,false\"></span><br>"
                        + "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[0] + "," + rowsData[stopMarker[4]][8]["bound"]["kmb"] + ",3,15,false\"></span><br><br>"

                        + "<b style=\"font-size: 15px\">" + (language == "en" ? "Route " : "Ë∑ØÁ∑ö") + routes[1] + "</b><br>"
                        + "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[1] + "," + nextEntry[8]["bound"]["kmb"] + ",1,15,false\"></span><br>"
                        + "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[1] + "," + nextEntry[8]["bound"]["kmb"] + ",2,15,false\"></span><br>"
                        + "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[1] + "," + nextEntry[8]["bound"]["kmb"] + ",3,15,false\"></span><br>"
                } else {
                    desc += 
                          "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[0] + "," + rowsData[stopMarker[4]][8]["bound"]["kmb"] + ",1,15,false\"></span><br>"
                        + "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[0] + "," + rowsData[stopMarker[4]][8]["bound"]["kmb"] + ",2,15,false\"></span><br>"
                        + "<span style=\"word-break: keep-all; font-weight: normal; text-align: center;\" class=\"eta-update\" id=\"map_" + rowsData[stopMarker[4]][11][stopMarker[5]] + "," + routes[0] + "," + rowsData[stopMarker[4]][8]["bound"]["kmb"] + ",3,15,false\"></span><br>";
                }

                L.marker(stopMarker[3], {icon: icon}).addTo(markers).bindPopup(desc).on('click', (e) => {
                    map.flyTo([e.latlng.lat + 0.0012, e.latlng.lng], 17, {"duration": 1});
                }).on('popupopen', (e) => {
                    updateEta();
                });
            }

            let append = 
                "<div class=\"columns\">" +
                    "<div class=\"column\">" +
                        etaTables.join("</div><div class=\"column\">") +
                    "</div>" +
                "</div>";

            document.getElementById("eta-table").innerHTML += append;

            map.flyToBounds(markers.getBounds(), {"duration": 1});

            document.getElementById('total-fare').innerHTML = "$" + totalFare.toFixed(1) + " (" + (language == "en" ? "Half Fare" : "ÂçäÂÉπ") + " $" + roundTo1Decimal(totalFare / 2).toFixed(1) + ")";

            updateEta();

            document.getElementById('eta-table').style.display = "";
            document.getElementById('fare-table').style.display = "";
        } finally {
            calculateTasks.splice(calculateTasks.indexOf(taskId), 1);
            let shareLink = getShareLink();
            window.history.replaceState(null, null, shareLink);
            document.getElementById('language').href = getShareLink(true);
        }
    };

    let routeInputHtml = 
        "<div class=\"box has-background-grey-lighter route-input-element\" id=\"route-%s-element\">" + 
            "<div class=\"columns\">" + 
                "<div class=\"column\">" + 
                    "<h5 class=\"title is-5 has-text-black\" style=\"min-width: 100px; width: 100%;\">Á¨¨%cÁ®ãË∑ØÁ∑ö</h5>" + 
                    "<input list=\"bus-routes\" class=\"input\" type=\"text\" autocomplete=\"off\" id=\"route-%s\" placeholder=\"Ë´ãËº∏ÂÖ•Â∑¥Â£´Ë∑ØÁ∑ö\" onKeyUp=\"updateRoutes(); calculate();\">" + 
                    "<datalist id=\"bus-routes\">{BusRouteOptions}</datalist>" +
                "</div>" + 
                "<div class=\"column\">" + 
                    "<h5 class=\"title is-5 has-text-black\">Ë∑ØÁ∑öÈ°ûÂûã</h5>" + 
                    "<div class=\"select\">" + 
                        "<select id=\"route-%s-type\" onChange=\"updateStartingStops(); calculate();\" style=\"width: 100%;\">" + 
                            "<option id=\"route-%s-type-n\" value=\"-1\">Ë´ãÈÅ∏ÊìáË∑ØÁ∑öÈ°ûÂûã</option>" + 
                        "</select>" + 
                    "</div>" + 
                "</div>" + 
                "<div class=\"column\">" + 
                    "<h5 class=\"title is-5 has-text-black\">‰∏äËªäÂ∑¥Â£´Á´ô</h5>" + 
                    "<div class=\"select\">" + 
                        "<select id=\"route-%s-start\" onChange=\"updateDestinationStops(); calculate();\" style=\"width: 100%;\">" + 
                            "<option id=\"route-%s-start-n\" value=\"-1\">Ë´ãÈÅ∏Êìá‰∏äËªäÂ∑¥Â£´Á´ô</option>" + 
                        "</select>" + 
                    "</div>" + 
                "</div>" + 
                "<div class=\"column\">" + 
                    "<h5 class=\"title is-5 has-text-black\">ËêΩËªäÂ∑¥Â£´Á´ô</h5>" + 
                    "<div class=\"select\">" + 
                        "<select id=\"route-%s-end\" onChange=\"calculate();\" style=\"width: 100%;\">" + 
                            "<option id=\"route-%s-end-n\" value=\"-1\">Ë´ãÈÅ∏ÊìáËêΩËªäÂ∑¥Â£´Á´ô</option>" + 
                        "</select>" + 
                    "</div>" + 
                "</div>" + 
            "</div>" + 
        "</div>";
    if (language == "en") {
        routeInputHtml = routeInputHtml
                .replace("Á¨¨%cÁ®ãË∑ØÁ∑ö", "Route %s")
                .replace("Ë´ãËº∏ÂÖ•Â∑¥Â£´Ë∑ØÁ∑ö", "Please Enter Bus Route")
                .replace("Ë∑ØÁ∑öÈ°ûÂûã", "Route Variant")
                .replace("Ë´ãÈÅ∏ÊìáË∑ØÁ∑öÈ°ûÂûã", "Please Select Route Variant")
                .replace("‰∏äËªäÂ∑¥Â£´Á´ô", "Boarding Stop")
                .replace("Ë´ãÈÅ∏Êìá‰∏äËªäÂ∑¥Â£´Á´ô", "Please Select Boarding Stop")
                .replace("ËêΩËªäÂ∑¥Â£´Á´ô", "Alighting Stop")
                .replace("Ë´ãÈÅ∏ÊìáËêΩËªäÂ∑¥Â£´Á´ô", "Please Select Alighting Stop");
    }

    const routeAdd = () => {
        let div = document.getElementById('route-input');
        let collection = document.getElementsByClassName("route-input-element");
        let index = collection.length + 1;
        let append = routeInputHtml.replaceAll("%s", "" + index).replaceAll("%c", toChineseNumber(index)).replaceAll("{BusRouteOptions}", busRouteListOptions);
        if (index == 1) {
            div.innerHTML = append;
        } else {
            div.insertAdjacentHTML('beforeend', append);
        }
        calculate();
    };
    const routeRemove = () => {
        let collection = document.getElementsByClassName("route-input-element");
        if (collection.length > 1) {
            collection[collection.length - 1].remove();
            calculate();
        }
    };
    const routeClear = () => {
        window.location.href = getShareLinkWith("");
    };
    const toggleMap = () => {
        let mapElement = document.getElementById('map');
        document.getElementById('toggle-map').classList.remove("is-info");
        document.getElementById('toggle-map').classList.remove("is-dark");
        if (mapElement.style.display === "none") {
            document.getElementById('toggle-map').classList.add("is-info");
            mapElement.style.display = "";
        } else {
            document.getElementById('toggle-map').classList.add("is-dark");
            mapElement.style.display = "none";
        }
    };
    const toggleTimetable = () => {
        let timetableElement = document.getElementById('time-table');
        if (timetableElement.innerHTML != "") {
            document.getElementById('toggle-timetable').classList.remove("is-info");
            document.getElementById('toggle-timetable').classList.remove("is-dark");
            if (timetableElement.style.display === "none") {
                document.getElementById('toggle-timetable').classList.add("is-info");
                timetableElement.style.display = "";
            } else {
                document.getElementById('toggle-timetable').classList.add("is-dark");
                timetableElement.style.display = "none";
            }
        }
    };
    const toggleEta = () => {
        let etaElement = document.getElementById('eta-table');
        if (etaElement.innerHTML != "") {
            document.getElementById('toggle-eta').classList.remove("is-info");
            document.getElementById('toggle-eta').classList.remove("is-dark");
            if (etaElement.style.display === "none") {
                document.getElementById('toggle-eta').classList.add("is-info");
                etaElement.style.display = "";
            } else {
                document.getElementById('toggle-eta').classList.add("is-dark");
                etaElement.style.display = "none";
            }
        }
    };
    const toggleGps = () => {
        document.getElementById('toggle-gps').classList.remove("is-info");
        document.getElementById('toggle-gps').classList.remove("is-dark");
        if (gpsWatchID == null) {
            document.getElementById('toggle-gps').classList.add("is-info");
            getLocation();
        } else {
            document.getElementById('toggle-gps').classList.add("is-dark");
            navigator.geolocation.clearWatch(gpsWatchID);
            gpsWatchID = null;
            gpsMarker = null;
            gps.clearLayers();
            document.getElementById("nearby-routes-content").style.display = "none";
            document.getElementById("nearby-routes-prompt").style.display = "";
            document.getElementById("nearby-routes-prompt").innerHTML = language == "en" ? "Click on map to drop location pin or turn on GPS" : "ÈªûÊìäÂú∞Âúñ‰ª•ÊîæÁΩÆ‰ΩçÁΩÆÂúñÈáòÊàñÊâìÈñãÂÆö‰Ωç‰ΩçÁΩÆ";

            let shareLink = getShareLink();
            window.history.replaceState(null, null, shareLink);
            document.getElementById('language').href = getShareLink(true);
        }
    };

    const isNumber = (n) => { 
        return !isNaN(parseFloat(n)) && !isNaN(n - 0);
    };

    const loadUrlParameters = () => {
        let flag = false;

        let pinParameter = getUrlParameter("pin");
        if (pinParameter != null) {
            let parts = pinParameter.split(",");
            let lat = Number(parts[0]);
            let lng = Number(parts[1]);
            if (isNumber(lat) && isNumber(lng)) {
                let latlng = new L.LatLng(lat, lng);
                if (droppedPin == null) {
                    droppedPin = new L.marker(latlng, {draggable:'true'});
                    pin.addLayer(droppedPin);
                    droppedPin.on('dragend', (event) => {
                        droppedPin = event.target;
                        let position = droppedPin.getLatLng();
                        droppedPin.setLatLng(new L.LatLng(position.lat, position.lng), {draggable:'true'});
                        map.panTo(new L.LatLng(position.lat, position.lng), {"duration": 1});
                        updateNearestRoutes(position.lat, position.lng);

                        let shareLink = getShareLink();
                        window.history.replaceState(null, null, shareLink);
                        document.getElementById('language').href = getShareLink(true);
                    });
                } else {
                    droppedPin.setLatLng(latlng, {draggable:'true'});
                    let position = droppedPin.getLatLng();
                    map.panTo(new L.LatLng(position.lat, position.lng), {"duration": 1});
                }
                updateNearestRoutes(lat, lng);
            }
        } else {
            let gpsParameter = getUrlParameter("gps");
            if (gpsParameter == "true") {
                toggleGps();
            }
        }

        let parameters = [null];
        for (let i = 1; true; i++) {
            let parameter = getUrlParameter("r" + i);
            if (parameter == null) {
                break;
            }
            parameters.push(parameter);
        }

        for (let i = 1; i < parameters.length; i++) {
            let parameter = parameters[i];
            let parts = parameter.split(",");
            let routeNumber = parts[0];
            let bound = parts[1];
            let type = parts[2];
            let startingStop = parts[3];
            let endingStop = parts[4];

            if (busRouteList.indexOf(routeNumber) < 0) {
                break;
            }

            let routeKey = null;
            let route = null;
            for (let key in dataSheet["routeList"]) {
                let data = dataSheet["routeList"][key];
                if (data["bound"].hasOwnProperty("kmb") && kmbRouteExists(data) && data["route"] == routeNumber && data["bound"]["kmb"] == bound && data["serviceType"] == type) {
                    routeKey = key + "_" + type;
                    route = data;
                    break;
                }
            }
            if (route == null) {
                break;
            }

            let startingStopIndex = route["stops"]["kmb"].indexOf(startingStop);
            let endingStopIndex = route["stops"]["kmb"].lastIndexOf(endingStop);

            if (startingStopIndex < 0 || endingStopIndex < 0 || startingStopIndex >= endingStopIndex) {
                break;
            }

            routeAdd();

            document.getElementById("route-" + i).value = routeNumber;
            updateRoutes();
            document.getElementById("route-" + i + "-type").value = routeKey;
            updateStartingStops();
            document.getElementById("route-" + i + "-start").value = startingStopIndex;
            updateDestinationStops();
            document.getElementById("route-" + i + "-end").value = endingStopIndex;

            flag = true;
        }
        if (flag) {
            calculate();
        }
        return flag;
    };
    const getCurrentLinkWithoutParameters = () => {
        return location.protocol + '//' + location.host + location.pathname;
    }
    const getShareLinkWith = (shareParameters, languageFlipped = false) => {
        let link = getCurrentLinkWithoutParameters() + shareParameters;
        if (droppedPin != null) {
            let pin = "pin=" + droppedPin.getLatLng().lat + "," + droppedPin.getLatLng().lng;
            link += (shareParameters.startsWith("?") ? "&" : "?") + pin + "&";
        } else if (gpsMarker != null) {
            link += (shareParameters.startsWith("?") ? "&" : "?") + "gps=true" + "&";
        } else {
            link += shareParameters.startsWith("?") ? "&" : "?";
        }
        if (languageFlipped) {
            link += "language=" + (language == "en" ? "zh" : "en");
        } else {
            link += "language=" + language;
        }
        return link;
    };
    const getShareLink = (languageFlipped = false) => {
        return getShareLinkWith(currentShareParameters, languageFlipped);
    };
    const copyShareLink = () => {
        let link = getShareLink();
        navigator.clipboard.writeText(link);
        prompt(language == "en" ? "Copied share link to clipboard!" : "ÂàÜ‰∫´ÈèàÊé•Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÊùø", link);
    };

    document.getElementById('route-add').addEventListener("click", routeAdd, false);
    document.getElementById('route-remove').addEventListener("click", routeRemove, false);
    document.getElementById('route-clear').addEventListener("click", routeClear, false);

    document.getElementById('toggle-timetable').addEventListener("click", toggleTimetable, false);
    document.getElementById('toggle-eta').addEventListener("click", toggleEta, false);
    document.getElementById('toggle-map').addEventListener("click", toggleMap, false);
    document.getElementById('toggle-gps').addEventListener("click", toggleGps, false);
    document.getElementById('share-link').addEventListener("click", copyShareLink, false);
</script>

</html>
